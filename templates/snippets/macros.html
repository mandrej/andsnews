{% macro form_row(field) %}
    <p>
        {{ field.label(class='required' if field.flags.required else '') }}
        {{ field(**kwargs) }}
        {% if field.errors %}
            <span class="error C_{{ field.name }}">{{ field.errors|join(', ') }}</span>
        {% endif %}
    </p>
{% endmacro %}

{% macro _build(filters, kind) %}
    <div class="submenu">
        {% for f in filters %}
            <a class="{{ f.field }} block collapse" href="/filter/{{ kind }}_{{ f.field }}">{{ f.title }} [+]</a>
            <div id="{{ f.field }}cloud" class="hide"></div>
        {% endfor %}
    </div>
{% endmacro %}

{% macro menu(kind, user, is_admin) %}
    {% set _tags = {'field': 'tags', 'title': _('Tags')} %}
    {% set _date = {'field': 'date', 'title': _('Dates')} %}
    {% set _author = {'field': 'author', 'title': _('Authors')} %}
    {% set _color = {'field': 'color', 'title': _('Color')} %}
    {% set _model = {'field': 'model', 'title': _('Camera model')} %}
    {% set _lens = {'field': 'lens', 'title': _('Lens type')} %}
    {% set _eqv = {'field': 'eqv', 'title': _('Eqv. focal length')} %}
    {% set _iso = {'field': 'iso', 'title': _('Sensitivity')} %}
    {% set _forkind = {'field': 'forkind', 'title': _('Type')} %}

    <ul class="fa-ul">
        <li{{ {'class': 'active' if kind == 'Photo'}|xmlattr }}>
            <a href="{{ uri_for('photo_all') }}" title="{{ _('Photos') }}"><i class="fa fa-camera"></i></a></li>
        <li{{ {'class': 'active' if kind == 'Entry'}|xmlattr }}>
            <a href="{{ uri_for('entry_all') }}" title="{{ _('Blog') }}"><i class="fa fa-file-text"></i></a></li>
        <li{{ {'class': 'active' if kind == 'Comment'}|xmlattr }}>
            <a href="{{ uri_for('comment_all') }}" title="{{ _('Comments') }}"><i class="fa fa-comment"></i></a></li>
        <li{{ {'class': 'active' if kind == 'Feed'}|xmlattr }}>
            <a href="{{ uri_for('feed_all') }}" title="{{ _('News') }}"><i class="fa fa-rss-square"></i></a></li>
        {% if user %}
            <li{{ {'class': 'active' if kind == 'Admin'}|xmlattr }}>
                <a href="/admin/" title="{{ _('Administration') }}"><i class="fa fa-cog"></i></a></li>
        {% else %}
            <li><a href="/sign" title="{{ _('Log in') }}"><i class="fa fa-sign-in"></i></a></li>
        {% endif %}
    </ul>

    {% if kind == 'Photo' %}
        <h3>{{ _('Photos') }}</h3>
        {{ _build([_tags, _date, _author, _color, _model, _lens, _eqv, _iso], kind) }}
    {% elif kind == 'Entry' %}
        <h3>{{ _('Blog') }}</h3>
        {{ _build([_tags, _date, _author], kind) }}
    {% elif kind == 'Comment' %}
        <h3>{{ _('Comments') }}</h3>
        {{ _build([_forkind, _date, _author], kind) }}
    {% elif kind == 'Feed' %}
        <h3>{{ _('News') }}</h3>
        {{ _build([_tags], kind) }}
    {% elif kind == 'Admin' and user %}
        <h3>{{ _('Administration') }}</h3>
        <div class="submenu">
            {% if is_admin %}
                <a href="/admin/counters" class="block">Counters</a>
                <a href="/mapreduce" class="block">Mapreduce</a>
            {% endif %}
            <a href="/invalidate" class="block">{{ _('Invalidate cache') }}</a>
            <a href="/sign" class="block">{{ _('Log out') }}</a>
        </div>
    {% endif %}
{% endmacro %}

{% macro filter_title(filter) %}
    {% if filter %}
        {% if filter.field == 'tags' %}/ {{ filter.value }}{% endif %}
        {% if filter.field == 'date' %}/ {{ filter.value }}{% endif %}
        {% if filter.field == 'author' %}/ {{ filter.value }}{% endif %}
        {% if filter.field == 'color' %}/ {{ _(filter.value) }}{% endif %}
        {% if filter.field == 'model' %}/ {{ filter.value }}{% endif %}
        {% if filter.field == 'lens' %}/ {{ filter.value }}{% endif %}
        {% if filter.field == 'eqv' %}/ {{ filter.value }} mm{% endif %}
        {% if filter.field == 'iso' %}/ {{ filter.value }} ASA{% endif %}
        {% if filter.field == 'forkind' and filter.value == 'Photo' %}/ {{ _('for photos') }}{% endif %}
        {% if filter.field == 'forkind' and filter.value == 'Entry' %}/ {{ _('for blogs') }}{% endif %}
        {% if filter.field == 'forkind' and filter.value == 'Application' %}/ {{ _('messages') }}{% endif %}
    {% endif %}
{% endmacro %}

{% macro time(dt) %}
    <time class="when" datetime='{{ dt|to_datetime }}'>
        <span class="day">{{ dt|to_datetime("%d") }}</span>
        <span class="month">{{ dt|to_datetime("%m") }}</span>
        <span class="year">{{ dt|to_datetime("%Y") }}</span>
    </time>
{% endmacro %}

{% macro render_comment(obj, user) %}
    <div class="comment">
        {{ time(obj.date) }}
        <div class="body">
            {% if user == obj.author %}
                <a class="confirm delete fa fa-times-circle fa-2x pull-right"
                    href="{{ uri_for('delete', safe_key=obj.key.urlsafe()) }}" title="{{ _('Delete') }}"></a>
            {% endif %}
            <div class="para">{{ obj.body|safe }}</div>
            <p class="details">{{ obj.author }},
                {% trans since=obj.date|timesince %}{{ since }} ago{% endtrans %}
            </p>
        </div>
    </div>
{% endmacro %}

{% macro spinner() %}
    {%- for n in range(1, 13) %}<div class="bar{{ n }}"></div>{% endfor -%}
{% endmacro %}