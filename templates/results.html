{% extends "base.html" %}
{% block paging %}
    {% with %}
        {% set name='search' %}
        {% set phrase=phrase|urlencode() %}
        {% include 'snippets/paging.html' %}
    {% endwith %}
{% endblock %}

{% block contents %}
    <section>
        {% if error %}
            <div class="row">
                <div class="col s12 m6 l6">
                    <div class="alert white">
                        <i class="material-icons red-text">error</i>
                        <p class="title">{{ _('Error') }}</p>
                        <p>{{ error }}</p>
                    </div>
                </div>
            </div>
        {% else %}
            {% if phrase %}
                <h4>{% trans count=number_found %}{{ count }} search result for '{{ phrase }}'{% pluralize %}{{ count }} search results for '{{ phrase }}'{% endtrans %}</h4>
                <p>{{ _('You can use fields') }}: author, tags, year, month {{ _('and logical operators') }}: AND, OR {{ _('for example') }}: &quot;tags:milan AND month:11&quot;</p>
            {% else %}
                <h4>{{ _('Nothing to search for') }}</h4>
                <p>{{ _('Please try something') }}. {{ _('You can use fields') }}: author, tags, year, month</p>
            {% endif %}
        {% endif %}
    </section>
    <div id="gallery">
        {% for object in objects %}
            {% if object.kind == 'Photo' %}
                {% set url = uri_for('photo', slug=object.key.string_id()) %}
                {% set cls = 'found thumbnail' %}
            {% elif object.kind == 'Entry' %}
                {% set url = uri_for('entry', slug=object.key.string_id()) %}
                {% set cls = 'found blog' %}
            {% endif %}

            <a{{ {'href': url, 'class': cls}|xmlattr }}>
                <div class="card waves-effect z-depth-0">
                    {% if object.kind == 'Photo' %}
                        <div class="card-image">
                            <img src="{{ object.serving_url }}=s400">
                        </div>
                    {% endif %}
                    <div class="card-content">
                        <span class="card-title">{{ object.headline }}</span>
                        {% if object.kind == 'Entry' %}
                             {{ object.summary }}
                        {% endif %}
                        <span class="card-author">{{ object.author }},
                            {% trans since=object.date|timesince %}{{ since }} ago{% endtrans %}
                        </span>
                    </div>
                </div>
            </a>
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $(function () {
            var $container = $('#gallery');
            $container.gridalicious({
                selector: '.found',
                width: 300,
                gutter: 0
            });

            var load = true;
            $(window).scroll(function() {
                var scrollTop = $(window).scrollTop(),
                    docHeight = $(document).height(),
                    winHeight = $(window).height();

                if (docHeight - scrollTop - winHeight < 200 && load) {
                    var href = $('.next').attr('href');
                    if (href !== undefined) {
                        load = false;
                        $.get(href).done(function(response) {
                            var $page = $(response);
                            $container.gridalicious('append', $page.find('.found'));
                            $('.pagination').replaceWith(function() {
                                return $page.find('.pagination').hide();
                            });
                        }).always(function() {
                            load = true;
                        });
                    }
                }
            });
        });
    </script>
{% endblock %}