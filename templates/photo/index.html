{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}
{% block title %}{{ super() }} - {{ _('Photos') }}{% endblock %}
{% block paging %}{% endblock %}

{% block contents %}
<h2>
    <a href="{{ uri_for('photo_all') }}">{{ _('Photos') }}</a>
    {{ m.filter_title(filter) }}
</h2>

<div id="container">
    <div class="swiper-container">
        <div class="swiper-wrapper"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/idangerous.swiper.min.js"></script>
    <script>
        $(function() {
            var xhr;
            var page = 1 * '{{ page }}';
            var has_previous = ('{{ has_previous }}' == 'True');
            var has_next = ('{{ has_next }}' == 'True');

            function create(data, num, next) {
                if (next == undefined) next = true;
                var slide = mySwiper.createSlide(data);
                slide.data('index', num);
                if (next) {
                    slide.append();
                } else {
                    slide.prepend();
                }

            }
            var mySwiper = new Swiper('.swiper-container', {
                speed: 500,
                loop: false,
                grabCursor: true,
                calculateHeight: true,
                keyboardControl: true,
                watchActiveIndex: true,
                onSlideNext: function(swiper) {
                    var num, slide = swiper.getLastSlide();
                    num = 1 * slide.data('index') + 1;
                    if ($('.swiper-slide[data-index=' + num + ']').length == 0) {
                        $.get('?page=' + num).done(function(data) {
                            create(data, num);
                        })
                    }
                },
                onSlidePrev: function(swiper) {
                    var num, slide = swiper.getFirstSlide();
                    num = 1 * slide.data('index') - 1;
                    if ($('.swiper-slide[data-index=' + num + ']').length == 0) {
                        $.get('?page=' + num).done(function(data) {
                            create(data, num, false);
                        })
                    }
                }
            });

            if (has_previous && has_next) {
                xhr = $.when($.get('?page=' + (page - 1)), $.get('?page=' + page), $.get('?page=' + (page + 1)));
            } else if (has_previous && !has_next) {
                xhr = $.when($.get('?page=' + (page - 1)), $.get('?page=' + page));
            }  else if (!has_previous && has_next) {
                xhr = $.when($.get('?page=' + page), $.get('?page=' + (page + 1)));
            }
            xhr.done(function(a1, a2, a3) {
                if (has_previous && has_next) {
                    create(a1[0], page - 1);
                    create(a2[0], page);
                    create(a3[0], page + 1);
                    mySwiper.swipeTo(1, 0, false);
                } else if (has_previous && !has_next) {
                    create(a1[0], page - 1);
                    create(a2[0], page);
                    mySwiper.swipeTo(1, 0, false);
                }  else if (!has_previous && has_next) {
                    create(a1[0], page);
                    create(a2[0], page + 1);
                }
            });
        });
    </script>
{% endblock %}