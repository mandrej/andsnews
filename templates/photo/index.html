{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}
{% block title %}{{ super() }} - {{ _('Photos') }}{% endblock %}
{% block paging %}{% endblock %}

{% block contents %}
<h2>
    <a href="{{ uri_for('photo_all') }}">{{ _('Photos') }}</a>
    {{ m.filter_title(filter) }}
</h2>

<div id="container">
    <div class="swiper-container">
        <div class="swiper-wrapper"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/idangerous.swiper.min.js"></script>
    <script>
        $(function() {
            function create(data, next) {
                if (next == undefined) next = true;
                var root = $(data).filter('.thumbnails'),
                    attrs = $(root).data();
                $.each(attrs, function(k, v) {
                    $(root).removeAttr('data-' + k);
                });
                var slide = mySwiper.createSlide($(root).prop('outerHTML'));
                slide.data('prev', attrs.prev);
                slide.data('page', attrs.page);
                slide.data('next', attrs.next);
                if (next) {
                    slide.append();
                } else {
                    slide.prepend();
                }

            }
            var mySwiper = new Swiper('.swiper-container', {
                speed: 500,
                loop: false,
                grabCursor: true,
                calculateHeight: true,
                keyboardControl: true,
                watchActiveIndex: true,
                onSlideNext: function(swiper) {
                    var num = swiper.getLastSlide().data('next');
                    if (num == '') return;
                    $.get('?page=' + num).done(function(data) {
                        create(data);
                    })
                },
                onSlidePrev: function(swiper) {
                    var num = swiper.getFirstSlide().data('prev');
                    if (num == '') return;
                    $.get('?page=' + num).done(function(data) {
                        create(data, false);
                    })
                }
            });

            var page = 1 * '{{ page }}';
            var object_url = '?page=' + page;
            var previous_url = '?page=' + (page - 1);
            var next_url = '?page=' + (page + 1);
            var has_previous = ('{{ has_previous }}' == 'True');
            var has_next = ('{{ has_next }}' == 'True');

            if (has_previous && has_next) {
                $.when(
                    $.get(previous_url), $.get(object_url), $.get(next_url))
                .done(function(a1, a2, a3) {
                    create(a1[0]); create(a2[0]); create(a3[0]);
                    mySwiper.swipeTo(1, 0, false);
                });
            } else if (has_previous && !has_next) {
                $.when(
                    $.get(previous_url), $.get(object_url))
                .done(function(a1, a2) {
                    create(a1[0]); create(a2[0]);
                    mySwiper.swipeTo(1, 0, false);
                });
            } else if (!has_previous && has_next) {
                $.when(
                    $.get(object_url), $.get(next_url))
                .done(function(a1, a2) {
                    create(a1[0]); create(a2[0]);
                });
            } else {
                $.get(object_url, function(a1) {
                    create(a1);
                });
            }
        });
    </script>
{% endblock %}