{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}
{% block paging %}{% endblock %}

{% block title %}{{ super() }} - {{ object.headline }}{% endblock %}
{% block meta %}<meta name="date" content="{{ object.date|to_date }}"/>{% endblock %}

{% block modals %}
{{ super() }}
<div id="addcomment" class="modal"></div>
{% endblock %}

{% block contents %}
<div id="container">
    <div class="swiper-container">
        <div class="swiper-wrapper"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <link type="text/css" rel="stylesheet" href="/static/scripts/markitup/skins/simple/style.css"/>
    <link type="text/css" rel="stylesheet" href="/static/scripts/markitup/sets/buttons.css"/>
    <script src="/static/scripts/jquery.searchhighlight.min.js"></script>
    <script src="/static/scripts/markitup/jquery.markitup.min.js"></script>
    <script src="/static/scripts/markitup/sets/cmnt.set_{{ language_code }}.min.js"></script>
    <script src="/static/scripts/idangerous.swiper.min.js"></script>
    <script>
        $(function() {
            function create(data, next) {
                if (next == undefined) next = true;
                var slide = mySwiper.createSlide(data);
                if (next) {
                    slide.append();
                    if (mySwiper.slides.length > 3) {
                        mySwiper.getFirstSlide().remove();
                        mySwiper.swipeTo(mySwiper.activeIndex - 1, 0, false);
                    } else if (mySwiper.slides.length == 3) {
                        mySwiper.swipeTo(mySwiper.activeIndex, 0, false);
                    } else {
                        mySwiper.swipeTo(mySwiper.activeIndex + 1, 0, false);
                    }
                } else {
                    slide.prepend();
                    if (mySwiper.slides.length > 3) {
                        mySwiper.getLastSlide().remove();
                    }
                    mySwiper.swipeTo(mySwiper.activeIndex + 1, 0, false);
                }
                var canvas = $(slide).find('canvas');
                var normal_url = $(canvas).attr('data-url');
                $(canvas).copyright(normal_url);
                $(window).resize(function() {
                    $(canvas).copyright(normal_url);
                });
            }
            var mySwiper = new Swiper('.swiper-container', {
                speed: 500,
                loop: false,
                grabCursor: true,
                keyboardControl: true,
                watchActiveIndex: true,
                onSlideChangeEnd: function(swiper, direction) {
                    var url,
                        next = (direction == 'next');
                    switch(direction) {
                        case 'prev':
                            url = $(swiper.getFirstSlide()).find('.port').data('prev');
                            break;
                        case 'next':
                            url = $(swiper.getLastSlide()).find('.port').data('next');
                            break;
                        default:
                            return;
                    }
                    if (url == undefined) return;
                    console.log(direction, url, next);
                    $.get(url, function(data) {
                        create(data, next);
                    });
                }
            });

            var object_url = '{{ object_url }}';
            var previous_url = '{{ previous_url }}';
            var next_url = '{{ next_url }}';
            var has_previous = (previous_url != '');
            var has_next = (next_url != '');

            if (has_previous && has_next) {
                $.when(
                    $.get(previous_url), $.get(object_url), $.get(next_url))
                .done(function(a1, a2, a3) {
                    create(a1[0]); create(a2[0]); create(a3[0]);
                });
            } else if (has_previous && !has_next) {
                $.when(
                    $.get(previous_url), $.get(object_url))
                .done(function(a1, a2) {
                    create(a1[0]); create(a2[0]);
                });
            } else if (!has_previous && has_next) {
                $.when(
                    $.get(object_url), $.get(next_url))
                .done(function(a1, a2) {
                    create(a1[0]); create(a2[0]);
                });
            } else {
                $.get(object_url, function(a1) {
                    create(a1);
                });
            }
        });
    </script>
{% endblock %}