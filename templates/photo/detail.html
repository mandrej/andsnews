{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}
{% block title %}{{ super() }} - {{ _('Photos') }}{% endblock %}
{% block paging %}
    {% with name='photo' %}{% include 'snippets/paging.html' %}{% endwith %}
{% endblock %}

{% block contents %}
    <div class="swiper-container swiper-parent">
        <div class="swiper-wrapper">
            {% for object in objects %}
                {% if object %}
                    <div data-hash="{{ object.key.string_id() }}" class="swiper-slide main">
                        <div class="cover lazyload" data-bg="{{ object.normal_url }}">
                            <div class="swiper-container swiper-nested">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide blank"></div>
                                    <div class="swiper-slide exif">
                                        {% include "photo/exif.html" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function () {
            var parameters = $.getQueryParameters(),
                ids = $('.main').map(function() {
                    return $(this).data('hash')
                }).get(),
                index = $.inArray('{{ slug }}', ids),
                pages = [];

            pages.push(parseInt(parameters.page));
{#            window.history.pushState("object or string", "Title", location.pathname + '#' + parameters.slug);#}

            var horizontal = new Swiper('.swiper-parent', {
                direction: 'horizontal',
                loop: false,
                hashnav: true,
                keyboardControl: true,
                initialSlide: (index != -1)? index: 0,
                onReachEnd: function(sw) {
                    var href = $('.next').attr('href'),
                        page = parseInt($.getQueryParameters(href).page);

                    if ($.inArray(page, pages) == -1) {
                        $.get(href, function(response) {
                            var $page = $(response);

                            pages.push(page);
                            sw.appendSlide($page.find('.main'));
                            $('nav.paginator').replaceWith(function() {
                                return $page.find('nav.paginator').hide()
                            });

                            vertical = new Swiper('.swiper-nested', {
                                direction: 'vertical',
                                keyboardControl: true
                            });
                        });
                    }
                },
                onReachBeginning: function(sw) {
                    var href = $('.prev').attr('href'),
                        page = parseInt($.getQueryParameters(href).page);

                    if ($.inArray(page, pages) == -1) {
                        $.get(href, function (response) {
                            var $page = $(response);

                            pages.push(page);
                            // reverse defined in custom.js
                            sw.prependSlide($page.find('.main').reverse());
                            $('nav.paginator').replaceWith(function() {
                                return $page.find('nav.paginator').hide()
                            });

                            vertical = new Swiper('.swiper-nested', {
                                direction: 'vertical',
                                keyboardControl: true
                            });
                        });
                    }
                }
            });
            var vertical = new Swiper('.swiper-nested', {
                direction: 'vertical',
                keyboardControl: true
            });

            $(document).on('lazybeforeunveil', function(e) {
                var $this = $(e.target);
                var url = $this.data('bg');
                if (url) $this.css('background-image', 'url(' + url + ')').removeAttr('data-bg');
            });

            $('nav.paginator').hide();
        });
    </script>
{% endblock %}