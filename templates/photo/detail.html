{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}
{% block paging %}{% endblock %}

{% block title %}{{ super() }} - {{ object.headline }}{% endblock %}
{% block meta %}<meta name="date" content="{{ object.date|to_date }}"/>{% endblock %}

{% block modals %}
{{ super() }}
<div id="addcomment" class="modal"></div>
{% endblock %}

{% block contents %}
<div id="container">
    <div class="swiper-container">
        <div class="swiper-wrapper"></div>
    </div>
    {% set url = uri_for('photo_filter', field=filter.field, value=filter.value, slug=previous.key.string_id())
        if filter else uri_for('photo', slug=previous.key.string_id()) %}
    <pre>{{ url }}</pre>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/idangerous.swiper.min.js"></script>
    <script>
        $(function() {
            var url = $('pre').text();
            var endIndex = -1;
            var mySwiper = new Swiper('.swiper-container', {
                speed: 500,
                loop: false,
                grabCursor: true,
                calculateHeight: true,
                keyboardControl: true,
                watchActiveIndex: true,
                onTouchStart: appendSlide,
                onSlideNext: appendSlide
            });
            function appendSlide(swiper) {
                var lastIndex, lastSlide = swiper.getLastSlide();
                if (lastSlide == undefined) {
                    lastIndex = 0;
                } else {
                    lastIndex = 1 * lastSlide.data('index');
                }
                if (endIndex == lastIndex) return;
                var xhr = $.get(url)
                    .done(function(data) {
                        var newSlide = swiper.createSlide(data);
                        newSlide.data('index', lastIndex);
                        newSlide.append();
                        swiper.reInit();
                        if (swiper.slides.length == 1) {
                            appendSlide(swiper);
                        }
                    })
                    .fail(function() {
                        endIndex = lastIndex - 1;
                    });
            }
            appendSlide(mySwiper);
        });
    </script>
{% endblock %}