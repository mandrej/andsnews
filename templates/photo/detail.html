{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}

{% block title %}{{ super() }} - {{ object.headline }}{% endblock %}
{% block meta %}<meta name="date" content="{{ object.date|to_date }}"/>{% endblock %}

{% block modals %}
{{ super() }}
<div id="addcomment" class="modal"></div>
{% endblock %}

{% block paging %}
    {% macro link(obj, class) %}
        {% if filter %}
            <a class="{{ class }}" href="{{ uri_for('photo_filter', field=filter.field, value=filter.value, slug=obj.key.string_id()) }}"
               title="{{ obj.headline }}"></a>
        {% else %}
            <a class="{{ class }}" href="{{ uri_for('photo', slug=obj.key.string_id()) }}"
               title="{{ obj.headline }}"></a>
        {% endif %}
    {% endmacro %}
    {% if previous or next %}
        {% if previous %}
            {{ link(previous, 'prev icon-chevron-left icon-4x') }}
        {% else %}
            <span class="prev na icon-chevron-left icon-4x"></span>
        {% endif %}
        {% if next %}
            {{ link(next, 'next icon-chevron-right icon-4x') }}
        {% else %}
            <span class="next na icon-chevron-right icon-4x"></span>
        {% endif %}
    {% endif %}
{% endblock %}

{% block contents %}
<div class="swiper-wrapper">
    {% for obj in [previous, object, next] %}
         {% if obj %}
            <div id="{{ obj.key.string_id() }}" class="swiper-slide">
                <aside>
                    <nav class="submenu">
                        <h2>
                            {% if user %}
                                <a href="{{ uri_for('photo_add') }}" class="add" title="{{ _('Add') }}">{{ _('Add') }}</a>
                                <a class="comment_add" href="{{ uri_for('comment_add', safe_key=obj.key.urlsafe()) }}" title="{{ _('Comment') }}">{{ _('Comment') }}</a>
                            {% endif %}
                            {% if is_admin or user == obj.author %}
                                <a href="{{ uri_for('photo_edit', slug=object.key.string_id()) }}" class="change" title="{{ _('Edit') }}">{{ _('Edit') }}</a>
                                <a class="confirm" href="{{ uri_for('delete', safe_key=obj.key.urlsafe()) }}" title="{{ _('Delete') }}">{{ _('Delete') }}</a>
                            {% endif %}
                            <a href="{{ uri_for('photo_all') }}" title="{{ _('Back') }}">{{ _('Back') }}</a>
                        </h2>
                    </nav>
                    {% include "photo/exif.html" %}
                    <div class="comments">
                        {% for comment in obj.comment_list() %}
                            {{ m.render_comment(comment, user) }}
                        {% endfor %}
                    </div>
                </aside>
                <article class="port">
                    <header>
                        {% if filter %}
                            {% set url = uri_for('photo_filter_all', field=filter.field, value=filter.value) %}
                        {% else %}
                            {% set url = uri_for('photo_all') %}
                        {% endif %}
                        <h2>
                            <a href="{{ url }}?page={{ page }}"> {{ _('Photos') }}
                                {{ m.filter_title(filter) }}
                            </a>
                            / {{ obj.headline }}
                        </h2>

                        <div class="subtitle">
                            <i class="icon-user"></i>
                            <a href="{{ uri_for('photo_filter_all', field='author', value=obj.author) }}"
                                title="{{ _("author's photos") }}">{{ obj.author }}</a>
                            {% for tag in obj.tags %}
                                {% if loop.first %}<i class="icon-tag"></i>{% endif %}
                                <a href="{{ uri_for('photo_filter_all', field='tags', value=tag) }}">
                                    {{ tag }}</a>{% if not loop.last %},{% endif %}
                            {% endfor %}
                            <i class="icon-time"></i>
                            <a href="{{ uri_for('photo_filter_all', field='date', value=obj.year) }}"
                                title="{{ _('photos taken same year') }}">{{ obj.year }}</a>
                        </div>
                    </header>

                    <figure>
                        <img src="{{ obj.normal_url() }}" alt="{{ obj.headline }}"/>
                    </figure>
                </article>
            </div>
        {% endif %}
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/idangerous.swiper-2.3.min.js"></script>
    <script src="/static/scripts/jquery.highlight.js"></script>
    <script>
        $(function() {
            var match = location.search.match(/find=([^&]+)/i);
            if (match) {
                $(function() {
                    var options = {exact: "partial", highlight: "#main",
                        keys: decodeURIComponent(match[1])};
                    $(document).SearchHighlight(options);
                });
            }
            $('a.comment_add').click(function() {
                $('#addcomment').load(this.href, function() {
                    $('#overlay, #addcomment').show();
                });
                return false
            });

            var ids = $('.swiper-slide').map(function(i, div) { return div.id; }).get();
            function prev(url) {
                if (url) {
                    swiper.swipePrev();
                    $.get(url, function(data) {
                        var page = $(data);
                        var slide = page.find('.swiper-slide:first')[0];
                        if ($.inArray(slide.id, ids) == -1) {
                            $('.swiper-wrapper').prepend(slide);
                            ids.unshift(slide.id);
                            swiper.reInit();
                        }
                        $('.paginator').replaceWith(page.find('.paginator'));
                    });
                }
            }
            function next(url) {
                if (url) {
                    swiper.swipeNext();
                    $.get(url, function(data) {
                        var page = $(data);
                        var slide = page.find('.swiper-slide:last')[0];
                        if ($.inArray(slide.id, ids) == -1) {
                            $('.swiper-wrapper').append(slide);
                            ids.push(slide.id);
                            swiper.reInit();
                            console.log('x');
                        }
                        $('.paginator').replaceWith(page.find('.paginator'));
                    });
                }
{#                if ('{{ next }}' != 'None') {#}
{#                    var slug = '{{ next.key.string_id() }}';#}
{#                    var url = '{{ uri_for('photo_filter', field=filter.field, value=filter.value, slug=next.key.string_id()) }}';#}
{#                    #}
{#                    if ($.inArray(slug, ids) == -1) {#}
{#                        $.get(url, function(data) {#}
{#                            var page = $(data);#}
{#                            var slide = page.find('.swiper-slide:last')[0];#}
{#                            $('.swiper-wrapper').append(slide);#}
{#                            ids.push(slide.id);#}
{#                            swiper.reInit();#}
{#                            swiper.swipeNext();#}
{#                            $('.paginator').replaceWith(page.find('.paginator'));#}
{#                        });#}
{#                    } else {#}
{#                        swiper.swipeNext();#}
{#                    }#}
{#                }#}
            }
            var swiper = $('#main').swiper({
                speed: 500,
                mode: 'horizontal',
                initialSlide: $.inArray('{{ object.key.string_id() }}', ids),
                grabCursor: true,
                calculateHeight: true,
{#                pagination: '.paginator',#}
{#                paginationClickable: true,#}
{#                createPagination: false,#}
{#                paginationElement: 'a',#}
{#                watchActiveIndex: true,#}
{#                onlyExternal: true,#}
                keyboardControl: true,
                mousewheelControl: true,
                onSlideChangeEnd: function(sw) {
{#                    var direction = sw.touches.diff;#}
{#                    if (direction > 0) {#}
{#                        prev($('.prev').attr('href'));#}
{#                    } else {#}
{#                        next($('.next').attr('href'));#}
{#                    }#}
                    console.log(sw.width, sw.touches.diff);
                }
            });

            $('.prev').live('click', function(e) {
                e.preventDefault();
                prev($(this).attr('href'));
            });
            $('.next').live('click', function(e) {
                e.preventDefault();
                next($(this).attr('href'));
            });
        });
    </script>
{% endblock %}