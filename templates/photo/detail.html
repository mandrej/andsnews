{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}
{% block paging %}{% endblock %}

{% block title %}{{ super() }} - {{ object.headline }}{% endblock %}
{% block meta %}<meta name="date" content="{{ object.date|to_date }}"/>{% endblock %}

{% block modals %}
{{ super() }}
<div id="addcomment" class="modal"></div>
{% endblock %}

{% block contents %}
<div id="container">
    <div class="swiper-container">
        <div class="swiper-wrapper"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <link type="text/css" rel="stylesheet" href="/static/scripts/markitup/skins/simple/style.css"/>
    <link type="text/css" rel="stylesheet" href="/static/scripts/markitup/sets/buttons.css"/>
    <script src="/static/scripts/jquery.searchhighlight.min.js"></script>
    <script src="/static/scripts/markitup/jquery.markitup.min.js"></script>
    <script src="/static/scripts/markitup/sets/cmnt.set_{{ language_code }}.min.js"></script>
    <script src="/static/scripts/idangerous.swiper.min.js"></script>
    <script>
        $(function() {
            var xhr;
            var object_url = '{{ object_url }}';
            var previous_url = '{{ previous_url }}';
            var next_url = '{{ next_url }}';
            var has_previous = (previous_url != '');
            var has_next = (next_url != '');

            function create(data, next) {
                if (next == undefined) next = true;
                var root = $(data).filter('.port'),
                    attrs = $(root).data();
                $.each(attrs, function(k, v) {
                    $(root).removeAttr('data-' + k);
                });
                var slide = mySwiper.createSlide($(root).prop('outerHTML'));
                slide.data('prev', attrs.prev);
                slide.data('page', attrs.page);
                slide.data('next', attrs.next);
                if (next) {
                    slide.append();
                } else {
                    slide.prepend();
                }
                var canvas = $(slide).find('canvas');
                var normal_url = $(canvas).attr('data-url');
                $(canvas).copyright(normal_url);
                $(window).resize(function() {
                    $(canvas).copyright(normal_url);
                });
            }
            var mySwiper = new Swiper('.swiper-container', {
                speed: 500,
                loop: false,
                grabCursor: true,
                calculateHeight: true,
                keyboardControl: true,
                watchActiveIndex: true,
                onSlideNext: function(swiper) {
                    var url = swiper.getLastSlide().data('next');
                    if (url == '-') return;
                    $.get(url).done(function(data) {
                        create(data);
                    })
                },
                onSlidePrev: function(swiper) {
                    var url = swiper.getFirstSlide().data('prev');
                    if (url == '-') return;
                    $.get(url).done(function(data) {
                        create(data, false);
                    })
                }
            });

            if (has_previous && has_next) {
                xhr = $.when($.get(previous_url), $.get(object_url), $.get(next_url));
            } else if (has_previous && !has_next) {
                xhr = $.when($.get(previous_url), $.get(object_url));
            }  else if (!has_previous && has_next) {
                xhr = $.when($.get(object_url), $.get(next_url));
            }
            xhr.done(function(a1, a2, a3) {
                if (has_previous && has_next) {
                    create(a1[0]); create(a2[0]); create(a3[0]);
                    mySwiper.swipeTo(1, 0, false);
                } else if (has_previous && !has_next) {
                    create(a1[0]); create(a2[0]);
                    mySwiper.swipeTo(1, 0, false);
                }  else if (!has_previous && has_next) {
                    create(a1[0]); create(a2[0]);
                }
            });
        });
    </script>
{% endblock %}