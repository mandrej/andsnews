{% extends "photo/base.html" %}
{% block title %}{{ super() }} - {{ _('Photos') }}{% endblock %}
{% block paging %}
    {% with name='photo' %}{% include 'snippets/paging.html' %}{% endwith %}
{% endblock %}

{% block contents %}
    <div class="swiper-container">
        <div class="swiper-wrapper">
            {% for object in objects %}
                <div id="{{ object.key.string_id() }}"
                     class="swiper-slide cover b-lazy"
                     data-src="{{ object.serving_url }}=s0"
                     data-src-small="{{ object.serving_url }}=s800">
                    <div class="headline">
                        <h2>{{ object.headline }}</h2>
                        <p>
                            <a href="{{ uri_for('photo_all_filter', field='author', value=object.author) }}"
                                title="{{ _("author's photos") }}">{{ object.author }}</a>
                            {% for tag in object.tags %}
                                {% if loop.first %}&nbsp;<i class="fa fa-tag"></i>{% endif %}
                                <a href="{{ uri_for('photo_all_filter', field='tags', value=tag) }}">
                                    {{ tag }}</a>{% if not loop.last %},{% endif %}
                            {% endfor %}
                            &nbsp;<i class="fa fa-clock-o"></i>&nbsp;
                            <a href="{{ uri_for('photo_all_filter', field='date', value=object.year) }}"
                                title="{{ _('photos taken same year') }}">{{ object.year }}</a>
                        </p>
                    </div>
                    <div class="exif hide">
                        {% include "photo/exif.html" %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/blazy.min.js"></script>
    <script>
        $(document).ready(function () {
            var parameters = $.getQueryParameters(),
                ids = $('.cover').map(function() {
                    return this.id
                }).get(),
                index = $.inArray('{{ slug }}', ids),
                pages = [];

            pages.push(parseInt(parameters.page));
            window.history.replaceState(null, '', location.pathname);

            function getPage(href, callback) {
                var num = parseInt($.getQueryParameters(href).page);
                if (!isNaN(num) && $.inArray(num, pages) == -1) {
                    $.get(href, function(response) {
                        var $page = $(response);
                        callback($page);

                        $('nav.paginator').replaceWith(function() {
                            return $page.find('nav.paginator').hide()
                        });
                    });
                    pages.push(num);
                }
            }
            function lazyLoad(sw) {
                var bLazy = new Blazy({
                    breakpoints: [{width: 400, src: 'data-src-small'}]
                });
                var activeSlide = sw.slides.eq(sw.activeIndex);
                if (!activeSlide.hasClass('b-loaded')) {
                    bLazy.load(activeSlide);
                }
                activeSlide.css({'background-size': 'cover', 'background-position': '50% 50%'});
                activeSlide.find('.exif').hide();
                $('#main').css('bottom', '0px');
            }
            var horizontal = new Swiper('.swiper-container', {
                direction: 'horizontal',
                loop: false,
                keyboardControl: true,
                longSwipesRatio: 0.3,
                grabCursor: true,
                initialSlide: (index != -1)? index: 0,
                onReachEnd: function(sw) {
                    getPage($('.next').attr('href'), function($page) {
                        sw.appendSlide($page.find('.cover'));
                    });
                },
                onReachBeginning: function(sw) {
                    getPage($('.prev').attr('href'), function($page) {
                        sw.prependSlide($page.find('.cover').reverse());
                    });
                },
                onSlideChangeEnd: lazyLoad
            });

            $('#main').on('click', '.cover', function() {
                var main = $('#main');
                var cntx = $(this);
                if (main.css('bottom') == '0px') {
                    main.css('bottom', '-80%');
                    cntx.css({'background-size': '100% auto', 'background-position': '100% 0'});
                    cntx.find('.exif').slideDown();
                } else {
                    main.css('bottom', '0px');
                    cntx.css({'background-size': 'cover', 'background-position': '50% 50%'});
                    cntx.find('.exif').hide();
                }
            });

            lazyLoad(horizontal);
            $('nav.paginator').hide();
        });
    </script>
{% endblock %}