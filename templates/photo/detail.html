{% extends "photo/base.html" %}
{% block background %}
<body class="dark">
{% endblock %}
{% block title %}{{ super() }} - {{ _('Photos') }}{% endblock %}
{% block paging %}
    {% with %}
        {% set name='photo' %}
        {% set slug=slug %}
        {% include 'snippets/paging.html' %}
    {% endwith %}
{% endblock %}

{% block contents %}
    <div class="swiper-container">
        <div class="swiper-wrapper">
            {% for object in objects %}
                <div id="{{ object.key.string_id() }}" class="swiper-slide cover"
                    data-title="{{ object.headline }}" data-dim="{{ object.dim }}" data-ratio="{{ object.ratio }}">
                    <div class="panzoom">
                        <img class="swiper-lazy" data-src="{{ object.serving_url }}=s0">
                    </div>
                    <div class="exif">
                        {% include "photo/exif.html" %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/jquery.panzoom.min.js"></script>
    <script>
        $(function () {
            var viewPort = {
                width: window.innerWidth,
                height: window.innerHeight - 60
            };
            var parameters = $.getQueryParameters(),
                ids = $('.cover').map(function() {
                    return this.id
                }).get(),
                index = $.inArray('{{ slug }}', ids),
                pages = [];

            pages.push(parseInt(parameters.page));

            function getPage(href, callback) {
                var num = parseInt($.getQueryParameters(href).page);
                if (!isNaN(num) && $.inArray(num, pages) == -1) {
{#                    TODO href is from paginator#}
                    $.get(href, function(response) {
                        var $page = $(response);
                        callback($page);
                        $('nav.paginator').replaceWith(function() {
                            return $page.find('nav.paginator').hide();
                        });
                    });
                    pages.push(num);
                }
            }
            function adjastView(sw) {
                var slide = sw.slides.eq(sw.activeIndex),
                    slug = slide[0].id,
                    title = slide.data('title'),
                    img_width = slide.data('dim')[0],
                    img_height = slide.data('dim')[1],
                    slide_height = slide.height(),
                    $panzoom = slide.find('.panzoom');

                window.history.replaceState(location.pathname, '', slug);
                $('header h1').html(title);
                $('.panzoom').panzoom('resetZoom', false);
                $('#main').css({'height': slide_height + 'px'});
                $('html, body').animate({scrollTop: 0});

                if (img_width > viewPort.width) {
                    $panzoom.panzoom({
                        minScale: 1,
                        increment: 0.1,
                        maxScale: img_width / viewPort.width,
                        contain: 'invert'
                    }).on('mousewheel.focal', function(e) {
                        var delta = e.delta || e.originalEvent.wheelDelta;
                        var zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;
                        $panzoom.panzoom('zoom', zoomOut, {
                            animate: true,
                            focal: e
                        })
                    });
                }
            }
            var horizontal = new Swiper('.swiper-container', {
                direction: 'horizontal',
                loop: false,
                keyboardControl: true,
                longSwipesRatio: 0.3,
                grabCursor: true,
                lazyLoading: true,
                lazyLoadingInPrevNext: true,
                onLazyImageReady: adjastView,
                initialSlide: (index != -1)? index: 0,
                onReachEnd: function(sw) {
                    getPage($('.next').attr('href'), function($page) {
                        sw.appendSlide($page.find('.cover'));
                    });
                },
                onReachBeginning: function(sw) {
                    getPage($('.prev').attr('href'), function($page) {
                        sw.prependSlide($page.find('.cover').reverse());
                    });
                },
                onSlideChangeEnd: adjastView
            });

            $(window).on('resize', function() {
                $('.panzoom').panzoom('resetDimensions');
            });
            $('nav.paginator').hide();
        });
    </script>
{% endblock %}