{% extends "photo/base.html" %}
{% import "snippets/macros.html" as m %}

{% block title %}{{ super() }} - {{ object.headline }}{% endblock %}
{% block meta %}<meta name="date" content="{{ object.date|to_date }}"/>{% endblock %}

{% block modals %}
{{ super() }}
<div id="addcomment" class="modal"></div>
{% endblock %}

{% block paging %}
    {% macro link(obj, index, class) %}
        {% set attributes = {'href': '%s?idx=%s' %
            (uri_for('photo_filter', field=filter.field, value=filter.value, slug=obj.key.string_id()), index)
            if filter else '%s?idx=%s' %  (uri_for('photo', slug=obj.key.string_id()), index),
            'class': class, 'title': obj.headline} %}
        <a{{ attributes|xmlattr }}></a>
    {% endmacro %}

    {% if previous or next %}
        {% if previous %}
            {{ link(previous, idx - 1, prev_class) }}
        {% else %}
            <span class="{{ prev_class }} na"></span>
        {% endif %}
        {% if next %}
            {{ link(next, idx + 1, next_class) }}
        {% else %}
            <span class="{{ next_class }} na"></span>
        {% endif %}
    {% endif %}
{% endblock %}

{% block contents %}
<aside>
    <nav class="submenu">
        <h2>
            {% if user %}
                <a href="{{ uri_for('photo_add') }}" class="add" title="{{ _('Add') }}">{{ _('Add') }}</a>
                <a class="comment_add" href="{{ uri_for('comment_add', safe_key=object.key.urlsafe()) }}" title="{{ _('Comment') }}">{{ _('Comment') }}</a>
            {% endif %}
            {% if is_admin or user == object.author %}
                <a href="{{ uri_for('photo_edit', slug=object.key.string_id()) }}" class="change" title="{{ _('Edit') }}">{{ _('Edit') }}</a>
                <a class="confirm" href="{{ uri_for('delete', safe_key=object.key.urlsafe()) }}" title="{{ _('Delete') }}">{{ _('Delete') }}</a>
            {% endif %}
            <a href="{{ uri_for('photo_all') }}" title="{{ _('Back') }}">{{ _('Back') }}</a>
        </h2>
    </nav>
    {% include "photo/exif.html" %}
    <div class="comments">
        {% for comment in object.comment_list() %}
            {{ m.render_comment(comment, user) }}
        {% endfor %}
    </div>
</aside>
<article class="port">
    <header>
        {% if filter %}
            {% set url = uri_for('photo_filter_all', field=filter.field, value=filter.value) %}
        {% else %}
            {% set url = uri_for('photo_all') %}
        {% endif %}
        <h2>
            <a href="{{ url }}?page={{ page }}"> {{ _('Photos') }}
                {{ m.filter_title(filter) }}
            </a>
            / {{ object.headline }}
        </h2>

        <div class="subtitle">
            <i class="icon-user"></i>
            <a href="{{ uri_for('photo_filter_all', field='author', value=object.author) }}"
                title="{{ _("author's photos") }}">{{ object.author }}</a>
            {% for tag in object.tags %}
                {% if loop.first %}<i class="icon-tag"></i>{% endif %}
                <a href="{{ uri_for('photo_filter_all', field='tags', value=tag) }}">
                    {{ tag }}</a>{% if not loop.last %},{% endif %}
            {% endfor %}
            <i class="icon-time"></i>
            <a href="{{ uri_for('photo_filter_all', field='date', value=object.year) }}"
                title="{{ _('photos taken same year') }}">{{ object.year }}</a>
        </div>
    </header>
    <canvas></canvas>
</article>
{% endblock %}
{% block scripts %}
    <link type="text/css" rel="stylesheet" href="/static/scripts/markitup/skins/simple/style.css"/>
    <link type="text/css" rel="stylesheet" href="/static/scripts/markitup/sets/buttons.css"/>
    {{ super() }}
    <script>
        nbl.l([[
            'https://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js',
            '/static/scripts/jquery.searchhighlight.min.js',
            '/static/scripts/markitup/jquery.markitup.min.js',
            '/static/scripts/markitup/sets/cmnt.set_{{ language_code }}.min.js', [
                '/static/scripts/common.min.js',
                '/static/scripts/base.min.js',
                function() {
                    $('canvas').copyright('{{ object.url() }}');
                }]]]);
    </script>
{% endblock %}