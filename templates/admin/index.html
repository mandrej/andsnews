{% extends "admin/base.html" %}
{% block modals %}
{{ super() }}
<div id="graph" class="modal"></div>
{% endblock %}

{% block contents %}
<article>
	<h2>Site administration</h2>
    <div id="container" class="cols">
        <section class="admin">
            <h3>
                <a href="/admin/photos/" class="button">
                    <i class="fa fa-th-list"></i>
                    Photo {{ photo_count }}
                </a>
                <a href="{{ uri_for('photo_add') }}" class="button">
                    <i class="fa fa-plus-square"></i> Add
                </a>
            </h3>
            <div id="Photo_tags"></div>
            <div id="Photo_author"></div>
            <div id="Photo_date"></div>
            <div id="Photo_model"></div>
            <div id="Photo_lens"></div>
            <div id="Photo_eqv"></div>
            <div id="Photo_iso"></div>
            <div id="Photo_color"></div>
        </section>
        <section class="admin">
            <h3>
                <a href="/admin/entries/" class="button">
                    <i class="fa fa-th-list"></i>
                    Entry {{ entry_count }}
                </a>
                <a href="{{ uri_for('entry_add') }}" class="button">
                    <i class="fa fa-plus-square"></i> Add
                </a>
            </h3>
            <div id="Entry_tags"></div>
            <div id="Entry_author"></div>
            <div id="Entry_date"></div>

            <h3>
                <a href="/admin/feeds/" class="button">
                    <i class="fa fa-th-list"></i>
                    Feeds {{ feeds_count }}
                </a>
                <a href="{{ uri_for('feed_add') }}" class="button">
                    <i class="fa fa-plus-square"></i> Add
                </a>
            </h3>
            <div id="Feed_tags"></div>

            {% if is_admin %}
                <h3>
                    <a href="/admin/comments/" class="button">
                        <i class="fa fa-th-list"></i>
                        Comment {{ comment_count }}
                    </a>
                </h3>
                <div id="Comment_forkind"></div>
                <div id="Comment_author"></div>
                <div id="Comment_date"></div>
            {% endif %}
        </section>
        <section class="admin">
            <h3>
                <span class="button">
                    <i class="fa fa-bars"></i>
                    Memcache statistics for	v.{{ version() }}
                </span>
            </h3>
            <dl class="w65em">
                <dt>hit ratio</dt>
                <dd>
                    {{ '%0.1f'|format(hit_ratio) }}%
                    ({{ stats.hits }} hits, {{ stats.misses }} misses)
                </dd>
            </dl>
            <dl class="w65em">
                <dt>size</dt>
                <dd>{{ stats['items'] }} items,
                    {{ stats.bytes|filesizeformat }}
                </dd>
            </dl>
            <dl class="w65em">
                <dt>oldest item</dt>
                <dd>{{ oldest|timesince }} ago</dd>
            </dl>
        </section>
    </div>
    <h2 class="ss">Spectra [+]</h2>
    <div class="hide">
        <div class="admin">
            <dl class="w65em">
                <dt>Saturation</dt>
                <dd>
                    <div id="sat" class="slider"></div><div style="float: left; width: 1em">&nbsp;</div>
                    <input type="text" name="sat" size="2" disabled="disabled"/>
                </dd>
            </dl>
            <dl class="w65em">
                <dt>Lightness</dt>
                <dd>
                    <div id="lum" class="slider"></div><div style="float: left; width: 1em">&nbsp;</div>
                    <input type="text" name="lum" size="2" disabled="disabled"/>
                </dd>
            </dl>
        </div>
        <div id="spectra"></div>
    </div>
</article>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <link href="https://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="https://www.google.com/jsapi"></script>
    <script>
        google.load('visualization', '1', {packages: ['corechart']});
        $(function() {
            function build() {
                $.getJSON('/admin/memcache/', function(data) {
                    $.each(data, function(key, value) {
                        var tmpl = '', title = key.split('_').pop() + ' cloud';
                        if (value) {
                            tmpl += '<button type="submit" name="delete" value="' + key + '"><i class="fa fa-times"></i> delete</button>';
                            tmpl += '<a class="graph button" href="/visualize/' + key + '"><i class="fa fa-eye"></i> graph</a>';
                            tmpl += '<h4 class="ff">' + title + ' [+]</h4>';
                            tmpl += '<div class="hide">';
                            $.each(value, function(name, count) {
                                tmpl += '<dl><dt>' + name + '</dt>';
                                tmpl += '<dd>' + count + '</dd></dl>';
                            });
                            tmpl += '</div>';
                        } else {
                            tmpl += '<button type="submit" name="put" value="' + key + '"><i class="fa fa-cog"></i> create</button>';
                            tmpl += '<h4>' + title + ' [EMPTY]</h4>';
                        }
                        $('#' + key).html(tmpl);
                    });
                    $('.ff').collapseGroup();
                });
            }
            build();

            $('.admin div').on('click', 'button', function() {
                $('#spinner').show();
                var key = $(this).val(), method = $(this).attr('name');
                $.ajax({
                    url: '/admin/memcache/' + key,
                    type: method,
                    dataType: 'json',
                    success: function(data) {
                        $('#spinner').hide();
                        build();
                        $('.ff').unbind().collapseGroup();
                    }
                });
            });
            $('.admin div').on('click', 'a.graph', function(evt) {
                evt.preventDefault();
                $('#graph').load(this.href, function() {
                    $('#overlay, #graph').show();
                });
            });

            var drawSpectra = function() {
                var sat = $('#sat').slider('value');
                var lum = $('#lum').slider('value');

                $.getJSON('/admin/spectra?sat=' + sat + '&lum=' + lum, function(data) {
                    $('#spectra').empty();
                    $.each(data, function(name, colors) {
                        var str = '<div style="clear: both"><span class="item" style="width: 50px;">' + name + '</span>';
                        $.each(colors, function(i, c) {
                            str += '<span class="item" style="background: ' + c + '">&nbsp;</span>';
                        });
                        str += '</div>';
                        $('#spectra').append(str);
                    });
                })
            };
            $('.slider').slider({
                min: 0, max: 100, step: 5,
                change: function(event, ui) {
                    $('input[name=' + event.target.id + ']').val(ui.value);
                    drawSpectra();
                }
            })
            $('h2.ss').click(function(evt) {
                evt.preventDefault();
                drawSpectra();
            });
            $('#main button, #sidebar button').click(function() {
                $('#overlay, #spinner').show();
            });
            $('#sat').slider('value', 70);
            $('#lum').slider('value', 40);

            $('.ff, .ss').collapseGroup();
            $('.zebra').colStyle();
        });
    </script>
{% endblock %}