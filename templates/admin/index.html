{% extends "admin/base.html" %}

{% block aside %}
	<div class="admin white">
		<h3>Memcache statistics for	v.{{ version() }}</h3>
        <dl class="w65em">
            <dt>hit ratio</dt>
            <dd>
                {{ '%0.1f'|format(hit_ratio) }}%
                ({{ stats.hits }} hits, {{ stats.misses }} misses)
            </dd>
        </dl>
        <dl class="w65em">
            <dt>size</dt>
            <dd>{{ stats['items'] }} items,
                {{ stats.bytes|filesizeformat }}
            </dd>
        </dl>
        <dl class="w65em">
            <dt>oldest item</dt>
            <dd>{{ stats.oldest_item_age }} min</dd>
        </dl>
	</div>
{% endblock %}

{% block contents %}
<article>
	<h2>Site administration</h2>
	<div class="third">
		<div class="admin">
			<h3><a href="/admin/blobs">Photo {{ photo_count }}</a></h3>
			<div id="Photo_tags"></div>
			<div id="Photo_author"></div>
			<div id="Photo_date"></div>
			<div id="Photo_model"></div>
			<div id="Photo_lens"></div>
			<div id="Photo_eqv"></div>
			<div id="Photo_iso"></div>
			<div id="Photo_color"></div>
		</div>
	</div>

	<div class="third">
		<div class="admin">
			<h3><a href="/admin/images">Entry {{ entry_count }}</a></h3>
			<div id="Entry_tags"></div>
			<div id="Entry_author"></div>
			<div id="Entry_date"></div>
		</div>
		
		<div class="admin">
			<h3><a href="/admin/feeds">Feeds {{ feeds_count }}</a></h3>
			<div id="Feed_tags"></div>
		</div>

		<div class="admin">
			<h3><a href="/admin/comments">Comment {{ comment_count }}</a></h3>
			<div id="Comment_forkind"></div>
			<div id="Comment_author"></div>
			<div id="Comment_date"></div>
		</div>
	</div>
    <h2 class="ss" style="clear: both">Spectra [+]</h2>
    <div class="hide">
        <div class="admin">
            <dl class="w65em">
                <dt>Saturation</dt>
                <dd>
                    <div id="sat" class="slider"></div><div style="float: left; width: 1em">&nbsp;</div>
                    <input type="text" name="sat" size="2" disabled="disabled"/>
                </dd>
            </dl>
            <dl class="w65em">
                <dt>Lightness</dt>
                <dd>
                    <div id="lum" class="slider"></div><div style="float: left; width: 1em">&nbsp;</div>
                    <input type="text" name="lum" size="2" disabled="disabled"/>
                </dd>
            </dl>
        </div>
        <div id="spectra"></div>
    </div>
</article>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $(function() {
            function build(key, arr) {
                var tmpl = '', title = key.split('_').pop() + ' cloud';
                if (arr) {
                    tmpl += '<button type="submit" name="delete" value="' + key + '">delete</button>';
                    tmpl += '<h4 class="ff">' + title + ' [+]</h4>';
                    tmpl += '<div class="hide">';
                    $.each(arr, function(i, item) {
                        tmpl += '<dl><dt>' + item.name + '</dt>';
                        tmpl += '<dd>' + item.count + '</dd></dl>';
                    });
                    tmpl += '</div>';
                } else {
                    tmpl += '<button type="submit" name="put" value="' + key + '">create</button>';
                    tmpl += '<h4>' + title + ' [EMPTY]</h4>';
                }
                $('#' + key).html(tmpl);
            }
            $.getJSON('/admin/memcache/', function(data) {
                $.each(data, build);
                $('.ff').collapseGroup();
            });
            $('button').live('click', function() {
                var key = $(this).val(), method = $(this).attr('name');
                $.ajax({
                    url: '/admin/memcache/' + key,
                    type: method,
                    dataType: 'json',
                    success: function(data) {
                        build(key, data);
                        $('.ff').unbind().collapseGroup();
                    }
                });
            });

            var drawSpectra = function() {
                var sat = $('#sat').slider('value');
                var lum = $('#lum').slider('value');

                $.getJSON('/admin/spectra?sat=' + sat + '&lum=' + lum, function(data) {
                    $('#spectra').empty();
                    $.each(data, function(name, colors) {
                        var str = '<div style="clear: both"><span class="item" style="width: 50px;">' + name + '</span>';
                        $.each(colors, function(i, c) {
                            str += '<span class="item" style="background: ' + c + '">&nbsp;</span>';
                        });
                        str += '</div>';
                        $('#spectra').append(str);
                    });
                })
            };
            $('.slider').slider({
                min: 0, max: 100, step: 5,
                change: function(event, ui) {
                    $('input[name=' + event.target.id + ']').val(ui.value);
                    drawSpectra();
                }
            })
            $('h2.ss').click(function() {
                drawSpectra();
            });
            $('#sat').slider('value', 35);
            $('#lum').slider('value', 40);
        });
    </script>
{% endblock %}
