{% extends "admin/base.html" %}
{% block title %}{{ super() }} - {{ _('Add new / change existing photo') }}{% endblock %}

{% block contents %}
    <div class="page">
        {% import "snippets/macros.html" as m %}
        <header>
            <h2>{{ _('Add new / change existing photo') }}</h2>
        </header>
        <article class="port">
            <section>
                {% if form.errors %}
                    <div class="formerrors">
                        <i class="fa fa-exclamation-triangle fa-3x pull-left" style="color: orange"></i>
                        <p>{{ _('Please correct errors in') }}
                        {{ form.errors|join(", ") }}.</p>
                    </div>
                {% endif %}

                {% if upload_url %}
                    <form action="{{ upload_url }}" enctype="multipart/form-data" method="post">
                        <fieldset>
                            <input name="token" type="hidden" value="{{ token }}"/>
                            {{ m.form_row(form.headline) }}
                            {{ m.form_row(form.slug) }}
                            {{ m.form_row(form.tags) }}
                            {{ m.form_row(form.photo) }}
                            <p class="buttons">
                                <span class="required">{{ _('Required field') }}</span>
                                <button type="submit">{{ _('upload') }}</button>
                            </p>
                        </fieldset>
                    </form>
                {% endif %}

                {% if object %}
                    <form action="{{ uri_for('photo_edit', slug=object.key.string_id()) }}" method="post">
                        <div id="palette">
                            <img src="{{ object.small_url_async.get_result() }}"/>
                            <p style="padding: 0.5em 0; text-align: center">
                                <button type="button">{{ _('Calculate palette') }}</button>
                            </p>
                            <table class="palette zebra"></table>
                            <script>
                                var palette_url = '/photos/' + '{{ object.key.string_id() }}' + '/palette';
                            </script>
                        </div>

                        <fieldset>
                            <input name="token" type="hidden" value="{{ token }}"/>
                            {{ m.form_row(form.headline) }}
                            {{ m.form_row(form.tags) }}
                            {% if is_admin %}
                                {{ m.form_row(form.author) }}
                            {% else %}
                                <input type="hidden" name="author" value="{{ object.author.nickname() }}"/>
                            {% endif %}
                        </fieldset>

                        <fieldset>
                            <h3>EXIF {{ _('data') }}</h3>
                            {{ m.form_row(form.model) }}
                            {{ m.form_row(form.lens) }}
                            {{ m.form_row(form.aperture) }}
                            {{ m.form_row(form.shutter) }}
                            {{ m.form_row(form.focal_length) }}
                            {{ m.form_row(form.crop_factor) }}
                            {{ m.form_row(form.iso) }}
                            {{ m.form_row(form.date) }}
                            <p class="buttons">
                                <span class="required">{{ _('Required field') }}</span>
                                <button type="submit">{{ _('done') }}</button>
                            </p>
                        </fieldset>
                    </form>
                {% endif %}
            </section>
            <aside>
                <p>{{ _('Slug uniquely represent record. It must start with letter and may contain only letters, numbers, underscores or hyphens. It is used for URL addresses.') }}</p>
                <p>{{ _('Tags determine record qualification to a group or a type of records. It is comma separated. Use english for wider understanding.') }}</p>
                <p>{{ _('Forward slash is not allowed in any field. It will be stripped out automatically.') }}</p>
                <p><strong>{{ _('Send photo less then') }} 1MB.</strong></p>

                {% if object %}
                    {% include "photo/crops.html" %}
                    <p><strong>{{ _('Date format') }} &quot;yyyy-mm-dd hh:mm:ss&quot;</strong></p>
                {% endif %}
            </aside>
        </article>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="/static/scripts/urlify.min.js"></script>
    <script>
        $(function() {
            $('#headline').slugify();
            $('#tags').multicomplete({
                minLength: 2,
                source: '/complete/Photo_tags'
            });
            $('#lens').autocomplete({
                minLength: 2,
                source: '/complete/Photo_lens'
            });
            $('button[type=submit]').click(function() {
                $('#overlay, #spinner').show();
            });

            var write_palette = function() {
                $.getJSON(palette_url, function(data) {
                    var cntx = $('table.palette');
                    cntx.empty().append('<tr><th>active</th>' +
                        '<td><span class="dot" data-color="[' + data.active.color + ']" style="border-color: ' + data.active.hex + '"></span></td>' +
                        '<th>' + data.active['class'] + '</th></tr>');
                    $.each(data.palette, function(i, pal) {
                        cntx.append('<tr><th>' + pal.prominence + '</th>' +
                            '<td><span class="dot" data-color="[' + pal.color + ']" style="border-color: ' + pal.hex + '"></span></td>' +
                            '<td>' + pal['class'] + '</td></tr>');
                    });
                    if (data.bgcolor) {
                        cntx.append('<tr><th>' + data.bgcolor.prominence + '</th>' +
                            '<td><span class="dot" data-color="[' + data.bgcolor.color + ']" style="border-color: ' + data.bgcolor.hex + '"></span></td>' +
                            '<td>' + data.bgcolor['class'] + '</td></tr>');
                    }
            //        cntx.after('<p>' + explain + '</p>');
                });
            };
            $('button[type=button]').click(function(evt) {
                evt.preventDefault();
                write_palette();
            });
            $('.palette').on('click', '.dot', function() {
                var rgb = $(this).attr('data-color');
                $.post(palette_url, {'rgb': rgb}, function(data) {
                    if (data.success == true) {
                        write_palette();
                    }
                })
            });
            $('.ff').collapseGroup();
        })
    </script>
{% endblock %}
{% block ga %}{% endblock %}