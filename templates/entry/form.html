{% extends "entry/base.html" %}
{% import "snippets/macros.html" as m %}
{% block title %}{{ super() }} - {{ _('Add new / change existing blog') }}{% endblock %}

{% block subnav %}
    {% if object %}
        {% if is_admin or user == object.author %}
            <a class="confirm" href="{{ object.get_absolute_url() }}/delete" title="{{ _('Delete') }}">{{ _('Delete') }}</a>
            <a href="{{ object.get_absolute_url() }}" title="{{ _('Back') }}">{{ _('Back') }}</a>
        {% endif %}
    {% else %}
        <a href="/entries" title="{{ _('Back') }}">{{ _('Back') }}</a>
    {% endif %}
{% endblock %}

{% block head %}
{{ super() }}
<script src="/static/scripts/urlify.js"></script>
<script src="/static/scripts/jquery.autocomplete.js"></script>
<script src="/static/scripts/markitup/jquery.markitup.pack.js"></script>
<script src="/static/scripts/markitup/sets/blog.set_{{ LANGUAGE_CODE }}.js"></script>
<link type="text/css" rel="stylesheet" href="/static/scripts/markitup/skins/simple/style.css"/>
<link type="text/css" rel="stylesheet" href="/static/scripts/markitup/sets/buttons.css"/>
<script>
$(function() {
	$('#headline').slugify();
	$('#body').markItUp(blogSettings, {nameSpace: 'big'});
	$('input, textarea').focusHighlight();
	$('#images img').click(function() {
		src = $(this).attr('src').replace('small', 'normal');
        console.log(src);
		title = $(this).attr('title');
		tab = '    ';
		$.markItUp(
			{replaceWith:'<figure class="left">\n'+tab+'<img src="' + src +
				'" alt="' + title + '"/>\n'+tab+'<p class="legend">' + title + '</p>\n</figure>\n'}
		);
		return false;
	});
	$("#tags").autocomplete("/complete/entry/tags", {
		width: 284,
		selectFirst: false,
		multiple: true,
		matchContains: true
	});
	$('#main button').click(function() {
		$('#overlay, #spinner').show();
	});
});
</script>
{% endblock %}

{% block modals %}
{{ super() }}
<div id="images" class="modal">
	<div class="popup">
		<h4>{{ _('Choose image') }}</h4>
		<a href="#" class="button close" title="{{ _('close') }}">{{ _('close') }}</a>
		<div class="content">
		{% for img in object.image_list %}
			<figure class="left{% if loop.last %} last{% endif %}">
				<img src="/entries/image/{{ img.key.string_id() }}/small"
					alt="{{ img.key.string_id() }}" title="{{ img.name }}"/>
				<p class="legend">{{ img.name|truncate(20) }}</p>
			</figure>
{#		{% empty %}#}
{#			<p>{{ _('No images') }}</p>#}
{#			<p>{{ _('To choose images, you must send them first') }}.</p>#}
		{% endfor %}
		</div>
	</div>
</div>
{% endblock %}

{% block aside %}
	<p>{{ _('Slug uniquely represent record. It must start with letter and may contain only letters, numbers, underscores or hyphens. It is used for URL addresses.') }}</p>
	<p>{{ _('Tags determine record qualification to a group or a type of records. It is comma separated. Use english for wider understanding.') }}</p>
	<p>{{ _('Summary') }} {{ _('A brief presentation in a concise form') }}.</p>
	<p>{{ _('Send images less then') }} 200KB.</p>
{% endblock %}

{% block contents %}
<article class="plain">
	<h2>{{ _('Add new / change existing blog') }}</h2>
	{% if form.errors %}
		<div class="formerrors">
			<p>{{ _('Please correct errors in') }}
            {{ form.errors|join(", ") }}.</p>
		</div>
	{% endif %}
	
	{% if object %}
		<form action="{{ object.get_absolute_url() }}/edit" enctype="multipart/form-data"  method="post">
	{% else %}
		<form action="/entries/add" enctype="multipart/form-data" method="post">
	{% endif %}
		<fieldset>
            {{ m.form_row(form.headline) }}
            {% if not object %}
                {{ m.form_row(form.slug) }}
            {% endif %}
            {{ m.form_row(form.tags) }}
            {{ m.form_row(form.summary) }}
            {{ m.form_row(form.author) }}
            {{ m.form_row(form.date, placeholder='YYYY-mm-dd HH:MM:SS') }}
		</fieldset>
	
		<fieldset>
			<h3>{{ _('Images used in this blog') }}</h3>
            {% if object %}
                {{ m.form_row(form.front, size=1, style='width: auto;') }}
                {% for field in form.images %}
                    <p class="upload" style="background-image: url({{ object.image_url(field.form.num.data) }}/small);">
                        {{ field.form.name.label }} {{ field.form.num(size=1, disabled='disabled') }} {{ field.form.name(size=30) }}
                        {{ field.form.delete }} {{ field.form.delete.label.text }}
                    </p>
                {% endfor %}
            {% endif %}
            {% for field in form.newimages %}
                <p>
                    {{ field.form.name.label }} {{ field.form.name }}<br/>
                    {{ field.form.blob(style='width: 285px;') }}
                    <span class="error C_{{ field.form.name.name }}"><!-- -->{{ field.form.name.errors|join(', ') }}</span>
                </p>
            {% endfor %}
		</fieldset>
	
		<fieldset style="float: none">
            {{ m.form_row(form.body, class='editor', rows=10) }}
			<p class="buttons">
				<span class="required">{{ _('Required field') }}</span>
				<button type="submit">{{ _('done') }}</button>
			</p>
		</fieldset>
	</form>
</article>
{% endblock %}

{% block ga %}{% endblock %}
