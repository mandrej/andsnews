<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<dom-module id="list-view">
  <template>
     <style include="shared-styles">
      :host {
        display: block;
      }
      .square {
        width: calc((100vw - 256px) / 4);
        @apply --layout-vertical;
      }
      iron-image {
        width: 100%;
      }
      iron-image::after {
        content: "";
        display: block;
        padding-bottom: 75%;
      }
      .headline {
        @apply --layout-horizontal;
        @apply --layout-justified;
      }
      .headline > div {
        font-size: 20px;
      }
      .action {
        @apply --layout-horizontal;
        @apply --layout-justified;
        @apply --layout-wrap;
        background-color: var(--light-primary-color);
      }
      @media (max-width: 1024px) { .square { width: calc((100vw - 256px) / 2); }}
      @media (max-width: 768px)  { .square { width: calc(100vw / 2); }}
      @media (max-width: 432px)  { .square { width: 100vw; }}
    </style>

     <app-drawer-layout fullbleed responsive-width="768px">
      <app-drawer swipe-open slot="drawer">
        <app-header fixed>
          <app-toolbar></app-toolbar>
        </app-header>

        <div role="listbox">
          <a class="paper-item-link" href="#/maintenance" tabindex="-1"><paper-item>Maintenance</paper-item></a>
        </div>
      </app-drawer>

      <app-header-layout>
        <app-header condenses reveals effects="resize-title blend-background waterfall" slot="header">
          <app-toolbar>
            <paper-icon-button icon="app:chevron-left" on-tap="goBack"></paper-icon-button>
            <h4 condensed-title>[[value]]</h4>
            <paper-icon-button icon="app:search"></paper-icon-button>
          </app-toolbar>
          <app-toolbar>
            <h1 main-title>[[value]]</h1>
          </app-toolbar>
        </app-header>

        <iron-ajax url="[[_url(field, value)]]" last-response="{{data}}" auto></iron-ajax>

         <iron-list id="list" items="[[data.objects]]" as="rec" scroll-target="document" grid>
          <template>
            <div>
              <div class="square">
                <app-toolbar class="headline">
                  <paper-menu-button>
                    <paper-icon-button icon="app:more-vert" slot="dropdown-trigger"></paper-icon-button>
                    <paper-listbox slot="dropdown-content">
                      <paper-item on-tap="showForm">Edit</paper-item>
                      <paper-item>Remove</paper-item>
                    </paper-listbox>
                  </paper-menu-button>
                  <div>[[rec.headline]]</div>
                </app-toolbar>
                <iron-image src="[[rec.serving_url]]=s0" sizing="cover" on-tap="showView"></iron-image>
                <div class="action">
                  <paper-button hidden$="[[activeFilter('date', rec.year, data.filter)]]"
                    on-tap="applyFilter" data-field="date"
                    data-field-value$="[[rec.year]]">[[rec.year]]</paper-button>
                  <template is="dom-repeat" items="[[rec.tags]]" as="tag">
                    <paper-button hidden$="[[activeFilter('tags', tag, data.filter)]]"
                      on-tap="applyFilter" data-field="tags"
                      data-field-value$="[[tag]]">[[tag]]</paper-button>
                  </template>
                  <!-- <paper-button hidden$="[[activeFilter('model', rec.model, data.filter)]]"
                    on-tap="applyFilter" data-field="model"
                    data-field-value$="[[rec.model]]">[[rec.model]]</paper-button>  -->
                  <paper-button hidden$="[[activeFilter('color', rec.color, data.filter)]]"
                    on-tap="applyFilter" data-field="color"
                    data-field-value$="[[rec.color]]">[[rec.color]]</paper-button>
                </div>
              </div>
            </div>
          </template>
        </iron-list>
       </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    class ListView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'list-view'; }
      static get properties() {
        return {
          data: Array,
          route: Object
        };
      }
      _url(field, value) {
        const rx = /^\/list/;
        if (rx.test(this.route.path)) {
          this.data = [];
          return ['/api/photo', field, value].join('/');
        }
      }
      showView(e) {
        window.location = e.target.src;
      }
      showForm(e) {
        this.set('route.path', ['/edit', e.model.rec.safekey].join('/'));
      }
      activeFilter(field, value, filter) {
        return (filter.field === field && filter.value === value);
      }
      applyFilter(e) {
        const target = e.target,
          field = target.dataset.field,
          value = target.dataset.fieldValue;
        this.set('route.path', ['/list', field, value].join('/'));
      }
      goBack() {
        this.set('route.path', '/start');
      }
    }

    window.customElements.define(ListView.is, ListView);
  </script>
</dom-module>
