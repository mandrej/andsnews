<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="list-view">
  <template>
     <style include="shared-styles">
      :host {
        display: block;
      }
      iron-list {
        padding: calc(var(--user-gap) / 2);
      }
      .square {
        width: calc((var(--user-width) - var(--user-gap)) / 4);
        box-sizing: border-box;
        padding: calc(var(--user-gap) / 2);
      }
      iron-image {
        width: 100%;
      }
      iron-image::after {
        content: "";
        display: block;
        padding-bottom: 100%;
      }
      .headline {
        padding: 0 16px;
        @apply --layout-horizontal;
        background-color: #fff;
      }
      .nopadding {
        padding-left: 0;
      }
      .headline > div {
        font-size: 20px;
        line-height: 110%;
        font-weight: 300;
      }
      .action {
        @apply --layout-horizontal;
        @apply --layout-wrap;
        padding: calc(var(--user-gap) / 2) 0;
      }
      @media (max-width: 1024px) { .square { width: calc((100vw - var(--user-gap)) / 3); }}
      @media (max-width: 768px)  { .square { width: calc((100vw - var(--user-gap)) / 2); }}
      @media (max-width: 432px)  { .square { width: calc(100vw - var(--user-gap)); }}
    </style>

    <paper-dialog id="message"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation">
      <h2>No items found</h2>
      <p>Please try again</p>
    </paper-dialog>

    <paper-dialog id="deleteDialog" modal
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      on-iron-overlay-closed="deleteRecord">
      <h2>Are you sure?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>OK</paper-button>
      </div>
    </paper-dialog>

    <app-header-layout class="big" fullbleed>
      <app-header condenses reveals shadow effects="resize-title blend-background waterfall" slot="header">
        <app-toolbar>
          <paper-icon-button icon="arrow-back" on-tap="goBack"></paper-icon-button>
          <h4 condensed-title>[[value]] ([[count]])</h4>
          <paper-spinner active$="[[loading]]"></paper-spinner>
        </app-toolbar>
        <app-toolbar>
          <h1 main-title>[[value]]</h1>
          <paper-icon-button icon="search" on-tap="findForm"></paper-icon-button>
        </app-toolbar>
      </app-header>

      <iron-ajax id="ajax" auto
        url="[[_url(field, value)]]"
        params="{{params}}"
        loading="{{loading}}"
        on-response="handler"></iron-ajax>

      <iron-ajax id="delete_ajax" method="DELETE"></iron-ajax>

      <iron-list id="list" items="{{records}}" as="rec" scroll-target="document" grid>
        <template>
          <div>
            <div class="square">
              <div class$="layout horizontal {{noPad(isAuthorized)}}">
                <paper-menu-button hidden$="{{!isAuthorized}}">
                  <paper-icon-button icon="more-vert" slot="dropdown-trigger"></paper-icon-button>
                  <paper-listbox slot="dropdown-content">
                    <paper-item on-tap="showForm">Edit</paper-item>
                    <paper-item on-tap="showDialog">Remove</paper-item>
                  </paper-listbox>
                </paper-menu-button>
                <div class="self-center">[[rec.headline]]</div>
              </div>
              <div style="position:relative">
                <iron-image src="[[checkImage(rec)]]"
                  preload fade
                  sizing="cover" on-tap="showView"></iron-image>
                <paper-ripple></paper-ripple>
              </div>
              <div class="action">
                <paper-chip hidden$="[[activeFilter('date', rec.year, filter)]]"
                  on-tap="applyFilter" data-field="date"
                  data-field-value$="[[rec.year]]" label="[[rec.year]]"></paper-chip>
                <template is="dom-repeat" items="[[rec.tags]]" as="tag">
                  <paper-chip hidden$="[[activeFilter('tags', tag, filter)]]"
                    on-tap="applyFilter" data-field="tags"
                    data-field-value$="[[tag]]" label="[[tag]]"></paper-chip>
                </template>
                <paper-chip hidden$="[[activeFilter('model', rec.model, filter)]]"
                  on-tap="applyFilter" data-field="model"
                  data-field-value$="[[rec.model]]" label="[[rec.model]]"></paper-chip>
                <paper-chip hidden$="[[activeFilter('color', rec.color, filter)]]"
                  on-tap="applyFilter" data-field="color"
                  data-field-value$="[[rec.color]]" label="[[rec.color]]"></paper-chip>
              </div>
            </div>
          </div>
        </template>
      </iron-list>
    </app-header-layout>

    <iron-scroll-threshold id="scrollTheshold"
      lower-threshold="500"
      on-lower-threshold="_load"
      scroll-target="document"></iron-scroll-threshold>
  </template>

  <script>
    class ListView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'list-view'; }
      static get properties() {
        return {
          params: { type: Object, value: {}, notify: true },
          filter: { type: Object, value: {}, notify: true },
          records: { type: Array, value: [], notify: true },
          count: { type: Number, value: 0 },
          obj: { type: Object, notify: true },
          route: Object,
          currentIndex: { type: Number, value: 0, notify: true }
        };
      }
      static get observers() {
        return [
          '_getCount(records.length)'
        ]
      }
      _url(field, value) {
        this.records = [];
        this.filter = {};
        this.set('params._page', null);

        const rx = /^\/list/;
        if (rx.test(this.route.path)) {
          if (field === 'search') {
            return ['/api/search', value].join('/');
          } else {
            return ['/api/photo', field, value].join('/');
          }
        }
      }
      handler(e) {
        const data = e.detail.response,
          dialog = this.$.message;

        if (!data.objects) return;
        if (data.objects.length === 0) {
          dialog.open();
          this.records = [];
          this.filter = {};
          this.set('params._page', null);
        } else {
          data.objects.forEach((item) => {
            this.push('records', item);
          });
          this.filter = {};
          if (data.filter) {
            this.filter = data.filter;
          }
          this.$.scrollTheshold.clearTriggers();
        }
      }
      _load() {
        const ajax = this.$.ajax;
        if (ajax.lastResponse && ajax.lastResponse._next) {
          this.set('params._page', ajax.lastResponse._next);
        }
      }
      _getCount(count) {
        this.count = count;
      }
      checkImage(rec) {
        if (rec.serving_url) return rec.serving_url + '=s400-c';
      }
      showView(e) {
        const top = window.pageYOffset;
        this.dispatchEvent(new CustomEvent('kick', {bubbles: true, composed: true, detail: {top: top}}));
        this.set('route.path', ['/item', e.model.rec.safekey].join('/'));
      }
      showForm(e) {
        const top = window.pageYOffset;
        this.dispatchEvent(new CustomEvent('kick', {bubbles: true, composed: true, detail: {top: top}}));
        this.set('route.path', ['/edit', e.model.rec.safekey].join('/'));
      }
      activeFilter(field, value, filter) {
        if (filter) {
          return (filter.field === field && filter.value === value);
        } else {
          return false;
        }
      }
      applyFilter(e) {
        const target = e.target,
          field = target.dataset.field,
          value = target.dataset.fieldValue;
        this.set('route.path', ['/list', field, value].join('/'));
      }
      showDialog(e) {
        this.currentIndex = e.model.index;
        this.$.deleteDialog.open();
      }
      deleteRecord(e) {
        if (e.detail.confirmed) {
          const obj = this.splice('records', this.currentIndex, 1)[0];
          // this.currentIndex = -1;
          const xhr = this.$.delete_ajax;
          xhr.url = '/api/delete/' + obj.safekey;
          xhr.generateRequest();
        }
      }
      findForm() {
        this.set('route.path', '/search');
      }
      noPad(pass) {
        return (pass) ? 'headline nopadding' : 'headline';
      }
      goBack() {
        this.set('route.path', '/start');
      }
    }

    window.customElements.define(ListView.is, ListView);
  </script>
</dom-module>
