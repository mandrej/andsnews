<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html">
<link rel="import" href="../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<dom-module id="search-view">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        @apply --layout-vertical;
        @apply --layout-fit;
        margin: 64px auto 0 auto;
        max-width: var(--max-width);
      }
      .container {
        @apply --layout-flex;
        margin: var(--user-gap) calc(-1 * var(--user-gap)) 0;
        padding: var(--user-gap) var(--user-gap) 0 0;
      }
      .buttons {
        @apply --layout-horizontal;
        @apply --layout-end-justified;
      }
      .long {
        padding: 0 0 var(--user-gap) var(--user-gap);
      }
      .fields {
        @apply --layout-horizontal;
        @apply --layout-justified;
        @apply --layout-wrap;
      }
      .fields * {
        width: calc(100% / 3);
        height: 80px;
        padding: 0 0 var(--user-gap) var(--user-gap);
        box-sizing: border-box;
      }
      vaadin-combo-box {
        margin-top: -8px;
      }
      @media (max-width: 1200px) { .container { margin: 0; }}
      @media (max-width: 768px)  { .fields * { width: 50%; }}
      @media (max-width: 432px)  { .fields * { width: 100%; }}
    </style>

    <app-localstorage-document key="search" data="{{search}}"></app-localstorage-document>

    <iron-ajax auto
      url="/api/suggest/Photo_tags" on-response="listTags"></iron-ajax>
    <iron-ajax auto
      url="/api/suggest/Photo_model" on-response="listModels"></iron-ajax>

    <app-header fixed slot="header">
      <app-toolbar>
        <paper-icon-button icon="arrow-back" on-tap="goHome"></paper-icon-button>
        <h1 main-title>Find</h1>
      </app-toolbar>
    </app-header>

    <div class="container">
      <iron-form id="findForm">
        <form method="get">
          <div class="buttons">
            <paper-button on-tap="onClear" raised>Clear</paper-button>
            <paper-button on-tap="onSubmit" raised>Find</paper-button>
          </div>
          <div class="long">
            <paper-chip-input-autocomplete name="find_tags" label="by tags" id="tags"
              closable
              items="{{search.tags}}"
              source="[[tags]]"></paper-chip-input-autocomplete>
          </div>
          <div class="fields">
            <paper-input name="find_text" label="by text" value="{{search.find_text}}"></paper-input>
            <paper-input name="find_year" label="in year" type="number" value="{{search.find_year}}"
              auto-validate min="2007" max$="[[year()]]" error-message$="2007 - [[year()]]">></paper-input>
            <paper-input name="find_month" label="in month" type="number" value="{{search.find_month}}"
              auto-validate min="1" max="12" error-message="1 - 12"></paper-input>
            <vaadin-combo-box name="find_model" label="by camera" id="models"
              value="{{search.find_model}}"
              items="[[models]]"></vaadin-combo-box>
            <vaadin-combo-box name="find_author" label="by author"
              value="{{search.find_author}}"
              items='["milan", "mihailo", "genije", "svetlana", "andrejevic", "ana", "devic", "dannytaboo", "zile", "zikson"]'></vaadin-combo-box>
            <vaadin-combo-box name="find_color" label="by color"
              value="{{search.find_color}}"
              items='["red", "orange", "yellow", "green", "blue", "violet", "dark", "medium", "light"]'></vaadin-combo-box>
          </div>
        </form>
      </iron-form>
    </div>
    <footer class="footer"><app-toolbar><h4 condensed-title>[[copy]]</h4></app-toolbar></footer>
  </template>

  <script>
    class SearchView extends Polymer.Element {
      static get is() { return 'search-view'; }
      static get properties() {
        return {
          filters: { type: Array, value:[], notify: true },
          tags: { type: Array, value:[], notify: true },
          models: { type: Array, value:[], notify: true },
          search: { type: Object, value: {}, notify: true },
        };
      }
      connectedCallback() {
        super.connectedCallback();
        this.search = {
          tags: [],
          find_text: '',
          find_year: '',
          find_month: '',
          find_model: '',
          find_author: '',
          find_color: ''
        };
        this.$.findForm.addEventListener('iron-form-submit', e => this._submit(e));
      }
      disconnectedCallback() {
        super.disconnectedCallback();
        this.removeEventListener('iron-form-submit', this._submit);
      }
      listTags(e) {
        e.detail.response.forEach((tag) => {
          this.push('tags', {text: tag, value: tag});
        });
      }
      listModels(e) {
        e.detail.response.forEach((model) => {
          this.push('models', model);
        });
      }
      onSubmit(e) {
        this.$.findForm.submit();
      }
      onClear() {
        this.$.tags.items = [];
        this.search = {
          tags: [],
          find_text: '',
          find_year: '',
          find_month: '',
          find_model: '',
          find_author: '',
          find_color: ''
        };
        this.$.findForm.reset();
      }
      _submit(e) {
        let params = [];
        this.$.tags.items.forEach((tag) => {
          params.push('tags:' + tag);
        })
        if (e.detail.find_text) {
          params.push(e.detail.find_text);
        }
        if (e.detail.find_year) {
          params.push('year:' + e.detail.find_year);
        }
        if (e.detail.find_month) {
          params.push('month:' + e.detail.find_month);
        }
        if (e.detail.find_model) {
          params.push('model:' + e.detail.find_model);
        }
        if (e.detail.find_author) {
          params.push('author:' + e.detail.find_author);
        }
        if (e.detail.find_color) {
          params.push('color:' + e.detail.find_color);
        }

        const find = params.join(' AND ');
        if (find) {
          this.set('route.path', ['/list/search', find].join('/'));
        }
      }
      year() {
        const now = new Date();
        return now.getFullYear();
      }
      goHome() {
        this.set('route.path', '/list/all');
      }
    }

    window.customElements.define(SearchView.is, SearchView);
  </script>
</dom-module>
