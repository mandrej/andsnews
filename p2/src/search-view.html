<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/resize-title.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="../bower_components/app-layout/app-grid/app-grid-style.html">

<dom-module id="search-view">
  <template>
    <style include="shared-styles app-grid-style">
      :host {
        display: block;
      }
      iron-form {
        /* @apply --layout-flex; */
      }
      .container {
        /* padding-bottom: 0; */
      }
      ul {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .app-grid {
        --app-grid-columns: 3;
        --app-grid-gutter: 16px;
      }
      .right {
        text-align: right;
        @apply --app-grid-expandible-item;
      }
      @media (max-width: 768px)  { .app-grid { --app-grid-columns: 2; }}
      @media (max-width: 432px)  { .app-grid { --app-grid-columns: 1; }}
    </style>

    <iron-ajax url="/api/suggest/Photo_tags" on-response="listTags" id="ajax_tags"></iron-ajax>
    <iron-ajax url="/api/suggest/Photo_model" on-response="listModels" id="ajax_model"></iron-ajax>

    <app-header-layout fullbleed>
      <app-header condenses reveals shadow effects="resize-title" slot="header">
        <app-toolbar>
          <paper-icon-button icon="arrow-back" on-tap="goBack"></paper-icon-button>
          <h4 condensed-title>Find</h4>
        </app-toolbar>
        <app-toolbar>
          <h1 main-title>Find</h1>
        </app-toolbar>
      </app-header>

      <div class="container">
        <iron-form id="findForm">
            <form method="get">
              <ul class="app-grid">
                <li class="item right">
                    <paper-button on-tap="onSubmit" raised>Find</paper-button>
                </li>
                <li class="item">
                  <paper-input name="find_text" label="by text"></paper-input>
                </li>
                <li class="item">
                  <paper-chip-input-autocomplete name="find_tags" label="by tags" id="tags"
                    closable
                    items="[[item.tags]]"
                    source="[[tags]]"></paper-chip-input-autocomplete>
                </li>
                <li class="item">
                  <paper-input name="find_year" label="in year" type="number"
                    auto-validate min="2008" max="2017" error-message="2008 - 2017">></paper-input>
                </li>
                <li class="item">
                  <paper-input name="find_month" label="in month" type="number"
                    auto-validate min="1" max="12" error-message="1 - 12"></paper-input>
                </li>
                <li class="item">
                  <vaadin-combo-box name="find_model" label="by camera" id="models"
                    auto-validate
                    allow-custom-value="false"
                    items="[[models]]"></vaadin-combo-box>
                </li>
                <li class="item">
                  <vaadin-combo-box name="find_author" label="by author"
                    auto-validate
                    allow-custom-value="false"
                    items='["milan", "mihailo", "genije", "svetlana", "andrejevic", "ana", "devic", "dannytaboo", "zile", "zikson"]'></vaadin-combo-box>
                </li>
                <li class="item">
                  <vaadin-combo-box name="find_color" label="by color"
                    auto-validate
                    allow-custom-value="false"
                    items='["red", "orange", "yellow", "green", "blue", "violet", "dark", "medium", "light"]'></vaadin-combo-box>
                </li>
              </ul>
             </form>
          </iron-form>
      </div>

      <footer><slot name="copy"></slot></footer>
    </app-header-layout>
  </template>

  <script>
    class SearchView extends Polymer.Element {
      static get is() { return 'search-view'; }
      static get properties() {
        return {
          filters: { type: Array, value:[], notify: true },
          tags: { type: Array, value:[], notify: true },
          models: { type: Array, value:[], notify: true },
        };
      }
      connectedCallback() {
        super.connectedCallback();
        this.$.tags.addEventListener('focus', (e) => this._getTags(e));
        this.$.models.addEventListener('focus', (e) => this._getModels(e));
        this.$.findForm.addEventListener('iron-form-submit', (e) => this._submit(e));
      }
      _url(path) {
        if (path === '/search') return '/api/filters';
      }
      _getTags(e) {
        if (this.tags.length === 0) {
          this.$.ajax_tags.generateRequest();
        }
      }
      _getModels(e) {
        if (this.models.length === 0) {
          this.$.ajax_model.generateRequest();
        }
      }
      listTags(e) {
        e.detail.response.forEach((tag) => {
          this.push('tags', {text: tag, value: tag});
        });
      }
      listModels(e) {
        e.detail.response.forEach((model) => {
          this.push('models', model);
        });
      }
      onSubmit(e) {
        this.$.findForm.submit();
      }
      _submit(e) {
        let params = [];
        if (e.detail.find_text) {
          params.push(e.detail.find_text)
        }
        this.$.tags.items.forEach((tag) => {
          params.push('tags:' + tag)
        })
        if (e.detail.find_year) {
          params.push('year:' + e.detail.find_year)
        }
        if (e.detail.find_month) {
          params.push('month:' + e.detail.find_month)
        }
        if (e.detail.find_model) {
          params.push('model:' + e.detail.find_model)
        }
        if (e.detail.find_author) {
          params.push('author:' + e.detail.find_author)
        }
        if (e.detail.find_color) {
          params.push('color:' + e.detail.find_color)
        }
        const find = params.join(' AND ');
        if (find) {
          this.set('route.path', ['/list/search', find].join('/'));
        }
      }
      goBack() {
        this.set('route.path', '/list');
      }
    }

    window.customElements.define(SearchView.is, SearchView);
  </script>
</dom-module>
