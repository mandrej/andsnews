<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<dom-module id="app-auth">
  <template>
    <style>
      :host {
        display: block
      }
      .sign {
        margin-left: 12px;
        padding: 1px;
        --iron-icon: {
          border-radius: 50%;
          overflow: hidden;
        }
      }
    </style>

    <firebase-auth id="auth"
      app-name="andsnews"
      user="{{user}}"
      online="{{online}}"
      signed-in="{{signedIn}}"
      provider="google"></firebase-auth>

    <app-localstorage-document key="state" data="{{state}}"></app-localstorage-document>

    <span>[[signText(state.isAuthorized)]]</span>
    <paper-icon-button id="sign" class="sign" on-tap="signHandler"></paper-icon-button>
  </template>

  <script>
    class AppAuth extends Polymer.Element {
      static get is() { return 'app-auth'; }
      static get properties() {
        return {
          state: { type: Object, value: {}, notify: true },
          admins: { type: Array, value: [
            'j8ezW5PBwMMnzrUvDA9ucYOOmrD3',       // milan
            'vlRwHqVZNfOpr3FRqQZGqT2M2HA2'] },    // mihailo
        };
      }
      connectedCallback() {
        super.connectedCallback();
        this.state = {
          name: null,
          email: null,
          uid: null,
          isAuthorized: false,
          isAdmin: false
        }
      }
      static get observers() {
        return [
          '_getUser(state.isAuthorized, user.photoURL)',
          '_checkNet(online)',
        ]
      }
      signHandler() {
        if (this.user) {
          this.$.auth.signOut();
          this.state = {
            name: null,
            email: null,
            uid: null,
            isAuthorized: false,
            isAdmin: false
          };
        } else {
          this.$.auth.signInWithPopup()
            .then(response => {
              this.state = {
                name: response.user.displayName,
                email: response.user.email,
                uid: response.user.uid,
                isAuthorized: true,
                isAdmin: (this.admins.indexOf(response.user.uid) !== -1)
              }
            }).catch(function (error) {
              console.log(error);
            });
        }
      }
      _getUser(isAuthorized, url) {
        this.$.sign.src = (isAuthorized && url) ? url : '../images/google_g_logo.svg';
      }
      _checkNet(online) {
        this.dispatchEvent(new CustomEvent('online', {bubbles: true, composed: true, detail: online}));
      }
      signText(isAuthorized) {
        return (isAuthorized) ? 'sign-off' : 'sign-in';
      }
    }

    window.customElements.define(AppAuth.is, AppAuth);
  </script>
</dom-module>
