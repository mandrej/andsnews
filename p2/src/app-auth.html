<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<dom-module id="app-auth">
  <template>
    <style>
      :host {
        display: block
      }
      .sign {
        padding: 1px;
        --iron-icon: {
          border-radius: 50%;
          overflow: hidden;
        }
      }
    </style>

    <firebase-auth id="auth"
      app-name="andsnews"
      user="{{user}}"
      online="{{online}}"
      signed-in="{{isAuthorized}}"
      provider="google"></firebase-auth>

    <app-localstorage-document key="state" data="{{state}}"></app-localstorage-document>

    <paper-icon-button id="sign" class="sign" on-tap="signHandler"></paper-icon-button>
  </template>

  <script>
    class AppAuth extends Polymer.Element {
      static get is() { return 'app-auth'; }
      static get properties() {
        return {
          state: { type: Object, notify: true },
          admins: { type: Array, value: [
            'j8ezW5PBwMMnzrUvDA9ucYOOmrD3',       // milan
            'vlRwHqVZNfOpr3FRqQZGqT2M2HA2'] },    // mihailo
        };
      }
      static get observers() {
        return [
          '_getUser(user)',
          '_checkNet(online)',
        ]
      }
      signHandler() {
        if (this.user) {
          this.$.auth.signOut();
          this.state = {
            name: null,
            email: null,
            isAuthorized: this.isAuthorized,
            isAdmin: false
          };
          this.$.sign.src = '../images/google_g_logo.svg';
        } else {
          this.$.auth.signInWithPopup()
            .then((response) => {
              this.state = {
                name: response.user.displayName,
                email: response.user.email,
                isAuthorized: this.isAuthorized,
                isAdmin: (this.admins.indexOf(response.user.uid) !== -1)
              }
              this.$.sign.src = response.user.photoURL;
            }).catch(function (error) {
              console.log(error);
            });
        }
      }
      _getUser(user) {
        if (user) {
          this.state = {
            name: this.user.displayName,
            email: this.user.email,
            isAuthorized: this.isAuthorized,
            isAdmin: (this.admins.indexOf(this.user.uid) !== -1)
          };
          this.$.sign.src = this.user.photoURL;
        } else {
          this.state = {
            name: null,
            email: null,
            isAuthorized: false,
            isAdmin: false
          };
          this.$.sign.src = '../images/google_g_logo.svg';
        }
      }
      _checkNet(online) {
        this.dispatchEvent(new CustomEvent('online', {bubbles: true, composed: true, detail: online}));
      }
    }

    window.customElements.define(AppAuth.is, AppAuth);
  </script>
</dom-module>
