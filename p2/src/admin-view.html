<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="admin-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      .container {
        padding: 16px;
      }
      h1 {
        margin-bottom: 0.5em;
        font-weight: 300;
      }
      paper-button {
        min-width: 175px;
        margin-bottom: 16px;
      }
      paper-button[disabled],
      paper-button[toggles][active] {
        background: var(--secondary-text-color);
      }
    </style>

    <firebase-messaging id="messaging"
      app-name="andsnews"
      token="{{token}}"
      on-message="handleMessage"></firebase-messaging>

    <firebase-document
      log="true"
      app-name="andsnews"
      path="/users/[[user.uid]]/token"
      data="[[token]]"></firebase-document>

    <iron-ajax auto
      url="[[_url(isAuthorized)]]"
      last-response="{{info}}"></iron-ajax>

    <iron-ajax id="xhr"
      content-type="application/json"
      method="POST"></iron-ajax>

    <app-header-layout>
      <app-header fixed slot="header">
        <app-toolbar>
          <paper-icon-button icon="chevron-left" on-tap="goBack"></paper-icon-button>
          <h1 main-title>Admin v. [[version]]</h1>
        </app-toolbar>
      </app-header>

      <div class="container">
        <paper-toast id="toast"></paper-toast>

        <div hidden$="[[!isAuthorized]]" class="layout vertical wrap">
          <div>
            <h1>Photo [[info.photo.count]]</h1>
            <div class="layout horizontal justified wrap">
              <template is="dom-repeat" items="[[info.photo.counters]]" as="item">
                <paper-button on-tap="rebuild" class="accent" toggles raised>[[item]]</paper-button>
              </template>

              <paper-button on-tap="reindex" data-kind="photo" toggles raised>Photo Reindex</paper-button>
              <paper-button disabled on-tap="unbound" data-kind="photo" toggles raised>Photo Unbound</paper-button>
              <paper-button disabled on-tap="fix" data-kind="photo" toggles raised>Migration</paper-button>
            </div>
          </div>
        </div>
      </div>
    </app-header-layout>
  </template>

  <script>
    class AdminView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'admin-view'; }
      static get properties() {
        return {

        };
      }
      _url(isAuthorized) {
        const rx = /^\/maintenance/;
        if (rx.test(this.route.path) && isAuthorized) {
          return '/api/info';
        }
      }
      handleMessage(e) {
        // console.log(arguments);
        const toast = this.$.toast;
        toast.setAttribute('text', e.detail.message.notification.body);
        toast.open();
      }
      callAjax(url) {
        const xhr = this.$.xhr;
        this.$.messaging.requestPermission().then(function () {
          xhr.url = url;
          xhr.body = JSON.stringify({ token: this.token });
          xhr.generateRequest();
        }.bind(this), function (err) {
          console.log(err);
        });
      }
      rebuild(e) {
        this.callAjax('/api/rebuild/' + e.model.item);
      }
      reindex(e) {
        this.callAjax('/api/index/' + e.target.dataset.kind);
      }
      unbound(e) {
        this.callAjax('/api/unbound/' + e.target.dataset.kind);
      }
      fix(e) {
        this.callAjax('/api/fix/' + e.target.dataset.kind);
      }
      goBack() {
        window.history.go(-1);
      }
    }

    window.customElements.define(AdminView.is, AdminView);
  </script>
</dom-module>
