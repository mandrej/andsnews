<link rel="import" href="../bower_components/polymerfire/firebase-messaging.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="admin-view">
  <template>
    <style include="shared-styles iron-flex">
      :host {
        @apply --layout-vertical;
        @apply --layout-fit;
        margin: 64px auto 0 auto;
        max-width: var(--max-width);
      }
      .container {
        @apply --layout-flex;
        margin: var(--user-gap) calc(-1 * var(--user-gap)) 0;
        padding: var(--user-gap);
      }
      h1 {
        margin-bottom: 0.5em;
        font-weight: 300;
      }
      .actions {
        @apply --layout-horizontal;
        @apply --layout-justified;
        @apply --layout-wrap;
      }
      paper-button {
        min-width: 175px;
        margin-bottom: 16px;
      }
      paper-button[disabled] {
        color: var(--disabled-text-color);
      }
      @media (max-width: 1200px) { .container { margin: 0; }}
    </style>

    <app-localstorage-document key="state" data="{{state}}"></app-localstorage-document>

    <firebase-messaging id="messaging"
      app-name="andsnews"
      token="{{token}}"
      on-message="handleMessage"></firebase-messaging>

    <firebase-document
      app-name="andsnews"
      path="/users/[[state.uid]]"
      data="{{fbData}}"></firebase-document>

    <iron-ajax auto
      url="[[_url(route.path)]]"
      last-response="{{info}}"></iron-ajax>

    <iron-ajax id="xhr"
      content-type="application/json"
      method="POST"></iron-ajax>

    <app-header fixed slot="header">
      <app-toolbar>
        <paper-icon-button icon="arrow-back" on-tap="goHome"></paper-icon-button>
        <h1 main-title>Maintenance</h1>
      </app-toolbar>
    </app-header>

    <div class="container">
      <paper-toast id="toast"></paper-toast>

      <template is="dom-if" if="[[state.isAdmin]]" restamp>
        <h1>Photo [[info.photo.count]]</h1>
        <div class="actions">
          <template is="dom-repeat" items="[[info.photo.counters]]" as="item">
            <paper-button on-tap="rebuild" toggles raised>[[item]]</paper-button>
          </template>
          <paper-button on-tap="reindex" data-kind="photo" toggles raised>Photo Reindex</paper-button>
          <paper-button on-tap="fix" data-kind="photo" toggles raised>Deleted</paper-button>
          <paper-button on-tap="unbound" data-kind="photo" toggles raised>Photo Unbound</paper-button>
        </div>
      </template>
      <template is="dom-if" if="[[!state.isAdmin]]">
        <h2>Authorization Required</h2>
        <p>Go <a href="/list/all">Home</a> and Sign-In with your Google Account</p>
      </template>
    </div>
    <footer class="footer"><app-toolbar><h4 condensed-title>[[copy]]</h4></app-toolbar></footer>
  </template>

  <script>
    class AdminView extends Polymer.Element {
      static get is() { return 'admin-view'; }
      static get properties() {
        return {
          fbData: Object
        };
      }
      static get observers() {
        return [
          'userData(state.email)'
        ]
      }
      userData(email) {
        const d = new Date();
        if (email) {
          this.fbData = {
            email: email,
            date: d.toISOString(),
            token: this.token
          }
        }
      }
      _url(path) {
        if (/^\/admin/.test(path)) {
          return '/api/info';
        }
      }
      handleMessage(e) {
        // console.log(arguments);
        const toast = this.$.toast;
        toast.setAttribute('text', e.detail.message.notification.body);
        toast.open();
      }
      callAjax(url) {
        const xhr = this.$.xhr;
        this.$.messaging.requestPermission().then(() => {
          xhr.url = url;
          xhr.body = JSON.stringify({ token: this.token });
          xhr.generateRequest();
        }, (err) => {
          console.log(err);
        });
      }
      rebuild(e) {
        this.callAjax('/api/rebuild/' + e.model.item);
      }
      reindex(e) {
        this.callAjax('/api/index/' + e.target.dataset.kind);
      }
      unbound(e) {
        this.callAjax('/api/unbound/' + e.target.dataset.kind);
      }
      fix(e) {
        this.callAjax('/api/fix/' + e.target.dataset.kind);
      }
      goHome() {
        this.set('route.path', '/list/all');
      }
    }

    window.customElements.define(AdminView.is, AdminView);
  </script>
</dom-module>
