<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/resize-title.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html">

<dom-module id="edit-view">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        @apply --layout-vertical;
        @apply --layout-fit;
        margin: 128px auto 0 auto;
        max-width: var(--max-width);
      }
      .container {
        @apply --layout-flex;
        margin: var(--user-gap) calc(-1 * var(--user-gap)) 0;
        padding: var(--user-gap) var(--user-gap) 0 0;
      }
      .buttons {
        margin-left: var(--user-gap);
        padding: 100px 0 0;
        @apply --layout-horizontal;
        @apply --layout-end-justified;
        background-repeat: no-repeat;
        background-size: auto 100%;
        background-position: 0% 50%;
      }
      .long {
        padding: 0 0 var(--user-gap) var(--user-gap);
      }
      .fields {
        @apply --layout-horizontal;
        @apply --layout-justified;
        @apply --layout-wrap;
      }
      .fields * {
        width: calc(100% / 3);
        height: 80px;
        padding: 0 0 var(--user-gap) var(--user-gap);
        box-sizing: border-box;
      }
      @media (max-width: 1200px) { .container { margin: var(--user-gap) 0; }}
      @media (max-width: 768px)  { .fields * { width: 50%; }}
      @media (max-width: 432px)  { .fields * { width: 100%; }}
    </style>

    <iron-ajax auto
      url="[[_url(safekey, current)]]"
      last-error="{{error}}"
      last-response="{{item}}"></iron-ajax>
    <iron-ajax url="/api/suggest/Photo_tags" on-response="listTags" id="ajax_tags"></iron-ajax>

    <app-header condenses reveals effects="resize-title" slot="header">
      <app-toolbar>
        <paper-icon-button icon="arrow-back" on-tap="goBack"></paper-icon-button>
        <h4 condensed-title>[[title]]</h4>
      </app-toolbar>
      <app-toolbar>
        <h1 main-title>[[title]]</h1>
      </app-toolbar>
    </app-header>

    <div class="container">
      <div hidden$="[[!pass]]">
        <iron-form id="editForm">
          <form action$="/api/[[item.kind]]/edit/[[item.safekey]]" method="put">

            <paper-toast id="toast" on-iron-overlay-closed="goBack"></paper-toast>

            <div class="buttons" style="background-image: url([[item.serving_url]]=s400-c)">
              <paper-button on-tap="_submit" raised>Submit</paper-button>
            </div>

            <div class="long">
              <paper-input name="headline" required label="headline" value="{{item.headline}}"></paper-input>
              <paper-chip-input-autocomplete name="tags" label="tags" id="tags"
                closable
                additional-items
                items="[[item.tags]]"
                source="[[tags]]"></paper-chip-input-autocomplete>
            </div>

            <div class="fields">
              <vaadin-combo-box name="author" required label="author"
                auto-validate
                allow-custom-value="true"
                items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'
                value="[[item.author]]"></vaadin-combo-box>
              <paper-input name="date" label="date" value="[[item.date]]"></paper-input>
              <paper-input name="model" label="model" value="[[item.model]]"></paper-input>
              <paper-input name="lens" label="lens" value="[[item.lens]]"></paper-input>
              <paper-input name="focal_length" label="focal_length [mm]" value="[[item.focal_length]]"></paper-input>
              <paper-input name="iso" label="iso [ASA]" value="[[item.iso]]"></paper-input>
              <paper-input name="aperture" label="aperture" value="[[item.aperture]]"></paper-input>
              <paper-input name="shutter" label="shutter [s]" value="[[item.shutter]]"></paper-input>
              <paper-input disabled label="color" value="[[item.color]]"></paper-input>
            </div>
          </form>
        </iron-form>
      </div>
      <div hidden$="[[pass]]" style="padding: 16px">
        <p>Go <a href="/list/all">Home</a> and Sign-In with your Google Account</p>
      </div>
    </div>
    <footer class="footer"><app-toolbar><h4 condensed-title>[[copy]]</h4></app-toolbar></footer>
  </template>

  <script>
    class EditView extends Polymer.MutableData(Polymer.Element) {
      static get is() { return 'edit-view'; }
      static get properties() {
        return {
          title: { type: String, value: 'Authorization Required' },
          tags: { type: Array, value:[], notify: true },
          pass: { type: Boolean, value: false },
          error: Object,
        };
      }
      static get observers() {
        return [
          'notFound(error.status)',
          'setPass(isAuthorized)'
        ]
      }
      notFound(status) {
        if (status === 404) {
          this.set('route.path', '/notfound');
        }
      }
      setPass(isAuthorized) {
        if (isAuthorized === true) {
          this.title = 'Edit';
          this.pass = true;
        }
      }
      connectedCallback() {
        super.connectedCallback();
        this.$.tags.addEventListener('focus', (e) => this._getTags(e));
        const form = this.$.editForm;
        form.addEventListener('iron-form-presubmit', () => this._preSubmit());
        form.addEventListener('iron-form-response', (e) => this._responseHandler(e));
      }
      _url(safekey, current) {
        const rx = /^\/edit/;
        if (rx.test(this.route.path)) {
          if (current && current.safekey === safekey) {
            this.item = current;
          } else {
            return ['/api', safekey].join('/');
          }
        }
      }
      listTags(e) {
        e.detail.response.forEach((tag) => {
          this.push('tags', {text: tag, value: tag});
        });
      }
      _getTags(e) {
        if (this.tags.length === 0) {
          this.$.ajax_tags.generateRequest();
        }
      }
      _preSubmit() {
        const form = this.$.editForm,
          tags = this.$.tags.items;

        if (this.current) {
          form.request.params['tags'] = tags;
          Object.assign(this.current, form.request.params);
        }
        form.request.params['tags'] = tags.join(',');
      }
      _submit() {
        this.$.editForm.submit();
      }
      _responseHandler(e) {
        const toast = this.$.toast;
        if (e.detail.xhr.status === 200) {
          toast.setAttribute('text', 'Successfully updated');
        } else {
          toast.setAttribute('text', 'Update failed');
        }
        toast.open();
      }
      goBack() {
        window.history.go(-1);
      }
    }

    window.customElements.define(EditView.is, EditView);
  </script>
</dom-module>
