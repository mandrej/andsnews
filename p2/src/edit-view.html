<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="edit-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      .container {
        padding: 16px;
      }
    </style>

    <app-header-layout>
      <app-header fixed slot="header">
        <app-toolbar>
          <paper-icon-button icon="chevron-left" on-tap="goBack"></paper-icon-button>
          <h1 main-title>Edit</h1>
        </app-toolbar>
      </app-header>

      <iron-ajax url="[[_url(safekey)]]" last-response="{{item}}" auto></iron-ajax>
      <iron-ajax url="/api/suggest/Photo_tags" last-response="{{tagsCloud}}" auto></iron-ajax>

      <iron-form id="editForm">
        <form class="container"
          action$="/api/[[item.kind]]/edit/[[item.safekey]]"
          method="put">

          <paper-toast id="toast"></paper-toast>

          <div class="layout horizontal end-justified">
            <paper-button on-tap="_submit" class="accent" raised>Submit</paper-button>
          </div>

          <paper-input name="headline" required label="headline" value="{{item.headline}}"></paper-input>

          <vaadin-combo-box name="author" required label="author"
            auto-validate
            allow-custom-value="true"
            items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'
            value="[[item.author]]"></vaadin-combo-box>

          <paper-chip-input-autocomplete name="tags" label="tags" id="tags"
            closable
            _items="[[item.tags]]"
            source="[[listObjects(tagsCloud)]]"></paper-chip-input-autocomplete>

          <paper-input readonly name="date" label="date" value="[[item.date]]"></paper-input>

          <div class="layout horizontal justified wrap">
            <paper-input readonly name="model" label="model" value="[[item.model]]"></paper-input>
            <paper-input readonly name="lens" label="lens" value="[[item.lens]]"></paper-input>
            <paper-input name="focal_length" label="focal_length [mm]" value="[[item.focal_length]]"></paper-input>
            <paper-input name="iso" label="iso [ASA]" value="[[item.iso]]"></paper-input>
            <paper-input name="aperture" label="aperture" value="[[item.aperture]]"></paper-input>
            <paper-input name="shutter" label="shutter [s]" value="[[item.shutter]]"></paper-input>
          </div>
          <!-- <paper-input disabled label="color" value="[[item.color]]"></paper-input> -->
        </form>
      </iron-form>

    </app-header-layout>
  </template>

  <script>
    class EditView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'edit-view'; }
      connectedCallback() {
        super.connectedCallback();
        this.$.editForm.addEventListener('iron-form-presubmit', () => this._preSubmit());
        this.$.editForm.addEventListener('iron-form-response', (e) => this._responseHandler(e));
        // this.$.editForm.addEventListener('iron-form-submit', (e) => this._submit(e));
      }
      _url(safekey) {
        const rx = /^\/edit/;
        if (rx.test(this.route.path)) {
          return ['/api', safekey].join('/');_submit
        }
      }
      listObjects(tags) {
        const list = [];
        tags.forEach(function(tag) {
          list.push({text: tag, value: tag});
        });
        return list;
      }
      _preSubmit() {
        const form = this.$.editForm;
        // console.dir(this.$.tags);
        form.request.params['tags'] = this.$.tags._items.join(',');
      }
      _submit() {
        this.$.editForm.submit();
      }
      _responseHandler(e) {
        const toast = this.$.toast;
        if (e.detail.xhr.status == 200) {
          toast.setAttribute('text', 'Successfully updated');
          toast.open();
        }
      }
      goBack() {
        window.history.go(-1);
      }
    }

    window.customElements.define(EditView.is, EditView);
  </script>
</dom-module>
