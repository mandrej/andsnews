<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/resize-title.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/app-layout/app-grid/app-grid-style.html">

<dom-module id="edit-view">
  <template>
    <style include="shared-styles app-grid-style iron-flex iron-flex-alignment iron-positioning">
      .container {
        @apply --layout-flex;
      }
      app-header {
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
      }
      ul {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .app-grid {
        --app-grid-columns: 3;
        --app-grid-gutter: var(--user-gap);
      }
      .item {
        @apply --layout-self-end;
      }
      .expandible {
        @apply --app-grid-expandible-item;
      }
      .right {
        text-align: right;
      }
      @media (max-width: 768px)  { .app-grid { --app-grid-columns: 2; }}
      @media (max-width: 432px)  { .app-grid { --app-grid-columns: 1; }}
    </style>

    <iron-ajax url="[[_url(safekey)]]" last-response="{{item}}" auto></iron-ajax>
    <iron-ajax url="/api/suggest/Photo_tags" on-response="listTags" id="ajax_tags"></iron-ajax>

    <app-header-layout fullbleed>
      <app-header condenses reveals shadow effects="resize-title fade-background"
        style="background-image: url([[item.serving_url]]=s0)" slot="header">
        <app-toolbar>
          <paper-icon-button icon="arrow-back" on-tap="goBack"></paper-icon-button>
          <h4 condensed-title>[[title]]</h4>
        </app-toolbar>
        <app-toolbar>
          <h1 main-title>[[title]]</h1>
        </app-toolbar>
      </app-header>

      <div class="container">
        <div hidden$="[[!pass]]">
          <iron-form id="editForm">
            <form action$="/api/[[item.kind]]/edit/[[item.safekey]]" method="put">

              <paper-toast id="toast" on-iron-overlay-closed="goBack"></paper-toast>

              <ul class="app-grid">
                <li class="item expandible right">
                  <paper-button on-tap="_submit" raised>Submit</paper-button>
                </li>
                <li class="item expandible">
                  <paper-input name="headline" required label="headline" value="{{item.headline}}"></paper-input>
                </li>
                <li class="item expandible">
                  <paper-chip-input-autocomplete name="tags" label="tags" id="tags"
                    closable
                    additional-items
                    items="[[item.tags]]"
                    source="[[tags]]"></paper-chip-input-autocomplete>
                </li>
                <li class="item">
                  <vaadin-combo-box name="author" required label="author"
                    auto-validate
                    allow-custom-value="true"
                    items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'
                    value="[[item.author]]"></vaadin-combo-box>
                </li>
                <li class="item">
                  <paper-input name="date" label="date" value="[[item.date]]"></paper-input>
                </li>
                <li class="item">
                  <paper-input name="model" label="model" value="[[item.model]]"></paper-input>
                </li>
                <li class="item">
                  <paper-input name="lens" label="lens" value="[[item.lens]]"></paper-input>
                </li>
                <li class="item">
                  <paper-input name="focal_length" label="focal_length [mm]" value="[[item.focal_length]]"></paper-input>
                </li>
                <li class="item">
                  <paper-input name="iso" label="iso [ASA]" value="[[item.iso]]"></paper-input>
                </li>
                <li class="item">
                  <paper-input name="aperture" label="aperture" value="[[item.aperture]]"></paper-input>
                </li>
                <li class="item">
                    <paper-input name="shutter" label="shutter [s]" value="[[item.shutter]]"></paper-input>
                </li>
                <li class="item">
                  <paper-input disabled label="color" value="[[item.color]]"></paper-input>
                </li>
              </ul>
            </form>
          </iron-form>
        </div>
        <div hidden$="[[pass]]">
          <p>Go <a href="/list/all">Home</a> and Sign-In with your Google Account</p>
        </div>
      </div>
      <slot name="footer"></slot>
    </app-header-layout>
  </template>

  <script>
    class EditView extends Polymer.Element {
      static get is() { return 'edit-view'; }
      static get properties() {
        return {
          title: { type: String, value: 'Authorization Required' },
          tags: { type: Array, value:[], notify: true },
          pass: { type: Boolean, value: false }
        };
      }
      static get observers() {
        return [
          'setPass(isAuthorized)'
        ]
      }
      setPass(isAuthorized) {
        if (isAuthorized === true) {
          this.title = 'Edit';
          this.pass = true;
        }
      }
      connectedCallback() {
        super.connectedCallback();
        this.$.tags.addEventListener('focus', (e) => this._getTags(e));
        const form = this.$.editForm;
        form.addEventListener('iron-form-presubmit', () => this._preSubmit());
        form.addEventListener('iron-form-response', (e) => this._responseHandler(e));
        // form.addEventListener('iron-form-submit', (e) => this._submit(e));
      }
      _url(safekey) {
        const rx = /^\/edit/;
        if (rx.test(this.route.path)) {
          return ['/api', safekey].join('/');
        }
      }
      listTags(e) {
        e.detail.response.forEach((tag) => {
          this.push('tags', {text: tag, value: tag});
        });
      }
      _getTags(e) {
        if (this.tags.length === 0) {
          this.$.ajax_tags.generateRequest();
        }
      }
      _preSubmit() {
        const form = this.$.editForm;
        form.request.params['tags'] = this.$.tags.items.join(',');
      }
      _submit() {
        this.$.editForm.submit();
      }
      _responseHandler(e) {
        const toast = this.$.toast;
        if (e.detail.xhr.status == 200) {
          toast.setAttribute('text', 'Successfully updated');
          toast.open();
        }
      }
      goBack() {
        window.history.go(-1);
      }
    }

    window.customElements.define(EditView.is, EditView);
  </script>
</dom-module>
