<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="edit-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>

    <app-header-layout class="big" fullbleed>
      <app-header fixed shadow slot="header">
        <app-toolbar>
          <paper-icon-button icon="arrow-back" on-tap="goBack"></paper-icon-button>
          <h1 main-title>[[title]]</h1>
        </app-toolbar>
      </app-header>

      <iron-ajax url="[[_url(safekey)]]" last-response="{{item}}" auto></iron-ajax>
      <iron-ajax url="/api/suggest/Photo_tags" last-response="{{tagsCloud}}" auto></iron-ajax>

      <div class="container">
        <div hidden$="[[!isAuthorized]]">
          <iron-form id="editForm">
            <form action$="/api/[[item.kind]]/edit/[[item.safekey]]" method="put">

              <paper-toast id="toast"></paper-toast>

              <div class="layout horizontal end-justified">
                <paper-button on-tap="_submit" raised>Submit</paper-button>
              </div>

              <paper-input name="headline" required label="headline" value="{{item.headline}}"></paper-input>

              <vaadin-combo-box name="author" required label="author"
                auto-validate
                allow-custom-value="true"
                items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'
                value="[[item.author]]"></vaadin-combo-box>

              <paper-chip-input-autocomplete name="tags" label="tags" id="tags"
                closable
                _items="[[item.tags]]"
                source="[[listObjects(tagsCloud)]]"></paper-chip-input-autocomplete>

              <paper-chip-input name="new_tags" label="new tags" id="new_tags"
                closable></paper-chip-input>

              <paper-input name="date" label="date" value="[[item.date]]"></paper-input>

              <div class="layout horizontal justified wrap">
                <paper-input name="model" label="model" value="[[item.model]]"></paper-input>
                <paper-input name="lens" label="lens" value="[[item.lens]]"></paper-input>
                <paper-input name="focal_length" label="focal_length [mm]" value="[[item.focal_length]]"></paper-input>
                <paper-input name="iso" label="iso [ASA]" value="[[item.iso]]"></paper-input>
                <paper-input name="aperture" label="aperture" value="[[item.aperture]]"></paper-input>
                <paper-input name="shutter" label="shutter [s]" value="[[item.shutter]]"></paper-input>
              </div>
              <!-- <paper-input disabled label="color" value="[[item.color]]"></paper-input> -->
            </form>
          </iron-form>
        </div>
        <div hidden$="[[isAuthorized]]">
          <p>Go <a href="#/start">Home</a> and Sign-In with your Google Account</p>
        </div>
      </div>
      <footer><slot name="copy"></slot></footer>
    </app-header-layout>
  </template>

  <script>
    class EditView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'edit-view'; }
      static get properties() {
        return {
          title: {
            type: String,
            computed: 'getTitle(isAuthorized)'
          }
        };
      }
      connectedCallback() {
        super.connectedCallback();
        const form = this.$.editForm;
        form.addEventListener('iron-form-presubmit', () => this._preSubmit());
        form.addEventListener('iron-form-response', (e) => this._responseHandler(e));
        // form.addEventListener('iron-form-submit', (e) => this._submit(e));
      }
      _url(safekey) {
        const rx = /^\/edit/;
        if (rx.test(this.route.path)) {
          return ['/api', safekey].join('/');_submit
        }
      }
      listObjects(tags) {
        const list = [];
        tags.forEach((tag) => {
          list.push({text: tag, value: tag});
        });
        return list;
      }
      _preSubmit() {
        const form = this.$.editForm,
          old_tags = this.$.tags._items,
          new_tags = this.$.new_tags.items;
        form.request.params['tags'] = old_tags.concat(new_tags).join(',');
      }
      _submit() {
        this.$.editForm.submit();
      }
      _responseHandler(e) {
        const toast = this.$.toast;
        if (e.detail.xhr.status == 200) {
          toast.setAttribute('text', 'Successfully updated');
          toast.open();
        }
      }
      getTitle(pass) {
        return (pass) ? 'Edit' : 'Authorization Required';
      }
      goBack() {
        window.history.go(-1);
      }
    }

    window.customElements.define(EditView.is, EditView);
  </script>
</dom-module>
