<link rel="import" href="../bower_components/img-pan-zoom/img-pan-zoom.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip.html">

<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">

<dom-module id="item-view">
  <template>
    <style include="shared-styles iron-flex">
      :host {
        @apply --layout-vertical;
        @apply --layout-fit;
        margin: 64px auto 0 auto;
        max-width: var(--max-width);
      }
      .container {
        @apply --layout-flex;
        margin: 0 calc(-1 * var(--user-gap));
        padding: var(--user-gap);
      }
      paper-dialog .buttons {
        padding: 16px 16px 0;
      }
      .buttons paper-icon-button {
        color: var(--text-primary-color);
      }
      img-pan-zoom {
        height: 100%;
        box-sizing: border-box;
        --img-pan-zoom-spinner-color: var(--default-primary-color);
        --img-pan-zoom-spinner-width: 3px;
      }
      @media (max-width: 1200px) { .container { margin: 0; }}
    </style>

    <iron-ajax auto
      url="[[_url(route.path, safekey, current)]]"
      last-error="{{error}}"
      last-response="{{item}}"></iron-ajax>

    <app-header fixed slot="header">
      <app-toolbar>
        <paper-icon-button icon="arrow-back" on-tap="goBack"></paper-icon-button>
        <h1 main-title>[[item.headline]]</h1>
        <a href="/api/download/[[item.safekey]]" download="[[item.slug]].jpg" target="_blank">
          <paper-icon-button icon="file-download"></paper-icon-button>
        </a>
        <paper-icon-button icon="info-outline" on-tap="openInfo"></paper-icon-button>
      </app-toolbar>
    </app-header>

    <paper-dialog id="info"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation">
      <div class="buttons">
        <paper-icon-button icon="clear" dialog-dismiss></paper-icon-button>
      </div>
      <h2>[[item.headline]]</h2>
      <p>
        [[_dateFormat(item.date)]]<br>
        [[item.author]]<br>
        [[item.model]] [[item.lens]] ([[item.focal_length]]mm)<br>
        f[[item.aperture]] [[item.shutter]]s [[item.iso]] ASA
      </p>
      <p>
        <paper-chip label="[[item.year]]" data-field="year" data-field-value$="[[item.year]]"
          on-tap="applyFilter"></paper-chip>
        <template is="dom-repeat" items="[[item.tags]]" as="tag">
          <paper-chip label="[[tag]]" data-field="tags" data-field-value$="[[tag]]"
            on-tap="applyFilter"></paper-chip>
        </template>
        <paper-chip label="[[item.model]]" data-field="model" data-field-value$="[[item.model]]"
          on-tap="applyFilter"></paper-chip>
        <paper-chip label="[[item.color]]" data-field="color" data-field-value$="[[item.color]]"
          on-tap="applyFilter"></paper-chip>
      </p>
    </paper-dialog>

    <div class="container">
      <img-pan-zoom src="[[checkImage(item)]]" max-zoom-pixel-ratio="1.0"></img-pan-zoom>
    </div>
  </template>

  <script>
    class ItemView extends Polymer.Element {
      static get is() { return 'item-view'; }
      static get properties() {
        return {
          error: Object,
        };
      }
      static get observers() {
        return [
          'notFound(error.status)',
        ]
      }
      _url(path, safekey, current) {
        if (!/^\/item/.test(path)) return;

        if (current && current.safekey === safekey) {
          this.item = current;
        } else {
          return ['/api', safekey].join('/');
        }
      }
      notFound(status) {
        if (status === 404) {
          this.set('route.path', '/notfound');
        }
      }
      openInfo() {
        const dialog = this.$.info;
        dialog.style.visibility = 'visible';
        dialog.toggle();
      }
      _dateFormat(str) {
        return moment(str, 'YYYY-MM-DDTHH:mm:ss').format('llll');
      }
      applyFilter(e) {
        const target = e.target,
          field = target.dataset.field,
          value = target.dataset.fieldValue;
        this.set('route.path', ['/list', field, value].join('/'));
      }
      checkImage(rec) {
        if (rec && rec.serving_url) return rec.serving_url + '=s0';
        return '../images/broken.svg';
      }
      goBack() {
        window.history.back();
      }
    }

    window.customElements.define(ItemView.is, ItemView);
  </script>
</dom-module>
