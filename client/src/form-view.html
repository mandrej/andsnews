<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="form-view">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
                background-color: #eee;
            }
            .container {
                margin: 16px;
            }
            h1 {
                font-weight: 300;
            }
            paper-button {
                color: var(--dark-theme-base-color);
                background-color: var(--primary-color);
                text-transform: lowercase;
            }
            vaadin-upload {
                --vaadin-upload-button-add: {
                    text-transform: lowercase;
                }
            }
        </style>

        <iron-ajax auto
			url="{{_url(view, kind, safekey)}}"
			handle-as="json"
			last-response="{{obj}}"
			debounce-duration="300"></iron-ajax>

        <iron-ajax auto
			url="/complete/Photo_lens"
			handle-as="json"
			last-response="{{lens_cloud}}"
			debounce-duration="300"></iron-ajax>

        <div class="container">

            <form is="iron-form" id="form">
                <template is="dom-if" if="[[_isAdd(safekey)]]">
                    <template is="dom-if" if="[[_isKindPhoto(kind)]]">
                        <h1>[[_edit_add(safekey)]] [[kind]]</h1>

                        <vaadin-upload
                            target="/api/{{kind}}/add"
                            max-files="1"
                            on-upload-response="_uploadResponse"
                            accept="image/*"></vaadin-upload>
                    </template>

                    <template is="dom-if" if="[[!_isKindPhoto(kind)]]">
                        <div class="layout horizontal center justified">
                            <h1 class="self-center">[[_edit_add(safekey)]] [[kind]]</h1>
                            <div class="self-center">
                                <paper-button on-tap="_reset">Reset</paper-button>
                                <paper-button on-tap="_submit">Submit</paper-button>
                            </div>
                        </div>

                        <paper-input name="headline" label="headline"></paper-input>
                        <vaadin-combo-box
                            name="author"
                            label="author"
                            items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com"]'>
                            </vaadin-combo-box>
                        <paper-input name="tags" label="tags"></paper-input>

                        <paper-textarea name="summary" label="summary"></paper-textarea>
                        <paper-textarea name="body" label="body"></paper-textarea>
                    </template>
                </template>

                <template is="dom-if" if="[[!_isAdd(safekey)]]">
                    <div class="layout horizontal center justified">
                        <h1 class="self-center">[[_edit_add(safekey)]] [[kind]]</h1>
                        <div class="self-center">
                            <paper-button on-tap="_reset">Reset</paper-button>
                            <paper-button on-tap="_submit">Submit</paper-button>
                        </div>
                    </div>

                    <paper-input name="headline" label="headline" value="{{obj.headline}}"></paper-input>
                    <vaadin-combo-box
                        required
                        auto-validate
                        name="author"
                        label="author"
                        allow-custom-value="true"
                        items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com"]'
                        value="{{obj.author}}"></vaadin-combo-box>
                    <paper-input name="tags" label="tags" value="{{obj.tags}}"></paper-input>
                    <vaadin-date-picker
                        name="date"
                        label="date"
                        value="{{_dateFormat(obj.date)}}"></vaadin-date-picker>

                    <template is="dom-if" if="[[_isItemPhoto(obj)]]">
                        <paper-input name="model" label="model" value="{{obj.model}}"></paper-input>
                        <vaadin-combo-box
                            name="lens"
                            label="lens"
                            allow-custom-value="true"
                            items="{{lens_cloud}}"
                            item-label-path="id"
                            item-value-path="value"
                            value="{{obj.lens}}"></vaadin-combo-box>
                        <paper-input name="aperture" label="aperture" value="{{obj.aperture}}"></paper-input>
                        <paper-input name="shutter" label="shutter" value="{{obj.shutter}}"></paper-input>
                        <paper-input name="iso" label="iso" value="{{obj.iso}}"></paper-input>
                        <paper-input name="focal_length" label="focal_length" value="{{obj.focal_length}}"></paper-input>
                    </template>

                    <template is="dom-if" if="[[!_isItemPhoto(obj)]]">
                        <paper-textarea name="summary" label="summary" value="{{obj.summary}}"></paper-textarea>
                        <paper-textarea name="body" label="body" value="{{obj.body}}"></paper-textarea>
                    </template>
                </template>
            </form>
        </div>
    </template>
    <script>
        Polymer({
            is: 'form-view',
            properties: {
                kind: { type: String, value: null, notify: true },
                safekey: { type: String, value: null, notify: true },
            },
            // listeners: {
            //     'on_iron-form-presubmit': '_alterData',
            //     'on_iron-form-submit': '_submitData'
            // },
            _url: function(view, kind, safekey) {
                if (view != 'form' || safekey == 'add') return;
                return ['/api', kind, safekey].join('/');
            },
            _isKindPhoto: function(kind) {
                return kind == 'photo';
            },
            _isItemPhoto: function(item) {
                return item.kind == 'photo';
            },
            _isAdd: function(safekey) {
                return safekey == 'add';
            },
            _edit_add: function(safekey) {
                return this._isAdd(safekey) ? 'add' : 'edit';
            },
            _dateFormat: function(str) {
                return moment(str, 'YYYY-MM-DDTHH:mm:ss').format('YYYY-MM-DD');
            },
            _reset: function(e) {
                this.$.form.reset();
            },
            _uploadResponse: function(e) {
                var res = JSON.parse(e.detail.xhr.responseText);
                console.log(res, this.kind);
                if (res.success) {
                    this.safekey = res.safe_key;
                    this.set('route.path', ['', 'admin', this.kind, this.safekey].join('/'));
                }
            },
            // _alterData: function(e) {
            //     var date = this.request.params['date'];
            //     this.request.params['date'] = moment(date, 'YYYY-MM-DD').format('YYYY-MM-DDTHH:mm:ss');
            //     console.log(this.request.params['date']);
            // },
            // _submitData: function(e) {
            //     console.log(e.detail);
            // },
            _submit: function(e) {
                var form = this.$.form,
                    method, action, contentType;
                if (this.safekey == 'add') {
                    method = 'post';
                    action = ['/api', this.kind, 'add'].join('/');
                    contentType = 'multipart/form-data';
                } else {
                    method = 'put';
                    action = ['/api', this.kind, this.safekey].join('/');
                    contentType = 'application/json';
                }
                form.setAttribute('method', method);
                form.setAttribute('action', action);
                form.setAttribute('content-type', contentType);

                var json = form.serialize();
                console.log(json);
                form.submit();
            }
        });
    </script>
    <script src="../bower_components/moment/min/moment.min.js"></script>
</dom-module>
