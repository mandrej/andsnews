<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-select/paper-select.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-behavior.html">

<dom-module id="form-view">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
            }
            .container {
                padding: 16px;
            }
            h1 {
                font-weight: 300;
            }
            paper-button {
                color: var(--app-background-color);
                background-color: var(--app-primary-color);
                text-transform: lowercase;
            }
            paper-input {
                --paper-input-container-color: var(--app-text-color);
                --paper-input-container-focus-color: var(--app-primary-color);
                --paper-input-container-invalid-color: var(--app-alert-color);
                --paper-input-container: {
                    padding: 4px 0;
                }
            }
            vaadin-upload {
                --error-color: var(--app-alert-color);
                --vaadin-upload-button-add: {
                    color: var(--app-background-color);
                    background-color: var(--app-primary-color);
                    text-transform: lowercase;
                }
            }
            vaadin-combo-box {
                --paper-input-container-color: var(--app-text-color);
                --paper-input-container-focus-color: var(--app-primary-color);
            }
            vaadin-date-picker {
                --vaadin-date-picker-calendar-cell-selected: {
                    background-color: var(--app-primary-color);
                }
            }
            paper-toast {

            }
        </style>

        <iron-ajax auto
			url="[[_url(view, kind, field, value, isAuthorized)]]"
			handle-as="json"
			last-response="{{obj}}"
			debounce-duration="300"></iron-ajax>

        <iron-ajax auto
			url="[[_urlLensCloud(view, kind)]]"
			handle-as="json"
			last-response="{{lens_cloud}}"
			debounce-duration="100"></iron-ajax>

        <iron-ajax auto
			url="[[_urlTagsCloud(view, kind)]]"
			handle-as="json"
			last-response="{{tags_cloud}}"
			debounce-duration="100"></iron-ajax>

        <paper-toast id="toast"></paper-toast>

        <div class="container">
            <template is="dom-if" if="[[_isAdd(field)]]">
                <template is="dom-if" if="[[_isKindPhoto(kind)]]">
                    <vaadin-upload
                        target="/api/{{kind}}/add"
                        max-files="1"
                        on-upload-response="_uploadResponse"
                        accept="image/*"></vaadin-upload>
                </template>

                <template is="dom-if" if="[[!_isKindPhoto(kind)]]">
                    <form is="iron-form"
                        on-iron-form-response="_responseHandler"
                        method="post" action$="/api/[[kind]]/add" id="form">
                        <div class="layout horizontal end-justified">
                            <paper-button on-tap="_submit">Submit</paper-button>
                        </div>

                        <paper-input name="headline" required label="headline"></paper-input>
                        <vaadin-combo-box
                            name="author"
                            label="author"
                            allow-custom-value="true"
                            pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'
                            items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'>
                            </vaadin-combo-box>
                            <paper-select
                                name="tags"
                                label="tags"
                                on-input-changed="inputChanged"
                                on-adding-item="addItem"
                                multiple unique nonmatching select-on-blur></paper-select>

                        <paper-textarea name="summary" label="summary"></paper-textarea>
                        <paper-textarea name="body" label="body"></paper-textarea>
                    </form>
                </template>
            </template>

            <template is="dom-if" if="[[!_isAdd(field)]]">
                <form is="iron-form" on-iron-form-presubmit="_preSubmit" on-iron-form-response="_responseHandler" method="post" action$="/api/[[kind]]/edit/[[value]]" id="form">
                    <div class="layout horizontal end-justified">
                        <paper-button on-tap="_submit">Submit</paper-button>
                    </div>

                    <paper-input name="headline" required label="headline" value="{{obj.headline}}"></paper-input>
                    <vaadin-combo-box
                        required
                        auto-validate
                        name="author"
                        label="author"
                        allow-custom-value="true"
                        pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'
                        items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'
                        value="{{_getEmail(obj)}}"></vaadin-combo-box>
                    <paper-select
                        name="tags"
                        label="tags"
                        on-input-changed="inputChanged"
                        on-adding-item="addItem"
                        bind-value="{{obj.tags}}"
                        multiple unique nonmatching select-on-blur></paper-select>
                    <vaadin-date-picker
                        name="date"
                        label="date"
                        value="{{_dateFormat(obj.date)}}"></vaadin-date-picker>

                    <template is="dom-if" if="[[_isKindPhoto(kind)]]">
                        <paper-input name="model" label="model" value="{{obj.model}}"></paper-input>
                        <vaadin-combo-box
                            name="lens"
                            label="lens"
                            allow-custom-value="true"
                            items="{{lens_cloud}}"
                            value="{{obj.lens}}"></vaadin-combo-box>
                        <div class="layout horizontal">
                            <paper-input name="aperture" readonly label="aperture" value="{{obj.aperture}}"></paper-input>
                            <paper-input name="shutter" readonly label="shutter" value="{{obj.shutter}}"></paper-input>
                        </div>
                        <div class="layout horizontal">
                            <paper-input name="iso" readonly label="iso" value="{{obj.iso}}"></paper-input>
                            <paper-input name="focal_length" readonly label="focal_length" value="{{obj.focal_length}}"></paper-input>
                        </div>
                    </template>

                    <template is="dom-if" if="[[!_isKindPhoto(kind)]]">
                        <paper-textarea name="summary" label="summary" value="{{obj.summary}}"></paper-textarea>
                        <paper-textarea name="front_img" label="front image" value="{{obj.front_img}}"></paper-textarea>
                        <paper-textarea name="body" label="body" value="{{obj.body}}"></paper-textarea>
                    </template>
                </form>
            </template>
        </div>
    </template>
    <script>
        Polymer({
            is: 'form-view',
            behaviors: [
                Polymer.NeonAnimationBehavior
            ],
            properties: {
                animationConfig: {
                    type: Object,
                    value: function() {
                        return {
                            'entry': [{
                                name: 'slide-from-right-animation',
                                node: this
                            }],
                            'exit': [{
                                name: 'slide-right-animation',
                                node: this
                            }]
                        }
                    }
                },
                isAuthorized: { type: Boolean, value: false, notify: true },
                user: { type: Object, notify: true },
                view: { type: String, value: null, notify: true },
                kind: { type: String, value: null, notify: true },
                field: { type: String, value: null, notify: true },
                value: { type: String, value: null, notify: true },
            },
            _url: function(view, kind, field, value, isAuthorized) {
                if (view != 'form') return;
                if (!isAuthorized) return;
                if (field == 'edit') {
                    return ['/api', kind, field, value].join('/');
                }
            },
            _urlTagsCloud: function(view, kind) {
                if (view != 'form') return;
                if (kind) return '/api/suggest/' + this.capitalize(kind) + '_tags';
            },
            _urlLensCloud: function(view, kind) {
                if (view != 'form') return;
                if (kind == 'photo') return '/api/suggest/Photo_lens';
            },
            _isKindPhoto: function(kind) {
                return kind == 'photo';
            },
            _isAdd: function(field) {
                return field == 'add';
            },
            _getEmail: function(obj) {
                return (obj.author) ? obj.author : this.user.getBasicProfile().getEmail();
            },
            _dateFormat: function(str) {
                return moment(str, 'YYYY-MM-DDTHH:mm:ss').format('YYYY-MM-DD');
            },
            // _reset: function(e) {
            //     this.$.form.reset();
            // },
            _uploadResponse: function(e) {
                var res = JSON.parse(e.detail.xhr.responseText),
                    toast = this.$.toast;
                if (res.success) {
                    toast.setAttribute('text', 'Image successfully uploaded');
                    toast.open();
                    this.set('route.path', ['/form', this.kind, 'edit', res.safe_key].join('/'));
                } else {
                    toast.setAttribute('text', res.message);
                    toast.open();
                }
            },
            _responseHandler: function(e) {
                var toast = this.$.toast;
                if (e.detail.xhr.status == 200) {
                    toast.setAttribute('text', 'Record successfully created / updated');
                    toast.open();
                }
            },
            _preSubmit: function() {
                var form = this.$$('#form');
                form.request.method = 'put'; // PUT SENDS URL PARAMETERS!
            },
            _submit: function(e) {
                var form = this.$$('#form');
                // var json = form.serialize();
                // console.log(json);
                form.submit();
            },
            inputChanged: function(e) {
                var input = (e.detail.value || '').trim().toLowerCase();
                if (input) {
                    e.target.options = this.tags_cloud.filter(function(item) {
                        return item.toLowerCase().indexOf(input) === 0;
                    });
                } else {
                    e.target.options = [];
                }
            },
            addItem: function(e) {
                var input = (e.detail.value || '').trim();
                e.detail.value = input;
            },
            capitalize: function(string) {
                return string[0].toUpperCase() + string.slice(1);
            },
        });
    </script>
    <script src="../bower_components/moment/min/moment.min.js"></script>
</dom-module>
