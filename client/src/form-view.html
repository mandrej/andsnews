<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input-autocomplete-chips/paper-input-autocomplete.html">
<link rel="import" href="../bower_components/paper-input-autocomplete-chips/paper-input-autocomplete-chips.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="shared-styles.html">

<dom-module id="form-view">
  <template>
    <style include="shared-styles">
      .container {
        height: calc(100vh - 72px);
        padding: 16px;
        padding-bottom: 56px;
      }
      vaadin-upload {
        --vaadin-upload-button-add: {
          font-size: inherit;
          color: var(--primary-background-color);
          background-color: var(--accent-color);
          @apply(--shadow-elevation-2dp);
        }
      }
      paper-input,
      vaadin-combo-box,
      paper-input-autocomplete-chips {
        --paper-input-container-color: var(--primary-text-color);
        --paper-input-container-focus-color: var(--primary-color);
      }
    </style>

    <iron-ajax id="xhr"
      handle-as="json"
      on-response="tagsHandler"></iron-ajax>

    <div hidden$="[[!isAuthorized]]" class="container" id="container">
      <paper-toast id="toast" class="fit-bottom"></paper-toast>

      <template is="dom-if" if="[[_isKindPhoto(kind)]]">
        <vaadin-upload id="upload"
          target="/api/[[kind]]/add"
          max-files="10"
          on-upload-response="_uploadResponse"
          accept="image/*"></vaadin-upload>
        <p>See <a href="#/detail/photo/tags/new">uploaded files</a> and continue editing.</p>
      </template>

      <template is="dom-if" if="[[!_isKindPhoto(kind)]]">
        <form id="form"
          is="iron-form"
          on-iron-form-response="_responseHandler"
          method="post"
          action$="/api/[[kind]]/add">
          <div class="layout horizontal end-justified">
            <paper-button on-tap="_submit" class="accent" raised>Submit</paper-button>
          </div>

          <paper-input name="headline" required label="headline"></paper-input>
          <vaadin-combo-box
            name="author"
            label="author"
            allow-custom-value="true"
            items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'>
          </vaadin-combo-box>
          <paper-input-autocomplete-chips id="tags"
            name="tags"
            label="tags"
            on-focus="callAjax"
            local-candidates="[[tagsCloud]]"
            allow-select-unknown-token animated no-chip-image></paper-input-autocomplete-chips>

          <paper-input name="date" label="date" type="date"></paper-input>
          <paper-textarea name="summary" label="summary"></paper-textarea>
          <paper-input name="front_img" label="front image" type="url"></paper-input>
          <paper-textarea name="body" label="body"></paper-textarea>
        </form>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'form-view',
      listeners: {
        'iron-form-presubmit': '_preSubmit'
      },
      properties: {
        tagsCloud: Array
      },
      callAjax: function () {
        const xhr = this.$.xhr;
        xhr.url = '/api/suggest/Entry_tags';
        if (xhr.lastResponse === undefined) xhr.generateRequest();
      },
      _isKindPhoto: function (kind) {
        return kind == 'photo';
      },
      _uploadResponse: function (e) {
        var res = JSON.parse(e.detail.xhr.responseText),
          toast = this.$.toast;
        toast.fitInto = this.$.container;
        if (res.success) {
          toast.setAttribute('text', 'Image successfully uploaded');
          toast.open();
          // this.set('route.path', ['/form', this.kind, 'edit', res.safe_key].join('/'));
        } else {
          toast.setAttribute('text', res.message);
          toast.open();
        }
      },
      _responseHandler: function (e) {
        var toast = this.$.toast;
        toast.fitInto = this.$.container;
        if (e.detail.xhr.status == 200) {
          toast.setAttribute('text', 'Record successfully created / updated');
          toast.open();
        }
      },
      tagsHandler: function (request) {
        const response = request.detail.response;
        this.tagsCloud = [];
        response.forEach(function (item) {
          this.push('tagsCloud', {'text': item});
        }, this);
      },
      _preSubmit: function () {
        const form = this.$$('#form');
        const tagsInput = this.$$('#tags').selectedObjects;
        const tags = [];
        tagsInput.forEach(function (item) {
          tags.push(item.text);
        })
        form.request.body['tags'] = tags.join(',');
      },
      _submit: function (e) {
        const form = this.$$('#form');
        // var json = form.serialize();
        form.submit();
      },
    });
  </script>
</dom-module>
