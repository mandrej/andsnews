<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-select/paper-select.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="form-view">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
                background-color: #eee;
            }
            .container {
                margin: 16px;
            }
            h1 {
                font-weight: 300;
            }
            paper-button {
                color: var(--dark-theme-base-color);
                background-color: var(--primary-color);
                text-transform: lowercase;
            }
            vaadin-upload {
                --vaadin-upload-button-add: {
                    text-transform: lowercase;
                }
            }
            /*paper-select .selected-item {
                color: #000;
                background-color: #666;
            }*/
        </style>

        <iron-ajax auto
			url="{{_url(view, kind, safekey)}}"
			handle-as="json"
			last-response="{{obj}}"
			debounce-duration="300"></iron-ajax>

        <iron-ajax auto
			url="/api/suggest/Photo_lens"
			handle-as="json"
			last-response="{{lens_cloud}}"
			debounce-duration="300"></iron-ajax>

        <iron-ajax auto
			url="/api/suggest/Photo_tags"
			handle-as="json"
			last-response="{{tags_cloud}}"
			debounce-duration="300"></iron-ajax>

        <div class="container">

            <form is="iron-form" id="form">
                <template is="dom-if" if="[[_isAdd(safekey)]]">
                    <template is="dom-if" if="[[_isKindPhoto(kind)]]">
                        <h1>[[_edit_add(safekey)]] [[kind]]</h1>

                        <vaadin-upload
                            target="/api/{{kind}}/add"
                            max-files="1"
                            on-upload-response="_uploadResponse"
                            accept="image/*"></vaadin-upload>
                    </template>

                    <template is="dom-if" if="[[!_isKindPhoto(kind)]]">
                        <div class="layout horizontal center justified">
                            <h1 class="self-center">[[_edit_add(safekey)]] [[kind]]</h1>
                            <div class="self-center">
                                <paper-button on-tap="_reset">Reset</paper-button>
                                <paper-button on-tap="_submit">Submit</paper-button>
                            </div>
                        </div>

                        <paper-input name="headline" required label="headline"></paper-input>
                        <vaadin-combo-box
                            name="author"
                            label="author"
                            allow-custom-value="true"
                            pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'
                            items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com"]'>
                            </vaadin-combo-box>
                            <paper-select
                                name="tags"
                                label="tags"
                                on-input-changed="inputChanged"
                                on-adding-item="addItem"
                                multiple unique nonmatching select-on-blur></paper-select>

                        <paper-textarea name="summary" label="summary"></paper-textarea>
                        <paper-textarea name="body" label="body"></paper-textarea>
                    </template>
                </template>

                <template is="dom-if" if="[[!_isAdd(safekey)]]">
                    <div class="layout horizontal center justified">
                        <h1 class="self-center">[[_edit_add(safekey)]] [[kind]]</h1>
                        <div class="self-center">
                            <paper-button on-tap="_reset">Reset</paper-button>
                            <paper-button on-tap="_submit">Submit</paper-button>
                        </div>
                    </div>

                    <paper-input name="headline" required label="headline" value="{{obj.headline}}"></paper-input>
                    <vaadin-combo-box
                        required
                        auto-validate
                        name="author"
                        label="author"
                        allow-custom-value="true"
                        pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'
                        items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com"]'
                        value="{{obj.author}}"></vaadin-combo-box>
                    <paper-select
                        name="tags"
                        label="tags"
                        on-input-changed="inputChanged"
                        on-adding-item="addItem"
                        bind-value="{{obj.tags}}"
                        multiple unique nonmatching select-on-blur></paper-select>
                    <vaadin-date-picker
                        name="date"
                        label="date"
                        value="{{_dateFormat(obj.date)}}"></vaadin-date-picker>

                    <template is="dom-if" if="[[_isItemPhoto(obj)]]">
                        <paper-input name="model" label="model" value="{{obj.model}}"></paper-input>
                        <vaadin-combo-box
                            name="lens"
                            label="lens"
                            allow-custom-value="true"
                            items="{{lens_cloud}}"
                            value="{{obj.lens}}"></vaadin-combo-box>
                        <div class="layout horizontal">
                            <paper-input name="aperture" readonly label="aperture" value="{{obj.aperture}}"></paper-input>
                            <paper-input name="shutter" readonly label="shutter" value="{{obj.shutter}}"></paper-input>
                        </div>
                        <div class="layout horizontal">
                            <paper-input name="iso" readonly label="iso" value="{{obj.iso}}"></paper-input>
                            <paper-input name="focal_length" readonly label="focal_length" value="{{obj.focal_length}}"></paper-input>
                        </div>
                    </template>

                    <template is="dom-if" if="[[!_isItemPhoto(obj)]]">
                        <paper-textarea name="summary" label="summary" value="{{obj.summary}}"></paper-textarea>
                        <paper-textarea name="body" label="body" value="{{obj.body}}"></paper-textarea>
                    </template>
                </template>
            </form>
        </div>
    </template>
    <script>
        Polymer({
            is: 'form-view',
            properties: {
                kind: { type: String, value: null, notify: true },
                safekey: { type: String, value: null, notify: true },
            },
            _url: function(view, kind, safekey) {
                if (view != 'form' || safekey == 'add') return;
                return ['/api', kind, safekey].join('/');
            },
            _isKindPhoto: function(kind) {
                return kind == 'photo';
            },
            _isItemPhoto: function(item) {
                return item.kind == 'photo';
            },
            _isAdd: function(safekey) {
                return safekey == 'add';
            },
            _edit_add: function(safekey) {
                return this._isAdd(safekey) ? 'add' : 'edit';
            },
            _dateFormat: function(str) {
                return moment(str, 'YYYY-MM-DDTHH:mm:ss').format('YYYY-MM-DD');
            },
            _reset: function(e) {
                this.$.form.reset();
            },
            _uploadResponse: function(e) {
                var res = JSON.parse(e.detail.xhr.responseText);
                if (res.success) {
                    this.safekey = res.safe_key;
                    this.set('route.path', ['/admin', this.kind, this.safekey].join('/'));
                } else {
                    console.log(res.message);
                }
            },
            _submit: function(e) {
                var form = this.$.form,
                    method, action, contentType;
                if (this.safekey == 'add') {
                    method = 'post';
                    action = ['/api', this.kind, 'add'].join('/');
                    contentType = 'multipart/form-data';
                } else {
                    method = 'put';
                    action = ['/api', this.kind, this.safekey].join('/');
                    contentType = 'application/json';
                }
                form.setAttribute('method', method);
                form.setAttribute('action', action);
                form.setAttribute('content-type', contentType);

                var json = form.serialize();
                console.log(json);
                form.submit();
            },
            inputChanged: function(e) {
                var input = (e.detail.value || '').trim().toLowerCase();
                if (input) {
                    e.target.options = this.tags_cloud.filter(function(item) {
                        return item.toLowerCase().indexOf(input) === 0;
                    });
                } else {
                    e.target.options = [];
                }
            },
            addItem: function(e) {
                var input = (e.detail.value || '').trim();
                e.detail.value = input;
            },
        });
    </script>
    <script src="../bower_components/moment/min/moment.min.js"></script>
</dom-module>
