<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-swipeable-pages/iron-swipeable-pages.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">

<dom-module id="detail-view">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
                height: 100vh;
            }
            ::-webkit-scrollbar {
                display: none;
            }
            iron-swipeable-pages {
                @apply(--layout-fit);
            }
            .swipe {
                -moz-user-select: none;
                -ms-user-select: none;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;
            }
            .swipe iron-image {
                width: 100%;
                height: 100%;
            }
            paper-dialog.info {
                max-width: 400px;
                --paper-dialog-background-color: #f7cb4d;
                --paper-dialog-title: {
                    font-size: var(--app-toolbar-font-size);
                }
            }
            .markdown-html * {
                font-family: 'Roboto', 'Noto', sans-serif;
            }
            .markdown-html img {
                max-width: 100%;
            }
            .markdown-html h2, .markdown-html h3, .markdown-html strong {
                font-weight: 500;
            }
            /*.markdown-html img[alt='Milan D. Andrejevic'] {
            }*/
        </style>

        <iron-ajax id="ajax" auto
            url="{{_url(kind, field, value)}}"
            params="{{params}}"
            handle-as="json"
            on-response="handler"
            loading="{{loading}}"
            debounce-duration="200"></iron-ajax>

        <paper-dialog id="message" class="info"
            entry-animation="scale-up-animation" exit-animation="fade-out-animation">
            <h2>Nothing found</h2>
            <p>Please try again</p>
        </paper-dialog>

        <iron-swipeable-pages selected="{{start}}" threshold="0" disabled="{{disabled}}" id="swipe">
            <template is="dom-repeat" items="{{records}}">
                <template is="dom-if" if="[[_isKindPhoto(item)]]">
                    <div class="swipe">
                        <iron-image src="[[item.serving_url]]=s0" sizing="cover"
                            data-dim$="[[item.dim]]" on-track="zoomImage"></iron-image>
                        <paper-dialog id="[[item.safekey]]" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
                            <p>
                                [[_dateFormat(item.date)]]<br>
                                [[item.author]]<br><br>
                                [[item.model]]<br>
                                [[item.lens]] ([[item.focal_length]]mm)<br>
                                f[[item.aperture]] [[item.shutter]]s [[item.iso]] ASA
                            </p>
                        </paper-dialog>
                    </div>
                </template>
                <template is="dom-if" if="[[!_isKindPhoto(item)]]">
                    <div class="swipe" style="padding: 16px">
                        <marked-element markdown="[[item.body]]">
                            <div class="markdown-html"></div>
                        </marked-element>
                    </div>
                </template>
            </template>
        </iron-swipeable-pages>
    </template>

    <script>
        Polymer({
            is: 'detail-view',
            behaviors: [
                Polymer.NeonAnimatableBehavior,
                Polymer.NeonSharedElementAnimatableBehavior
            ],
            properties: {
                sharedElements: {
                    type: Object,
                    value: function() {
                        return {
                            'hero': this.$.swipe,
                        }
                    }
                },
                animationConfig: {
                    type: Object,
                    value: function() {
                        return {
                            'entry': [{
                                name: 'hero-animation',
                                id: 'hero',
                                toPage: this
                            }],
                            'exit': [{
                                name: 'slide-right-animation',
                                node: this
                            }]
                        }
                    }
                },
                kind: { type: String, value: null, notify: true },
				field: { type: String, value: null, notify: true },
				value: { type: String, value: null, notify: true },
                start: { type: Number, value: 0, notify: true, observer: 'changeIndex' },
                disabled: { type: Boolean, value: false, notify: true },
                headline: { type: String, notify: true },
                params: { type: Object, value: {}, notify: true },
                records: { type: Array, value: [], notify: true },
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
            },
            listeners: {
                'show-exif': '_showExif'
            },
            _url: function(kind, field, value) {
				var url, prefix = '/api';
				if (kind == 'search' && field != null) {
                    url = [prefix, kind, field].join('/');
				} else if (field && value) {
					url = [prefix, kind, field, value].join('/');
				}
                this.set('params.page', null);
				return url;
			},
			handler: function(request) {
				var response = request.detail.response;
                if (!response.objects) return;
                if (response.objects.length == 0) {
                    var dialog = this.$.message;
                    dialog.fitInto = this.$.swipe;
                    dialog.open();
                } else {
                    response.objects.forEach(function(item) {
                        this.push('records', item);
                    }, this);

                    if (this.headline == 'ANDрејевићи') {
                        this.headline = this.records[this.start].headline;
                    }
                }
			},
            loadMore: function() {
                var ajax = this.$.ajax;
                // if (ajax.lastRequest) ajax.lastRequest.abort();
				if (ajax.lastResponse && ajax.lastResponse.next) {
                    this.set('params.page', ajax.lastResponse.next);
				}
			},
            changeIndex: function(start) {
                if (!this.records) return;
                if (this.records.length > 0) {
                    this.headline = this.records[start].headline;

                    if (this.records.length - start < 3) {
                        this.loadMore();
                    }
                }
            },
            _isKindPhoto: function(item) {
                return item.kind == 'photo';
            },
            _dateFormat: function(str) {
                return moment(str, 'YYYY-MM-DDTHH:mm:ss').format('LLL');
                // return moment(str, 'YYYY-MM-DDTHH:mm:ss').locale('sr').format('LLL');
                // return moment(str, 'YYYY-MM-DDTHH:mm:ss').locale('sr').fromNow();
            },
            _showExif: function(e) {
                var id = e.target.records[this.start].safekey,
                    dialog = this.$$('#' + id);
                if (dialog) {
                    dialog.open();
                }
            },
            zoomImage: function(e) {
                var swipe = this.$.swipe,
                    width = swipe.offsetWidth,
                    height = swipe.offsetHeight,
                    elem = e.target,
                    dim = JSON.parse(elem.dataset.dim);

                var newX = e.detail.x - e.detail.x / width * dim[0],
                    newY = e.detail.y - e.detail.y / height * dim[1];

                switch(e.detail.state) {
                    case 'track':
                        if (this.disabled) {
                            // move in progress
                            elem.style.transform = 'translate(' + newX + 'px, ' + newY + 'px)';
                        } else {
                            if (Math.abs(e.detail.dx) > Math.abs(e.detail.dy)) {
                                return; // swipe
                            } else {
                                // zoom
                                if (elem.style.width != dim[0] + 'px') {
                                    elem.style.width = dim[0] + 'px';
                                    elem.style.height = dim[1] + 'px';
                                }
                                this.disabled = true;
                                elem.style.transform = 'translate(' + newX + 'px, ' + newY + 'px)';
                                // elem.style.webkitTransition = 'all 300ms ease-in-out';
                            }
                        }
                        break;
                    case 'end':
                        elem.style.width = '100%';
                        elem.style.height = '100%';
                        elem.style.transform = 'translate(0px, 0px)';
                        this.disabled = false;
                        break;
                }
            },
            propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
        });
    </script>
    <script src="../bower_components/moment/min/moment.min.js"></script>
</dom-module>
