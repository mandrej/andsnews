<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/app-layout/app-scrollpos-control/app-scrollpos-control.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">

<link rel="import" href="app-search.html">
<link rel="import" href="grid-view.html">
<link rel="import" href="detail-view.html">
<link rel="import" href="admin-view.html">
<link rel="import" href="form-view.html">

<dom-module id="app-shell">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment"></style>
		<style>
			:host {
				display: block;
			}
			app-header {
				color: var(--light-theme-text-color);
				z-index: 1;
				background-color: var(--light-theme-background-color);
				/*--app-header-background-rear-layer: {
					background-color: var(--google-yellow-300);
      			};*/
				@apply(--shadow-elevation-2dp);
          	}
			app-toolbar a, paper-item a {
				color: inherit;
				text-decoration: none;
			}
			app-drawer {
				min-height: 100vh;
				top: 0;
				bottom: 0;
				z-index: 2;
				--app-drawer-content-container: {
					padding: 0;
				}
			}
			google-signin {
				display: block;
			}
			app-drawer app-toolbar {
				background-color: var(--google-yellow-300);
				@apply(--shadow-elevation-2dp);
			}
            paper-item iron-icon {
                margin-right: 16px;
                color: var(--light-theme-secondary-color);
            }
			paper-button {
				text-transform: lowercase;
			}
			.avatar {
				width: 50px;
				height: 50px;
				border-radius: 50%;
			}
			h1, h4 {
				margin: 0;
				font-size: 36px;
				font-weight: 300;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			[condensed-title] {
				font-size: 24px;
			}
			@media (max-width: 767px) {
        		h1 {
					margin: 0 12px;
					font-size: 24px;
				}
        	}
		</style>

		<!--
		https://www.polymer-project.org/1.0/articles/routing.html
		/:kind					grid view		/photo
		/:kind/:field/:value	detail view		/photo/date/2015
		/search/:find			detail view		/search/ana
		/admin/:kind			admin view		/admin/photo
		/admin/:kind/:safekey	form view		/admin/photo/agxkZXZ-YW5kc25ld3NyGgsSBVBob3RvIg9uYXNlLXBsYXZvLW9rY2UM
		-->

		<app-location route="{{route}}" use-hash-as-path></app-location>

		<app-route
			route="{{route}}"
			pattern="/admin/:kind"
			data="{{dataAdmin}}"
			tail="{{tailAdmin}}"
			active="{{activeAdmin}}"></app-route>

		<app-route
			route="{{tailAdmin}}"
			pattern="/:safekey"
			data="{{dataForm}}"
			active="{{activeForm}}"></app-route>

		<app-route
			route="{{route}}"
			pattern="/:kind"
			data="{{dataKind}}"
			tail="{{tailGrid}}"
			active="{{activeGrid}}"></app-route>

		<app-route
			route="{{tailGrid}}"
			pattern="/:field"
			data="{{dataField}}"
			tail="{{tailField}}"
			active="{{activeFind}}"></app-route>

		<app-route
			route="{{tailField}}"
			pattern="/:value"
			data="{{dataValue}}"
			active="{{activeFilter}}"></app-route>

		<iron-media-query query="max-width: 767px" query-matches="{{smallScreen}}"></iron-media-query>

		<paper-dialog id="google" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<h2>Google authorization</h2>
			<google-signin
				brand="google"
				height="tall"
				width="wide"
				client-id="719127177629-l03racul4r8fsvs31l4fonlk51k04t92.apps.googleusercontent.com"></google-signin>

			<google-signin-aware
				is-authorized="{{isAuthorized}}"
				on-google-signin-aware-success="handleSignIn"></google-signin-aware>
        </paper-dialog>

		<app-drawer id="drawer" swipe-open>
			<app-toolbar>
				<h1 main-title>ANDрејевићи</h1>
				<img class="avatar" on-tap="handleSignOut" src="[[userImg(user)]]">
			</app-toolbar>
			<paper-menu attr-for-selected="kind-page" selected="[[dataKind.kind]]" class="layout vertical">
				<paper-item kind-page="photo" on-tap="resetFilter">
					<a href="#/photo" class="flex">
						<iron-icon icon="image:photo-camera"></iron-icon>Photos
					</a>
				</paper-item>
				<paper-item kind-page="entry" on-tap="resetFilter">
					<a href="#/entry" class="flex">
						<iron-icon icon="description"></iron-icon>Texts
					</a>
				</paper-item>
				<template is="dom-if" if="[[_isKindPhoto(dataKind.kind)]]">
					<paper-item kind-page="photo" on-tap="resetFilter">
						<a href="#/admin/photo" class="flex">
							<iron-icon icon="settings"></iron-icon>Admin
						</a>
					</paper-item>
				</template>
				<template is="dom-if" if="[[!_isKindPhoto(dataKind.kind)]]">
					<paper-item kind-page="entry" on-tap="resetFilter">
						<a href="#/admin/entry" class="flex">
							<iron-icon icon="settings"></iron-icon>Admin
						</a>
					</paper-item>
				</template>
			</paper-menu>
			<paper-item>[[version]]</paper-item>
		</app-drawer>

		<app-header-layout>
			<app-header condenses reveals fixed effects="waterfall resize-title blend-background parallax-background">
				<app-toolbar>
					<template is="dom-if" if="[[_isDetailView(activeView)]]">
						<paper-icon-button icon="chevron-left" on-tap="resetFilter"></paper-icon-button>
					</template>
					<!-- <template is="dom-if" if="[[_isFormView(activeView)]]">
						<paper-icon-button icon="chevron-left" on-tap="resetFilter"></paper-icon-button>
					</template> -->
					<template is="dom-if" if="[[!_isDetailView(activeView)]]">
						<template is="dom-if" if="[[smallScreen]]">
							<paper-icon-button icon="menu" on-tap="_drawerToggle"></paper-icon-button>
						</template>
					</template>

	  				<h4 condensed-title>{{headline}}</h4>

					<template is="dom-if" if="[[!_isDetailView(activeView)]]">
						<template is="dom-if" if="[[!smallScreen]]">
							<iron-selector attr-for-selected="kind-page" selected="[[dataKind.kind]]">
								<a href="#/photo" kind-page="photo" on-tap="resetFilter">
									<paper-button>Photos</paper-button></a>
								<a href="#/entry" kind-page="entry" on-tap="resetFilter">
									<paper-button>Texts</paper-button></a>
								<template is="dom-if" if="[[_isKindPhoto(dataKind.kind)]]">
									<a href="#/admin/photo" kind-page="photo" on-tap="resetFilter">
										<paper-button>Admin</paper-button></a>
								</template>
								<template is="dom-if" if="[[!_isKindPhoto(dataKind.kind)]]">
									<a href="#/admin/entry" kind-page="entry" on-tap="resetFilter">
										<paper-button>Admin</paper-button></a>
								</template>
							</iron-selector>
						</template>
						<app-search
							field="{{dataField.field}}"
							value="{{dataValue.value}}"
							route="{{route}}"></app-search>
					</template>
	    		</app-toolbar>
	    		<app-toolbar>
	      			<h1 main-title>{{headline}}</h1>

					<template is="dom-if" if="[[_isDetailView(activeView)]]">
						<template is="dom-if" if="[[_isKindPhoto(dataKind.kind)]]">
							<paper-icon-button icon="more-vert" on-tap="showExif"></paper-icon-button>
						</template>
					</template>
					<template is="dom-if" if="[[!smallScreen]]">
						<template is="dom-if" if="[[!_isDetailView(activeView)]]">
							<paper-spinner active$="[[loading]]"></paper-spinner>
							<img class="avatar" on-tap="handleSignOut" src="[[userImg(user)]]">
						</template>
					</template>
	    		</app-toolbar>
			</app-header>

			<main>
				<app-scrollpos-control selected="{{activeView}}"></app-scrollpos-control>
				<neon-animated-pages selected="{{activeView}}" attr-for-selected="data-view">
					<grid-view
						data-view="grid"
						view="[[activeView]]"
						kind="[[dataKind.kind]]"
						route="{{route}}"
						loading="{{loading}}"></grid-view>

					<detail-view
						data-view="detail"
						view="[[activeView]]"
						kind="[[dataKind.kind]]"
						field="[[dataField.field]]"
						value="[[dataValue.value]]"
						loading="{{loading}}"
						headline="{{headline}}"></detail-view>

					<admin-view
						is-authorized="{{isAuthorized}}"
						data-view="admin"
						view="[[activeView]]"
						kind="[[dataAdmin.kind]]"
						route="{{route}}"
						loading="{{loading}}"></admin-view>

					<form-view
						is-authorized="{{isAuthorized}}"
						data-view="form"
						view="[[activeView]]"
						kind="[[dataAdmin.kind]]"
						safekey="[[dataForm.safekey]]"
						route="{{route}}"></form-view>
				</neon-animated-pages>
			</main>
		</app-header-layout>
	</template>

	<script>
		Polymer({
			is: 'app-shell',
			attached: function() {
				if (!this.route.path) {
					this.set('route.path', '/photo');
					this.set('dataKind.kind', 'photo');
				}
				// this.set('dataField.field', null);
				// this.set('dataValue.value', null);
			},
			properties: {
				version: { type: String, value: '160810'},
				headline: { type: String, value: 'ANDрејевићи', notify: true },
				smallScreen: { type: Boolean, value: false, notify: true },
				isAuthorized: { type: Boolean, value: false, notify: true },
				user: { type: Object, notify: true },
				loading: { type: Boolean, value: false, notify: true },
				activeGrid: { type: Boolean, value: false },
				activeFilter: { type: Boolean, value: false },
				activeFind: { type: Boolean, value: false },
				activeAdmin: { type: Boolean, value: false },
				activeForm: { type: Boolean, value: false },
				activeView: {
					type: String,
					computed: '_activeView(activeGrid, activeFilter, activeFind, activeAdmin, activeForm)',
					notify: true
				},
			},
			listeners: {
                'show-google': '_showGoogle',
				'google-signin-success': '_closeGoogle'
            },
			_activeView: function(activeGrid, activeFilter, activeFind, activeAdmin, activeForm) {
				console.log(+ activeGrid, + activeFilter, + activeFind, + activeAdmin, + activeForm);
				var active = [+ activeGrid, + activeFilter, + activeFind, + activeAdmin, + activeForm],
					result = parseInt(active.join(''), 2); // TODO: binary -> decimal

 				switch (result) {
					case 16: return 'grid';
					case 20: return 'detail'; // from search
					case 22: return 'admin';
					case 28: return 'detail'; // filter
					case 31: return 'form';
					default: return 'grid';
				}
			},
			resetFilter: function(e) {
				if (this.dataKind.kind == 'search') {
					this.set('dataKind.kind', 'photo');
				}
				this.set('dataField.field', null);
				this.set('dataValue.value', null);
				this.headline = 'ANDрејевићи'
				this.$.drawer.close();

				this.set('route.path', ['', this.dataKind.kind].join('/'));
			},
			_isDetailView: function(view) {
				return view == 'detail';
			},
			_isFormView: function(view) {
				return view == 'form';
			},
			_drawerToggle: function() {
				this.$.drawer.toggle();
			},
			_isKindPhoto: function(kind) {
				return kind == 'photo'
			},
			showExif: function(e) {
				this.$$('detail-view').fire('show-exif');
            },
			_showGoogle: function() {
				this.$.google.open();
			},
			_closeGoogle: function() {
				this.$.google.close();
			},
			handleSignIn: function(response) {
                this.user = gapi.auth2.getAuthInstance()['currentUser'].get();
				// console.log(.getBasicProfile().getId());
				// console.log(.getBasicProfile().getName());
				// console.log(.getBasicProfile().getEmail());
				// console.log(.getBasicProfile().getImageUrl());
            },
			userImg: function(user) {
				if (user) return user.getBasicProfile().getImageUrl();
				return ''
			},
			handleSignOut: function() {
				if (this.user) {
					this.user.disconnect();
					this.user = null;
				}
			}
		});
	</script>
</dom-module>
