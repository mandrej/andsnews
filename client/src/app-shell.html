<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="redux-store.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="app-icons.html">
<link rel="import" href="grid-view.html">

<dom-module id="app-shell">
  <template>
    <style include="shared-styles">
      #spinner {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
      }
    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>

    <app-route
      route="{{route}}"
      pattern="/:view"
      data="{{dataView}}"
      tail="{{tailView}}"></app-route>

    <app-route
      route="{{tailView}}"
      pattern="/:kind"
      data="{{dataKind}}"
      tail="{{tailKind}}"></app-route>

    <app-route
      route="{{tailKind}}"
      pattern="/:field"
      data="{{dataField}}"
      tail="{{tailField}}"></app-route>

    <app-route
      route="{{tailField}}"
      pattern="/:value"
      data="{{dataValue}}"
      tail="{{tailValue}}"></app-route>

    <firebase-app
      app="{{firebase}}"
      name="andsnews"
      api-key="AIzaSyBj5uKo0P_mir_ChQ_syx_kUQ_g7nkNy6M"
      auth-domain="andsnews.firebaseapp.com"
      database-url="https://andsnews.firebaseio.com"
      storage-bucket="andsnews.appspot.com"
      messaging-sender-id="719127177629"></firebase-app>

    <firebase-auth id="auth"
      app-name="andsnews"
      user="{{user}}"
      online="{{online}}"
      signed-in="{{isAuthorized}}"
      provider="google"></firebase-auth>

    <paper-dialog id="deleteDialog"
      modal
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      on-iron-overlay-closed="deleteRecord">
      <h2>Are you sure?</h2>
      <div class="layout horizontal center-justified">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="authorizationDialog"
      modal
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation">
      <h2>Authorization Required</h2>
      <p>Please Sign-In with your Google Account</p>
      <div class="layout horizontal center-justified">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="_sign">OK</paper-button>
      </div>
    </paper-dialog>

    <div id="spinner" class="layout horizontal center-justified">
      <paper-spinner class="self-center" active$="[[loading]]"></paper-spinner>
    </div>

    <app-drawer-layout responsive-width="1024px">
      <app-drawer id="drawer">
        <app-header fixed>
          <app-toolbar>
            <a hidden$="[[!isAuthorized]]" class="self-center" href="#" on-tap="_sign">
              <iron-image src="[[userImg(user)]]" class="thumbnail" preload fade sizing="cover"></iron-image>
            </a>
            <a hidden$="[[isAuthorized]]" class="self-center" href="#" on-tap="_sign">Sign-In</a>
          </app-toolbar>
        </app-header>

        <paper-item>
          <app-search field="{{dataField.field}}" value="{{dataValue.value}}" route="{{route}}"></app-search>
        </paper-item>

        <paper-listbox>
          <a href="#/grid/photo">
            <paper-item><iron-icon icon="app:photo-camera"></iron-icon> Photos</paper-item></a>
          <a href="#/grid/entry">
            <paper-item><iron-icon icon="app:description"></iron-icon> Texts</paper-item></a>
          <a hidden$="[[!isAdmin]]" href="#/maintenance">
            <paper-item><iron-icon icon="app:settings"></iron-icon> Admin</paper-item></a>
        </paper-listbox>

        <paper-listbox hidden$="[[!_isDetailView(dataView.view)]]">
          <paper-item hidden$="[[!isAdmin]]" on-tap="editRecord">
            <iron-icon icon="app:create"></iron-icon> Edit</paper-item>
          <!--<paper-item hidden$="[[!_isKindPhoto(itemKind)]]" on-tap="zoomPhoto">
            <iron-icon icon="[[zoomIcon]]"></iron-icon> Zoom</paper-item>-->
        </paper-listbox>
      </app-drawer>

      <app-header-layout>
        <app-header reveals condenses shadow>
          <app-toolbar></app-toolbar>
          <app-toolbar>
            <paper-icon-button icon="app:menu" drawer-toggle></paper-icon-button>
            <h1 main-title>{{headline}}</h1>
            <paper-fab hidden$="[[!_canAddRecord(dataView.view, isAuthorized)]]"
              mini icon="app:add" on-tap="addRecord"></paper-fab>
            <paper-icon-button hidden$="[[!_canShowInfo(dataView.view, itemKind)]]" icon="app:more-vert"
              on-tap="showInfo"></paper-icon-button>
          </app-toolbar>
        </app-header>

        <iron-pages selected="{{dataView.view}}" attr-for-selected="data-view" fallback-selection="error404">
          <grid-view
            data-view="grid"
            kind="[[dataKind.kind]]"
            view="[[dataView.view]]"
            route="{{route}}"
            loading="{{loading}}"></grid-view>

          <detail-view
            data-view="detail"
            is-authorized="{{isAuthorized}}"
            kind="[[dataKind.kind]]"
            field="[[dataField.field]]"
            value="[[dataValue.value]]"
            loading="{{loading}}"
            route="{{route}}"></detail-view>

          <form-view
            data-view="form"
            is-authorized="{{isAuthorized}}"
            kind="[[dataKind.kind]]"
            field="[[dataField.field]]"
            value="[[dataValue.value]]"
            route="{{route}}"></form-view>

          <admin-shell
            data-view="maintenance"
            route="{{route}}"></admin-shell>

          <error-404 data-view="error404"></error-404>
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    Polymer({
      is: 'app-shell',
      behaviors: [ ReduxBehavior ],
      ready: function () {
        if (!this.route.path) {
          this.set('route.path', '/grid/photo');
        }
        this.firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            this.dispatch('change', {
              isAdmin: user.email == 'milan.andrejevic@gmail.com'
            });
          } else {
            this.dispatch('change', {
              isAdmin: false
            });
          }
        }.bind(this));
      },
      actions: {
        change: function (payload) {
          return {
            type: 'CURRENT_CHANGED',
            payload: payload
          }
        }
      },
      listeners: {
        'confirm-delete': 'confirmDelete'
      },
      observers: [
        'viewChanged(dataView.view)',
        // 'pathChanged(route.path)'
      ],
      properties: {
        version: { type: String, value: '201705201138' },
        loading: { type: Boolean, value: false, notify: true },
        dataValue: { type: Object, value: { value: null } }, // initial set value to null, otherwise search won't work
        user: { type: Object, notify: true },
        headline: { type: String, statePath: 'headline' },
        isAdmin: { type: Boolean, statePath: 'isAdmin' },
        itemKind: { type: String, statePath: 'kind' },
        zooming: { type: String, statePath: 'zooming' },
        zoomIcon: { type: String, statePath: function(state) {
          return (state.zooming) ? 'app:zoom-out' : 'app:zoom-in';
        }},
      },
      error404: function () {
        this.set('dataView.view', '___');
        Polymer.Base.importHref('src/error-404.html');
      },
      viewChanged: function (view) {
        const dialog = this.$.authorizationDialog;
        const allowed_kinds = ['photo', 'entry', 'search'];
        this._drawerClose();
        this.debounce('viewChanged', function () {
          switch (view) {
            case 'grid':
              this.set('dataField.field', null);
              this.set('dataValue.value', null);
              if (allowed_kinds.indexOf(this.dataKind.kind) === -1) {
                this.error404();
                break;
              } else {
                this.dispatch('change', {
                  headline: 'ANDрејевићи',
                  kind: this.dataKind.kind,
                  view: 'display',
                  disableSwipe: false
                });
                Polymer.Base.importHref('src/app-search.html', null, null, true);
                break;
              }
            case 'detail':
              if (allowed_kinds.indexOf(this.dataKind.kind) === -1) {
                this.error404();
                break;
              } else {
                Polymer.Base.importHref('src/detail-view.html', null, null, true);
                break;
              }
            case 'form':
              if (allowed_kinds.indexOf(this.dataKind.kind) === -1 || this.dataField.field !== 'add') {
                this.error404();
                break;
              } else {
                this.dispatch('change', {
                  headline: 'Form',
                  kind: this.dataKind.kind
                });
                Polymer.Base.importHref('src/form-view.html', function () {
                  if (!this.isAuthorized) dialog.open();
                }.bind(this), null, true);
                break;
              }
            case 'maintenance':
              this.dispatch('change', {
                headline: 'Admin v.' + this.version
              });
              Polymer.Base.importHref('src/admin-shell.html', function () {
                if (!this.isAdmin) dialog.open();
              }.bind(this), null, true);
              break;
            default:
              Polymer.Base.importHref('src/error-404.html');
          }
        }, 0);
      },
      _canAddRecord: function (view, isAuthorized) {
        return view === 'grid' && isAuthorized;
      },
      _canShowInfo: function (view, kind) {
        return view === 'detail' && kind === 'photo';
      },
      _isDetailView: function (view) {
        return view === 'detail';
      },
      _sign: function () {
        if (this.user) {
          this.$.auth.signOut();
        } else {
          this.$.auth.signInWithPopup()
            .then(function (response) {
              // response.credential.accessToken
              // response.user.uid
            }).catch(function (error) {
              console.log(error);
            });
        }
      },
      userName: function (user) {
        if (user) return user.displayName;
      },
      userImg: function (user) {
        if (user) return user.photoURL;
      },
      addRecord: function (e) {
        this.set('dataValue.value', null);
        this.set('route.path', ['/form', this.dataKind.kind, 'add'].join('/'));
      },
      editRecord: function (e) {
        this._drawerClose();
        this.$$('detail-view').fire('edit-record');
      },
      confirmDelete: function (e) {
        this.$.deleteDialog.open();
      },
      deleteRecord: function (e) {
        if (e.detail.confirmed) {
          this.$$('detail-view').fire('delete-record');
        }
      },
      showInfo: function () {
        this._drawerClose();
        this.$$('detail-view').$$('.iron-selected').fire('info-toggle');
      },
      zoomPhoto: function () {
        this._drawerClose();
        const state = this.getState();
        this.dispatch('change', {
          disableSwipe: !state.disableSwipe,
          zooming: !state.zooming
        });

        this.$$('detail-view').$$('.iron-selected').fire('zoom-toggle');
      },
      _drawerClose: function() {
        if (!this.$.drawer.persistent) this.$.drawer.close();
      },
      pathChanged: function (path) {
        console.log(path);
      },
      objectChanged: function (obj) {
        // this is object observer!
        if (obj && obj.path) console.log(obj.path + ' -> ' + this.get(obj.path));
      },
      propertyChanged: function (newValue, oldValue) {
        console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
      },
    });
  </script>
</dom-module>
