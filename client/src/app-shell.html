<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-scrollpos-control/app-scrollpos-control.html">
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable-behavior.html">

<link rel="import" href="app-search.html">
<link rel="import" href="grid-view.html">
<link rel="import" href="detail-view.html">
<link rel="import" href="admin-shell.html">
<link rel="import" href="form-view.html">

<dom-module id="app-shell">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment"></style>
		<style>
			:host {
				--app-background-color: #ffffff;
				--app-primary-color: #3367d6;
        		--app-secondary-color: #f4b400;
        		--app-secondary-light: #f2d279;
        		--app-alert-color: #db4437;
        		--app-grey-color: #737373;
        		--app-text-color: #212121;
				display: block;
			}
			app-header {
				color: var(--app-text-color);
				z-index: 1;
				background-color: var(--app-background-color);
				@apply(--shadow-elevation-2dp);
          	}
			app-toolbar a, paper-item a {
				color: inherit;
				text-decoration: none;
			}
			app-drawer {
				top: 0;
				bottom: 0;
				z-index: 2;
				--app-drawer-content-container: {
					padding: 0;
				}
			}
			app-drawer app-toolbar {
				color: var(--app-text-color);
				background-color: var(--app-background-color);
				@apply(--shadow-elevation-2dp);
			}
            paper-item iron-icon {
                margin-right: 16px;
                color: var(--app-grey-color);
            }
			paper-button {
				text-transform: lowercase;
			}
			.add {
				/*http://stackoverflow.com/questions/6794000/fixed-position-but-relative-to-container*/
				position: absolute;
				width: calc(56px + 28px);
				top: 100px;
				right: 0;
				z-index: 10;
			}
			.fixed {
				width: calc(56px + 28px);
				position: fixed;
			}
			paper-fab {
                --paper-fab-background: var(--app-secondary-color);
                --paper-fab-keyboard-focus-background: var(--app-secondary-light);
            }
			main {
				background: var(--app-background-color);
				position: relative;
				height: 100vh;
			}
			#spinner {
				position: absolute;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
			}
			paper-spinner {
				width: 100px;
				height: 100px;
				--paper-spinner-stroke-width: 8px;
			}
			h1, h4 {
				margin: 0;
				font-size: 36px;
				font-weight: 300;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			[condensed-title] {
				font-size: 24px;
			}
			[hidden] {
				display: none !important;
			}
			@media (max-width: 767px) {
        		h1 {
					margin: 0 12px;
					font-size: 24px;
				}
        	}
		</style>

		<app-location route="{{route}}" use-hash-as-path></app-location>

		<app-route
			route="{{route}}"
			pattern="/:view"
			data="{{dataView}}"
			tail="{{tailView}}"></app-route>

		<app-route
			route="{{tailView}}"
			pattern="/:kind"
			data="{{dataKind}}"
			tail="{{tailKind}}"></app-route>

		<app-route
			route="{{tailKind}}"
			pattern="/:field"
			data="{{dataField}}"
			tail="{{tailField}}"></app-route>

		<app-route
			route="{{tailField}}"
			pattern="/:value"
			data="{{dataValue}}"></app-route>

		<iron-media-query query="max-width: 767px" query-matches="{{smallScreen}}"></iron-media-query>

		<google-signin-aware id="aware"
            client-id="719127177629-l03racul4r8fsvs31l4fonlk51k04t92.apps.googleusercontent.com"
            is-authorized="{{isAuthorized}}"
            on-google-signin-aware-success="handleSignIn"></google-signin-aware>

		<iron-request id="delete_ajax"></iron-request>

		<app-drawer id="drawer" swipe-open>
			<app-toolbar>
				<h1 condensed-title>ANDрејевићи</h1>
			</app-toolbar>
			<paper-menu selected="[[dataKind.kind]]" attr-for-selected="kind-page" class="layout vertical">
				<paper-item kind-page="photo">
					<a href="#/grid/photo" class="flex">
						<iron-icon icon="image:photo-camera"></iron-icon>Photos
					</a>
				</paper-item>
				<paper-item kind-page="entry">
					<a href="#/grid/entry" class="flex">
						<iron-icon icon="description"></iron-icon>Texts
					</a>
				</paper-item>
			</paper-menu>

			<template is="dom-if" if="{{isAuthorized}}">
				<paper-item on-tap="_signOut">
					<iron-icon icon="settings"></iron-icon>[[userName(user)]]
				</paper-item>
			</template>
			<template is="dom-if" if="{{!isAuthorized}}">
				<paper-item on-tap="_signIn">
					<iron-icon icon="settings"></iron-icon>Google Sign-In
				</paper-item>
			</template>

			<paper-item>ver.[[version]]</paper-item>
		</app-drawer>

		<template is="dom-if" if="[[_isGridView(dataView.view)]]">
			<div hidden$="{{!isAuthorized}}" class="add">
				<div class="fixed">
					<paper-fab icon="add" on-tap="addRecord"></paper-fab>
				</div>
			</div>
		</template>

		<app-header-layout>
			<app-header condenses reveals fixed effects="waterfall resize-title">
				<app-toolbar>
					<template is="dom-if" if="[[!_isDetailView(dataView.view)]]">
						<paper-icon-button icon="menu" on-tap="_drawerToggle"></paper-icon-button>
					</template>

	  				<h4 condensed-title>{{headline}}</h4>

					<template is="dom-if" if="[[_isDetailView(dataView.view)]]">
						<div hidden$="{{!isAuthorized}}" class="layout horizontal">
				            <paper-icon-button icon="clear" on-tap="deleteRecord"></paper-icon-button>
							<template is="dom-if" if="[[_isKindPhoto(dataKind.kind)]]">
								<paper-icon-button icon="file-download" on-tap="downloadPhoto"></paper-icon-button>
							</template>
				            <paper-icon-button icon="create" on-tap="editRecord"></paper-icon-button>
				        </div>
						<template is="dom-if" if="[[_isKindPhoto(dataKind.kind)]]">
							<paper-icon-button icon="more-vert" on-tap="showExif"></paper-icon-button>
						</template>
					</template>

					<template is="dom-if" if="[[!_isDetailView(dataView.view)]]">
						<template is="dom-if" if="[[!smallScreen]]">
							<iron-selector attr-for-selected="kind-page" selected="[[dataKind.kind]]">
								<a href="#/grid/photo" kind-page="photo">
									<paper-button>Photos</paper-button></a>
								<a href="#/grid/entry" kind-page="entry">
									<paper-button>Texts</paper-button></a>
							</iron-selector>
						</template>
						<app-search
							field="{{dataField.field}}"
							value="{{dataValue.value}}"
							route="{{route}}"></app-search>
					</template>
	    		</app-toolbar>
	    		<app-toolbar>
	      			<h1 main-title>{{headline}}</h1>
	    		</app-toolbar>
			</app-header>

			<main id="main">
				<div id="spinner" class="layout horizontal center-justified">
					<paper-spinner class="self-center" active$="[[loading]]"></paper-spinner>
				</div>
				<app-scrollpos-control selected="{{dataView.view}}"></app-scrollpos-control>
				<neon-animated-pages selected="{{dataView.view}}" attr-for-selected="data-view">

					<admin-shell
						data-view="admin"
						is-authorized="{{isAuthorized}}"
						route="{{route}}"></admin-shell>

					<grid-view
						data-view="grid"
						kind="[[dataKind.kind]]"
						field="{{dataField.field}}"
						value="{{dataValue.value}}"
						route="{{route}}"
						loading="{{loading}}"></grid-view>

					<detail-view
						data-view="detail"
						kind="[[dataKind.kind]]"
						field="[[dataField.field]]"
						value="[[dataValue.value]]"
						records="{{records}}"
						start="{{start}}"
						loading="{{loading}}"
						headline="{{headline}}"
						route="{{route}}"></detail-view>

					<form-view
						data-view="form"
						view="[[dataView.view]]"
						is-authorized="{{isAuthorized}}"
						user="[[user]]"
						kind="[[dataKind.kind]]"
						field="[[dataField.field]]"
						value="[[dataValue.value]]"
						route="{{route}}"></form-view>

				</neon-animated-pages>
			</main>
		</app-header-layout>
	</template>

	<script>
		Polymer({
			is: 'app-shell',
			behaviors: [
                Polymer.NeonAnimatableBehavior
            ],
			attached: function() {
				if (!this.route.path) {
					this.set('route.path', '/grid/photo');
				}
			},
			properties: {
				version: { type: String, value: '160825'},
				headline: { type: String, value: 'ANDрејевићи', notify: true },
				smallScreen: { type: Boolean, value: false, notify: true },
				isAuthorized: { type: Boolean, value: false, notify: true },
				user: { type: Object, notify: true },
				dataView: { type: Object, value: {view: null} },
				dataKind: { type: Object, value: {kind: null} },
				dataField: { type: Object, value: {field: null} },
				dataValue: { type: Object, value: {value: null} },
				loading: { type: Boolean, value: false, notify: true },
				records: { type: Array, value: [], notify: true },
				start: { type: Number, value: 0, notify: true },
			},
			observers: [
				'viewChanged(dataView.view, dataKind.kind, dataField.field, dataValue.value)'
			],
			viewChanged: function(view, kind, field, value) {
				this.debounce('viewChanged', function() {
					console.log(view, kind, field, value);
				}, 100);
				if (this.$.drawer.opened) this.$.drawer.close();
				this.headline = 'ANDрејевићи';
				this.records = [];
				this.start = 0;
			},
			_isGridView: function(view) {
				return view == 'grid'
			},
			_isDetailView: function(view) {
				return view == 'detail';
			},
			_isFormView: function(view) {
				return view == 'form';
			},
			_drawerToggle: function() {
				this.$.drawer.toggle();
			},
			_isKindPhoto: function(kind) {
				return kind == 'photo'
			},
			_signIn: function() {
                this.$.aware.signIn();
            },
			_signOut: function() {
				if (this.user) {
					this.user.disconnect();
					this.isAuthorized = false;
					this.user = null;
				}
				gapi.auth2.getAuthInstance().signOut();
			},
			handleSignIn: function(response) {
                this.user = gapi.auth2.getAuthInstance()['currentUser'].get();
                this.$.google.innerText = this.user.getBasicProfile().getName() + ' Sign-Out';
				// console.log(this.user.getBasicProfile().getId());
				// .getBasicProfile().getName();
				// .getBasicProfile().getEmail();
				// .getBasicProfile().getImageUrl();
            },
			userName: function(user) {
				return user.getBasicProfile().getName();
			},
			downloadPhoto: function(e) {
				window.location.href = '/api/download/' + this.records[this.start].safekey;
			},
			addRecord: function(e) {
				this.async(function() {
					this.value = null;
					this.set('route.path', ['/form', this.dataKind.kind, 'add'].join('/'));
				}, 200);
			},
			deleteRecord: function(e) {
				var obj = this.splice('records', this.start, 1)[0];
				this.start ++;
				this.$.delete_ajax.send({url: '/api/delete/' + obj.safekey, method: 'DELETE'});
				// this.notifySplices('records', obj);
			},
			editRecord: function(e) {
				var obj = this.records[this.start];
				this.async(function() {
					this.set('route.path', ['/form', obj.kind, 'edit', obj.safekey].join('/'));
				}, 200);
			},
			showExif: function(e) {
				this.$$('detail-view').fire('show-exif');
            },
			objectChanged: function(obj) {
                // this is object observer!
				if (obj && obj.path) console.log(obj.path + ' -> ' + this.get(obj.path));
            },
			propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
		});
	</script>
</dom-module>
