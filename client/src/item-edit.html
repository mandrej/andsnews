<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input-autocomplete-chips/paper-input-autocomplete.html">
<link rel="import" href="../bower_components/paper-input-autocomplete-chips/paper-input-autocomplete-chips.html">
<link rel="import" href="./redux-store.html">

<link rel="import" href="./shared-styles.html">

<dom-module id="item-edit">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      .container {
        min-height: calc(100vh - 32px);
        padding: 16px;
        background-color: var(--primary-background-color);
      }
      paper-button {
        margin-top: 8px;
      }
      paper-input,
      vaadin-combo-box,
      paper-input-autocomplete-chips {
        --paper-input-container-color: var(--primary-text-color);
        --paper-input-container-focus-color: var(--primary-color);
      }
    </style>

    <iron-ajax auto
      url="[[_urlTagsCloud(view, item)]]"
      handle-as="json"
      last-response="{{tags_cloud}}"
      debounce-duration="100"></iron-ajax>

    <!--<iron-ajax auto
      url="[[_urlLensCloud(view, item)]]"
      handle-as="json"
      last-response="{{lens_cloud}}"
      debounce-duration="100"></iron-ajax>-->

    <form id="form" class="container"
      is="iron-form"
      on-iron-form-response="_responseHandler"
      action$="/api/[[item.kind]]/edit/[[item.safekey]]"
      method="post">

      <paper-toast id="toast" class="fit-bottom" on-iron-overlay-closed="_viewDisplay"></paper-toast>

      <div class="layout horizontal justified">
        <template is="dom-if" if="[[isAdmin]]">
          <paper-button on-tap="_remove" class="accent" raised>Remove</paper-button>
        </template>
        <div>
          <paper-button on-tap="_viewDisplay" raised>Cancel</paper-button>
          <paper-button on-tap="_submit" class="accent" raised>Submit</paper-button>
        </div>
      </div>

      <paper-input name="headline" required label="headline" value="{{item.headline}}"></paper-input>

      <vaadin-combo-box
        name="author"
        required
        auto-validate
        label="author"
        allow-custom-value="true"
        items='["milan.andrejevic@gmail.com", "mihailo.genije@gmail.com", "svetlana.andrejevic@gmail.com", "ana.devic@gmail.com", "dannytaboo@gmail.com", "zile.zikson@gmail.com"]'
        value="{{item.author}}"></vaadin-combo-box>

      <paper-input-autocomplete-chips id="tags"
        name="tags"
        label="tags"
        local-candidates="{{listObjects(tags_cloud)}}"
        selected-objects="{{listObjects(item)}}"
        allow-select-unknown-token animated no-chip-image></paper-input-autocomplete-chips>

      <paper-input name="date" label="date" value="{{item.date}}"></paper-input>

      <template is="dom-if" if="[[_isKindPhoto(item)]]">
        <paper-input name="model" label="model" value="{{item.model}}"></paper-input>
        <div class="layout horizontal justified wrap">
          <!--<vaadin-combo-box name="lens" label="lens" allow-custom-value="true" items="{{lens_cloud}}" value="{{item.lens}}" style="width: 201px"></vaadin-combo-box>-->
          <paper-input name="lens" label="lens" value="{{item.lens}}"></paper-input>
          <paper-input name="focal_length" label="focal_length [mm]" value="{{item.focal_length}}"></paper-input>
          <paper-input name="iso" label="iso [ASA]" value="{{item.iso}}"></paper-input>
          <paper-input name="aperture" label="aperture" value="{{item.aperture}}"></paper-input>
          <paper-input name="shutter" label="shutter [s]" value="{{item.shutter}}"></paper-input>
          <input type="hidden" name="color" value="{{item.color}}">
          <paper-input disabled label="color" value="{{item.color}}"></paper-input>
        </div>
      </template>

      <template is="dom-if" if="[[!_isKindPhoto(item)]]">
        <paper-textarea name="summary" label="summary" value="{{item.summary}}"></paper-textarea>
        <paper-textarea name="front_img" label="front image" value="{{item.front_img}}"></paper-textarea>
        <paper-textarea name="body" label="body" value="{{item.body}}"></paper-textarea>
      </template>
    </form>
  </template>
  <script>
    Polymer({
      is: 'item-edit',
      behaviors: [ ReduxBehavior ],
      listeners: {
        'iron-form-presubmit': '_preSubmit'
      },
      actions: {
        change: function (payload) {
          return {
            type: 'CURRENT_CHANGED',
            payload: payload
          }
        }
      },
      properties: {
        isAdmin: { type: Boolean, statePath: 'isAdmin' },
      },
      _urlTagsCloud: function (view, item) {
        if (view !== 'form') return;
        if (item.kind === 'photo') {
          return '/api/suggest/Photo_tags';
        } else {
          return '/api/suggest/Entry_tags';
        }
      },
      // _urlLensCloud: function (view, item) {
      //   if (view === 'form' && item.kind === 'photo') {
      //     return '/api/suggest/Photo_lens';
      //   }
      // },
      _preSubmit: function (e) {
        const form = this.$.form,
          tagsInput = this.$.tags.selectedObjects,
          tags = [];
        tagsInput.forEach(function (item) {
          tags.push(item.text);
        })
        form.request.body['tags'] = tags.join(',');
        // console.log(form.request.body);
        // FORM POST CHANGE TO PUT (PUT INITIALLY SENDS URL PARAMETERS, POST DOES NOT)
        form.request.method = 'put';
      },
      _remove: function (e) {
        Polymer.dom().querySelector('app-shell').fire('confirm-delete');
      },
      _submit: function (e) {
        // _submit calls _preSubmit
        const form = this.$.form;
        // var json = form.serialize();
        // console.log(json);
        form.submit();
      },
      _responseHandler: function (e) {
        const toast = this.$.toast;
        toast.fitInto = this.$.form;
        if (e.detail.xhr.status == 200) {
          toast.setAttribute('text', 'Record successfully created / updated');
          toast.open();
        }
      },
      _isKindPhoto: function (item) {
        return item.kind == 'photo';
      },
      listObjects: function (obj) {
        const list = [];
        if (obj.tags) {
          obj.tags.forEach(function (tag) {
            list.push({ 'text': tag });
          });
        } else {
          obj.forEach(function (tag) {
            list.push({ 'text': tag });
          });
        }
        return list;
      },
      _viewDisplay: function (e) {
        this.dispatch('change', {
          view: 'display',
          disableSwipe: false
        });
      }
    });
  </script>
</dom-module>
