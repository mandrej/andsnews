<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">

<dom-module id="list-filter">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                @apply(--layout-horizontal);
                @apply(--layout-start-aligned);
                @apply(--layout-wrap);
            }
            .rec {
                position: relative;
                width: 20%;
                height: 150px;
				cursor: pointer;
			}
            .rec iron-image {
                width: 100%;
                height: 100%;
            }
            .rec .title {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: rgba(0,0,0,0.5);
                /*background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);*/
                color: var(--dark-theme-text-color);
                font-size: 20px;
                padding: 16px;
                text-overflow: ellipsis;
            }
            paper-ripple {
				color: #fff;
			}
            @media (max-width: 1024px) { .rec { width: 25%; } }
            @media (max-width: 768px)  { .rec { width: 33.3333333%; } }
            @media (max-width: 432px)  { .rec { width: 50%; } }
        </style>

        <iron-ajax auto
			url="{{_urlFilter(kind)}}"
			handle-as="json"
			last-response="{{response}}"
			debounce-duration="100"></iron-ajax>

        <template is="dom-repeat" items="[[response]]" as="row">
            <template is="dom-repeat" items="[[row.items]]" as="rec" on-dom-change="_repeatRender">
                <div class="rec"
                    data-field$="[[row.field_name]]" on-tap="_applyFilter">
                    <iron-image src="[[rec.repr_url]]" preload sizing="cover"></iron-image>
                    <div class="title">
                        <div class="layout horizontal justified">
                            <span class="self-center">[[rec.name]]</span>
                            <span class="self-center">[[rec.count]]</span>
                        </div>
                    </div>
                    <paper-ripple></paper-ripple>
                </div>
            </template>
        </template>
    </template>
    <script>
        Polymer({
            is: 'list-filter',
            behaviors: [
                Polymer.NeonAnimationBehavior,
                Polymer.NeonAnimationRunnerBehavior,
            ],
            properties: {
                animationConfig: {
                    type: Object,
                    value: function() {
                        return {
                            'entry': [{
                                name: 'cascaded-animation',
                                animation: 'fade-in-animation',
                                nodeDelay: 50
                            }, {
                                name: 'cascaded-animation',
                                animation: 'transform-animation',
                                transformFrom: 'translateY(-56px)',
                                nodeDelay: 50
                            }]
                        }
                    }
                },
                kind: { type: String, value: null, notify: true },
				field: { type: String, value: null, notify: true },
				value: { type: String, value: null, notify: true },
                items: {
                    type: Array,
                    value: [],
                    notify: true
                },
                start: { type: Number, value: 0, notify: true },
            },
            _urlFilter: function(kind) {
				var prefix = '/api/filter';
				if (kind == 'photo' || kind == 'entry') {
					return [prefix, kind].join('/');
				} else {
					this.response = null;
				}
			},
            _applyFilter: function(e) {
                this.set('params.page', null);
                this.items = [];
				this.field = e.model.row.field_name;
				this.value = e.model.rec.name;
                this.start = 0;
				this.set('route.path', ['', this.kind, this.field, this.value].join('/'));
                // this.fire('menu-toggle');
                // document.querySelector('index-page').view = 'detail';
			},
            _repeatRender: function() {
                var nodes = Polymer.dom(this.root).querySelectorAll('.rec');
                this.animationConfig['entry'][0].nodes = nodes;
                this.animationConfig['entry'][1].nodes = nodes;
                this.playAnimation('entry');
            }
        });
    </script>
</dom-module>
