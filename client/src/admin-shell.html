<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="./shared-styles.html">

<dom-module id="admin-shell">
    <template>
        <style include="shared-styles iron-flex iron-flex-alignment">
            :host {
                display: block;
                position: relative;
                height: 100vh;
                background-color: var(--primary-background-color);
            }
            .container {
                padding: 16px;
                padding-bottom: 56px;
            }
            h1 {
                margin-bottom: 0.5em;
                font-weight: 300;
            }
            paper-toast {
                --paper-toast-color: var(--primary-background-color);
                --paper-toast-background-color: var(--primary-text-color);
            }
            paper-button {
                width: 150px;
                margin: 0 16px 16px 0;
			}
            paper-button[toggles][active] {
                background: var(--secondary-text-color);
            }
        </style>

        <!-- <firebase-document
            app="{{firebase}}"
            path="/users/[[user.uid]]/token"
            data="[[token]]"></firebase-document> -->

        <firebase-messaging id="messaging"
            app="{{firebase}}"
            token="{{token}}"
            on-message="handleMessage"></firebase-messaging>

        <iron-ajax auto
            url="[[_url(isAdmin)]]"
            last-response="{{info}}"></iron-ajax>

        <iron-ajax id="xhr"
            content-type="application/json"
            on-response="channelHandler"
            method="POST"></iron-ajax>

        <div class="container" id="container">
            <paper-toast id="toast" class="fit-bottom"></paper-toast>

            <div hidden$="[[!isAdmin]]" class="layout vertical wrap">
                <div>
                    <h1>Photo [[info.photo.count]]</h1>
                    <div class="layout horizontal justified wrap">
                        <template is="dom-repeat"
                            items="[[info.photo.counters]]" as="item">
                            <paper-button on-tap="rebuild" toggles raised>[[item]]</paper-button>
                        </template>

                        <paper-button disabled on-tap="reindex" data-kind="photo" toggles raised>Photo Reindex</paper-button>
                        <paper-button disabled on-tap="unbound" data-kind="photo" toggles raised>Photo Unbound</paper-button>
                        <paper-button disabled on-tap="fix" data-kind="photo" toggles raised>Migration</paper-button>
                    </div>
                </div>

                <div>
                    <h1>Entry [[info.entry.count]]</h1>
                    <div class="layout horizontal justified wrap">
                        <template is="dom-repeat"
                            items="[[info.entry.counters]]" as="item">
                            <paper-button on-tap="rebuild" toggles raised>[[item]]</paper-button>
                        </template>

                        <paper-button on-tap="reindex" data-kind="entry" class="accent" toggles raised>Entry Reindex</paper-button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'admin-shell',
            properties: {
                user: { type: Object, notify: true },
            },
            _url: function(isAdmin) {
                var view = Polymer.dom().querySelector('app-shell').dataView.view;
                if (view == 'maintenance' && isAdmin) {
                    return '/api/info';
                }
            },
            channelHandler: function(req) {
                var resp = req.detail.response;
                console.log(resp);
                // if (resp.userId != this.user.getBasicProfile().getId()) return;
                // var ref = this.firebase.database().ref(resp.channelId.replace('.json', ''));
                // var self = this;
                // ref.on('child_added', function(data) {
                //     self.onMessage(data.val());
                // });
			},
            onMessage: function (data) {
                var toast = this.$.toast;
                toast.fitInto = this.$.container;
                if (data) {
                    toast.setAttribute('text', data);
                    if (data.startsWith('END')) {
                        toast.style.backgroundColor = '#dc2128';
                    } else {
                        toast.style.backgroundColor = '#212121';
                    }
                    toast.open();
                }
            },
            handleMessage: function(data) {
                console.log(data.detail.message.notification.body);
                // console.log(arguments);
                var toast = this.$.toast;
                toast.fitInto = this.$.container;
                if (data) {
                    toast.setAttribute('text', data.detail.message.notification.body);
                    toast.open();
                }
            },
            rebuild: function(e) {
                // this.token = this.user.getAuthResponse().access_token;
                // this.user.uid = this.user.getBasicProfile().getId();
                var self = this;
                this.$.messaging.requestPermission().then(function() {
                    console.log(self.user);
                    console.log(self.token);
                    // permission was granted
                    self.$.xhr.url = '/api/rebuild/' + e.model.item;
                    self.$.xhr.body = JSON.stringify({'token': self.token});
                    self.$.xhr.generateRequest();
                }, function(err) {
                    // permission was denied
                });
            },
            reindex: function(e) {
                this.$.xhr.url = '/api/index/' + e.target.dataset.kind;
                this.$.xhr.body = JSON.stringify({'userId': this.user.getBasicProfile().getId()});
                this.$.xhr.generateRequest();
            },
            unbound: function(e) {
                this.$.xhr.url = '/api/unbound/' + e.target.dataset.kind;
                this.$.xhr.body = JSON.stringify({'userId': this.user.getBasicProfile().getId()});
                this.$.xhr.generateRequest();
            },
            fix: function(e) {
                this.$.xhr.url = '/api/fix/' + e.target.dataset.kind;
                this.$.xhr.body = JSON.stringify({'userId': this.user.getBasicProfile().getId()});
                this.$.xhr.generateRequest();
            },
        });
    </script>
</dom-module>
