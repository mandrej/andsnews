<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="./redux-store.html">

<link rel="import" href="./shared-styles.html">

<dom-module id="admin-shell">
  <template>
    <style include="shared-styles">
      .container {
        height: calc(100vh - 72px);
        padding: 16px 16px 56px 16px;
      }
      h1 {
        margin-bottom: 0.5em;
        font-weight: 300;
      }
      paper-button {
        min-width: 175px;
        margin-bottom: 16px;
      }
      paper-button[disabled],
      paper-button[toggles][active] {
        background: var(--secondary-text-color);
      }
    </style>

    <firebase-messaging id="messaging"
      app-name="andsnews"
      token="{{token}}"
      on-message="handleMessage"></firebase-messaging>

    <firebase-document
      log="true"
      app-name="andsnews"
      path="/users/[[user.uid]]/token"
      data="[[token]]"></firebase-document>

    <iron-ajax auto
      url="[[_url(isAdmin)]]"
      last-response="{{info}}"></iron-ajax>

    <iron-ajax id="xhr"
      content-type="application/json"
      method="POST"></iron-ajax>

    <div class="container" id="container">
      <paper-toast id="toast" class="fit-bottom"></paper-toast>

      <div hidden$="[[!isAdmin]]" class="layout vertical wrap">
        <div>
          <h1>Photo [[info.photo.count]]</h1>
          <div class="layout horizontal justified wrap">
            <template is="dom-repeat" items="[[info.photo.counters]]" as="item">
              <paper-button on-tap="rebuild" class="accent" toggles raised>[[item]]</paper-button>
            </template>

            <paper-button on-tap="reindex" data-kind="photo" toggles raised>Photo Reindex</paper-button>
            <paper-button disabled on-tap="unbound" data-kind="photo" toggles raised>Photo Unbound</paper-button>
            <paper-button disabled on-tap="fix" data-kind="photo" toggles raised>Migration</paper-button>
          </div>
        </div>

        <div>
          <h1>Entry [[info.entry.count]]</h1>
          <div class="layout horizontal justified wrap">
            <template is="dom-repeat" items="[[info.entry.counters]]" as="item">
              <paper-button on-tap="rebuild" class="accent" toggles raised>[[item]]</paper-button>
            </template>

            <paper-button on-tap="reindex" data-kind="entry" toggles raised>Entry Reindex</paper-button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'admin-shell',
      behaviors: [ ReduxBehavior ],
      properties: {
        isAdmin: { type: Boolean, statePath: 'isAdmin' },
      },
      _url: function (isAdmin) {
        const view = Polymer.dom().querySelector('app-shell').dataView.view;
        if (view == 'maintenance' && isAdmin) {
          return '/api/info';
        }
      },
      handleMessage: function (e) {
        // console.log(arguments);
        const toast = this.$.toast;
        toast.fitInto = this.$.container;
        toast.setAttribute('text', e.detail.message.notification.body);
        toast.open();
      },
      callAjax: function (url) {
        const xhr = this.$.xhr;
        this.$.messaging.requestPermission().then(function () {
          xhr.url = url;
          xhr.body = JSON.stringify({ 'token': this.token });
          xhr.generateRequest();
        }.bind(this), function (err) {
          console.log(err);
        });
      },
      rebuild: function (e) {
        this.callAjax('/api/rebuild/' + e.model.item);
      },
      reindex: function (e) {
        this.callAjax('/api/index/' + e.target.dataset.kind);
      },
      unbound: function (e) {
        this.callAjax('/api/unbound/' + e.target.dataset.kind);
      },
      fix: function (e) {
        this.callAjax('/api/fix/' + e.target.dataset.kind);
      },
    });
  </script>
</dom-module>
