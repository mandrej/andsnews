<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-behavior.html">

<dom-module id="admin-shell">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            .container {
                padding: 16px;
            }
            paper-toast {
                --paper-toast-color: var(--app-light-color);
                --paper-toast-background-color: var(--app-dark-color);
            }
            paper-button {
                width: 135px;
                color: var(--app-light-color);
                background-color: var(--app-primary-color);
                text-transform: lowercase;
                margin: 0 16px   16px 0;
			}
            paper-button.sec {
                color: var(--app-dark-color);
                background-color: var(--app-secondary-color);
            }
            h1, h4 {
				margin: 0;
				font-size: 24px;
				font-weight: 400;
				white-space: nowrap;
			}
            h4 {
                font-size: 16px;
            }
        </style>

        <iron-ajax auto
            url="/api/info"
            last-response="{{info}}"></iron-ajax>

        <iron-ajax id="rebuild_ajax"
            on-response="channelHandler"
            method="POST"></iron-ajax>
        <iron-ajax id="reindex_ajax"
            on-response="channelHandler"
            method="POST"></iron-ajax>

        <div class="container" id="container">
            <paper-toast id="toast" fit-into="{{container}}"
                horizontal-align="right"></paper-toast>

            <template is="dom-if" if="{{isAdmin}}">
                <div class="layout horizontal justified wrap">
                    <div>
                        <h1>Photo [[info.photo.count]]</h1>
                        <h4>Counters</h4>
                        <div class="layout horizontal wrap">
                            <template is="dom-repeat"
                                items="[[info.photo.counters]]" as="item">
                                <paper-button on-tap="rebuild">[[item]]</paper-button>
                            </template>
                        </div>

                        <paper-button class="sec" on-tap="reindex(photo)">Photo Reindex</paper-button>
                    </div>

                    <div>
                        <h1>Entry [[info.entry.count]]</h1>
                        <h4>Counters</h4>
                        <div class="layout horizontal wrap">
                            <template is="dom-repeat"
                                items="[[info.entry.counters]]" as="item">
                                <paper-button on-tap="rebuild">[[item]]</paper-button>
                            </template>
                        </div>

                        <paper-button class="sec" on-tap="reindex(entry)">Entry Reindex</paper-button>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'admin-shell',
            behaviors: [
                Polymer.NeonAnimationBehavior
            ],
            properties: {
                animationConfig: {
                    type: Object,
                    value: function() {
                        return {
                            'entry': [{
                                name: 'slide-from-right-animation',
                                node: this
                            }],
                            'exit': [{
                                name: 'slide-right-animation',
                                node: this
                            }]
                        }
                    }
                },
                info: { type: Object },
                user: { type: Object, notify: true },
                isAdmin: { type: Boolean, value: false, notify: true },
                counters: {type: Array },
                channels: { type: Object, value: {} },
                jobs: {type: Array },
            },
            channelHandler: function(req) {
                var resp = req.detail.response;
                if (!('goog' in window)) return;
                if (!(resp.token in this.channels)) {
                    // {token: socket, token: socket}
                    var channel = new goog.appengine.Channel(resp.token);
                    this.channels[resp.token] = channel.open();
                    this.channels[resp.token].onmessage = function(e) {
                        return this.onMessage(e, resp.token);
                    }.bind(this);
                }
			},
            onMessage: function (e, token) {
                var resp = JSON.parse(e.data),
                    toast = this.$.toast;

                toast.setAttribute('text', resp.message);
                if (!toast.opened) toast.open();
                if (resp.message == 'END') {
                    this.channels[token].readyState = 3; // close socket
                    delete this.channels[token];
                }
            },
            rebuild: function(e) {
                this.$.rebuild_ajax.url = '/api/rebuild/' + e.model.item;
                this.$.rebuild_ajax.generateRequest();
            },
            reindex: function(e) {
                this.$.reindex_ajax.url = '/api/index/' + e.model.item;
                this.$.reindex_ajax.generateRequest();
            },
        });
    </script>
</dom-module>
