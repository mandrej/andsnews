<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/neon-animation/animations/cascaded-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/transform-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="shared-styles.html">

<dom-module id="grid-view">
  <template>
    <style include="shared-styles">
      .rec {
        position: relative;
        width: calc(100% / 5);
        cursor: pointer;
      }
      .rec::after {
        content: "";
        display: block;
        padding-bottom: 100%;
      }
      .rec iron-image {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
      .rec .title {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.5);
        color: var(--primary-background-color);
        font-size: 20px;
        padding: 16px;
        text-overflow: ellipsis;
      }
      @media (max-width: 1024px) { .rec { width: calc(100% / 4); }}
      @media (max-width: 768px)  { .rec { width: calc(100% / 3); }}
      @media (max-width: 432px)  { .rec { width: calc(100% / 2); }}
    </style>

    <iron-ajax auto
      url="[[_url(kind, route)]]"
      handle-as="json"
      on-response="handler"
      loading="{{loading}}"
      debounce-duration="50"></iron-ajax>

    <div class="layout horizontal wrap">
      <template is="dom-repeat" items="[[items]]" as="rec" on-dom-change="repeatRender">
        <div class="rec" data-field$="[[rec.field_name]]" on-tap="showDetail">
          <template is="dom-if" if="[[_isKindPhoto(kind)]]">
            <iron-image src="[[_checkImage(rec)]]" preload fade sizing="cover"></iron-image>
          </template>
          <template is="dom-if" if="[[!_isKindPhoto(kind)]]">
            <iron-image src="[[rec.front_img]]" preload fade sizing="cover"></iron-image>
          </template>
          <div class="title">
            <div class="layout horizontal justified">
              <template is="dom-if" if="[[_isKindPhoto(kind)]]">
                <span class="self-center">[[rec.name]]</span>
                <span class="self-center">[[rec.count]]</span>
              </template>
              <template is="dom-if" if="[[!_isKindPhoto(kind)]]">
                <span class="self-center">[[rec.headline]]</span>
              </template>
            </div>
          </div>
        </div>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'grid-view',
      behaviors: [
        Polymer.NeonAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior,
      ],
      properties: {
        animationConfig: {
          type: Object,
          value: function () {
            return {
              'entry': [{
                name: 'cascaded-animation',
                animation: 'fade-in-animation'
              }, {
                name: 'cascaded-animation',
                animation: 'transform-animation',
                transformFrom: 'translateY(-56px)'
              }]
            }
          }
        },
        items: { type: Array, value: [], notify: true },
        loading: { type: Boolean, value: false, notify: true },
      },
      _url: function (kind, route) {
        const rx = /^\/grid/;
        if (rx.test(route.path)) {
          if (kind === 'photo') {
            return '/api/filters';
          } else if (kind === 'entry') {
            return '/api/entry';
          }
        }
      },
      handler: function (request) {
        const response = request.detail.response;
        var collection;

        if (this.kind == 'photo') {
          collection = response;
        } else if (this.kind == 'entry') {
          collection = response.objects;
        }
        this.items = [];
        collection.forEach(function (item) {
          this.push('items', item);
        }, this);
      },
      _isKindPhoto: function (kind) {
        return kind == 'photo';
      },
      _checkImage: function (rec) {
        if (rec.repr_url) {
          return rec.repr_url + '=s400';
        } else {
          return 'data:image/gif;base64,R0lGODlhAQABAPAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
        }
      },
      showDetail: function (e) {
        switch (this.kind) {
          case 'photo':
            this.set('route.path', ['/detail', this.kind, e.model.rec.field_name, '' + e.model.rec.name].join('/'));
            break;
          case 'entry':
            this.set('route.path', ['/detail', this.kind, 'key', e.model.rec.safekey].join('/'));
            break;
        }

      },
      repeatRender: function () {
        var nodes = this.root.querySelectorAll('.rec');
        this.animationConfig['entry'][0].nodes = nodes;
        this.animationConfig['entry'][1].nodes = nodes;
        this.playAnimation('entry');
      },
    });
  </script>
</dom-module>
