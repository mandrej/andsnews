<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip.html">
<link rel="import" href="./redux-store.html">

<link rel="import" href="./shared-styles.html">
<link rel="import" href="./item-info.html">
<link rel="import" href="./item-edit.html">

<dom-module id="item-view">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
       :host {
        display: block;
        position: relative;
        background-color: var(--primary-background-color);
      }
      .swipe {
        height: 100vh;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        cursor: default;
      }
      iron-image {
        width: 100%;
        height: 100%;
        transition: all 0.3s ease-in-out;
        background-color: var(--secondary-text-color);
      }
      .markdown-html * {
        font-family: 'Roboto', 'Noto', sans-serif;
      }
      .markdown-html img {
        max-width: 100%;
      }
      .markdown-html h2,
      .markdown-html h3,
      .markdown-html strong {
        font-weight: 500;
      }
      .markdown-html a {
        color: var(--primary-color);
      }
      /*.markdown-html img[alt='Milan D. Andrejevic'] {
      }*/
    </style>

    <neon-animated-pages id="neon"
      selected="[[view]]"
      attr-for-selected="data-view"
      entry-animation="fade-in-animation"
      exit-animation="fade-out-animation">
      <div data-view="display" class="swipe">
        <template is="dom-if" if="[[_isKindPhoto(item)]]">
          <iron-image
            src="[[item.serving_url]]=s0"
            data-dim$="[[item.dim]]"
            position="top"
            sizing="contain"
            preload fade></iron-image>
        </template>

        <template is="dom-if" if="[[!_isKindPhoto(item)]]">
          <marked-element markdown="[[item.body]]">
            <div class="markdown-html" style="padding: 16px"></div>
          </marked-element>
        </template>
      </div>

      <item-info
        data-view="info"
        item="{{item}}"
        filter="[[filter]]"
        route="{{route}}"></item-info>

      <item-edit
        data-view="form"
        view="[[view]]"
        item="{{item}}"
        is-admin="{{isAdmin}}"></item-edit>
    </neon-animated-pages>
  </template>

  <script>
    Polymer({
      is: 'item-view',
      behaviors: [ ReduxBehavior ],
      properties: {
        view: { type: String, statePath: 'view' },
      },
      listeners: {
        'show-info': '_showInfo',
        'zoom-toggle': '_zoomToggle',
      },
      actions: {
        change: function (payload) {
          return {
            type: 'CURRENT_CHANGED',
            payload: payload
          }
        }
      },
      _remove: function (e) {
        Polymer.dom().querySelector('app-shell').fire('confirm-delete');
      },
      _isKindPhoto: function (item) {
        return item.kind == 'photo';
      },
      _showInfo: function () {
        const state = this.getState();
        if (state.view != 'info') {
          this.dispatch('change', {
            view: 'info',
            disableSwipe: true
          });
        } else {
          this.dispatch('change', {
            view: 'display',
            disableSwipe: false
          });
        }
      },
      _zoomToggle: function () {
        const img = this.$.neon.querySelector('iron-image');
        const dim = JSON.parse(img.dataset.dim);
        const state = this.getState();

        // var scale = Math.max(dim[0] / this.offsetWidth, dim[1] / this.offsetHeight);
        // if (img.style.transform) {
        //     img.removeAttribute('style');
        // } else {
        //     img.style.transform = 'scale(' + scale + ')';
        // }

        if (state.zooming) {
          this.dispatch('change', {
            view: 'display',
          });
          img.style.cssText = 'width: ' + dim[0] + 'px; height: ' + dim[1] + 'px;';
        } else {
          img.style.cssText = 'width: 100%; height: 100%';
        }
      },
    });
  </script>
</dom-module>
