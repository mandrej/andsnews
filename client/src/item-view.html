<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-bottom-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip.html">

<link rel="import" href="redux-store.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="item-info.html">
<link rel="import" href="item-edit.html">

<dom-module id="item-view">
  <template>
    <style include="shared-styles">
      neon-animated-pages {
        height: 100vh;
      }
      iron-image {
        width: 100%;
        height: 100%;
        transition: all 0.3s ease-in-out;
      }
      .left, .right {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 15%;
        /*background-color: rgba(0,0,0,.3);*/
        background-repeat: no-repeat;
        background-position: center 30%;
      }
      /*https://codepen.io/fixcl/pen/Fkcot*/
      .left {
        left: 0;
        /*<svg xmlns="http://www.w3.org/2000/svg" width="60px" height="80px" viewBox="0 0 50 80" xml:space="preserve"><polyline fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="45.63,75.8 0.375,38.087 45.63,0.375 "/></svg>*/
        /*background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MHB4IiBoZWlnaHQ9IjgwcHgiIHZpZXdCb3g9IjAgMCA1MCA4MCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBvbHlsaW5lIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0ZGRkZGRiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHBvaW50cz0iNDUuNjMsNzUuOCAwLjM3NSwzOC4wODcgNDUuNjMsMC4zNzUgIi8+PC9zdmc+");*/
      }
      .right {
        right: 0;
        /*<svg xmlns="http://www.w3.org/2000/svg" width="60px" height="80px" viewBox="0 0 50 80" xml:space="preserve"><polyline fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="0.375,0.375 45.63,38.087 0.375,75.8 "/></svg>*/
        /*background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MHB4IiBoZWlnaHQ9IjgwcHgiIHZpZXdCb3g9IjAgMCA1MCA4MCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBvbHlsaW5lIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0ZGRkZGRiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHBvaW50cz0iMC4zNzUsMC4zNzUgNDUuNjMsMzguMDg3IDAuMzc1LDc1LjggIi8+PC9zdmc+");*/
      }
      .markdown-html img {
        max-width: 100%;
      }
      .markdown-html h2,
      .markdown-html h3,
      .markdown-html strong {
        font-weight: 500;
      }
      /*.markdown-html img[alt='Milan D. Andrejevic'] {
      }*/
    </style>

    <iron-media-query query="min-width: 640px" query-matches="{{largeScreen}}"></iron-media-query>

    <neon-animated-pages id="neon"
      selected="[[view]]"
      attr-for-selected="data-view"
      entry-animation="slide-from-bottom-animation"
      exit-animation="slide-down-animation">
      <div data-view="display">
        <template is="dom-if" if="[[_isKindPhoto(item)]]">
          <iron-image
            src="[[item.serving_url]]=s0"
            data-dim$="[[item.dim]]"
            position="top"
            sizing="{{sizing}}"
            preload fade></iron-image>
        </template>

        <template is="dom-if" if="[[!_isKindPhoto(item)]]">
          <marked-element markdown="[[item.body]]">
            <div class="markdown-html" style="padding: 16px"></div>
          </marked-element>
        </template>

        <div class="left" on-tap="_goSwipe"></div>
        <div class="right" on-tap="_goSwipe"></div>
      </div>

      <item-info
        data-view="info"
        item="{{item}}"
        filter="[[filter]]"
        route="{{route}}"></item-info>

      <item-edit
        data-view="form"
        view="[[view]]"
        item="{{item}}"></item-edit>
    </neon-animated-pages>
  </template>

  <script>
    Polymer({
      is: 'item-view',
      behaviors: [ ReduxBehavior ],
      properties: {
        view: { type: String, statePath: 'view' },
        sizing: { type: String, computed: 'computeSizing(largeScreen)'}
      },
      listeners: {
        'info-toggle': '_infoToggle',
        'zoom-toggle': '_zoomToggle',
      },
      actions: {
        change: function (payload) {
          return {
            type: 'CURRENT_CHANGED',
            payload: payload
          }
        }
      },
      computeSizing: function (isLargeScreen) {
        return (isLargeScreen) ? 'contain' : 'cover';
      },
      _remove: function (e) {
        Polymer.dom().querySelector('app-shell').fire('confirm-delete');
      },
      _isKindPhoto: function (item) {
        return item.kind === 'photo';
      },
      _infoToggle: function () {
        const state = this.getState();
        if (state.view === 'info') {
          this.dispatch('change', {
            view: 'display',
            disableSwipe: false
          });
        } else {
          this.dispatch('change', {
            view: 'info',
            disableSwipe: true
          });
        }
      },
      _zoomToggle: function () {
        const state = this.getState();
        const img = this.$.neon.querySelector('iron-image');
        const dim = JSON.parse(img.dataset.dim);

        // var scale = Math.min(dim[0] / this.offsetWidth, dim[1] / this.offsetHeight);
        // transform: 'scale(' + scale +')'

        if (state.zooming) {
          this.dispatch('change', {
            view: 'display',
          });
          Object.assign(img.style, {
            width: dim[0] + 'px',
            height: dim[1] + 'px',
          });
          [].forEach.call(this.$.neon.querySelectorAll('.left, .right'), function (el) {
            el.style.visibility = 'hidden';
          });
        } else {
          Object.assign(img.style, {
            width: '100%',
            height: '100%',
          });
          [].forEach.call(this.$.neon.querySelectorAll('.left, .right'), function (el) {
            el.style.visibility = 'visible';
          });
        }
      },
      _goSwipe: function (e) {
        const state = this.getState();
        if (state.zooming) return;

        const parent = Polymer.dom().querySelector('app-shell').root.querySelector('detail-view');
        switch (e.target.className) {
          case 'left':
            parent.fire('swipe-left');
            break;
          case 'right':
            parent.fire('swipe-right');
            break;
        }
      },
    });
  </script>
</dom-module>
