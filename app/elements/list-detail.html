<link rel="import" href="elements.html">

<dom-module id="list-detail">
    <template>
        <style>
            :host {
                display: flex;
                height: 100vh;
            }
            .swipe {
                /*-moz-user-select: none;
                -ms-user-select: none;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;*/
            }
            .swipe img {
                max-width: 100%;
            }
            .swipe iron-image {
                width: 100%;
                height: 100%;
            }
            paper-dialog.info {
                --paper-dialog-background-color: var(--google-yellow-300);
                --paper-dialog-title: {
                    font-size: var(--app-toolbar-font-size);
                }
            }
            paper-button {
                color: var(--dark-theme-text-color);
                background-color: var(--paper-red-500);
            }
            .markdown-html * {
                font-family: 'Roboto', 'Noto', sans-serif;
            }
            .markdown-html img {
                max-width: 100%;
            }
            .markdown-html h2, .markdown-html h3, .markdown-html strong {
                font-weight: 500;
            }
            /*.markdown-html img[alt='Milan D. Andrejevic'] {
            }*/
        </style>

        <iron-ajax id="list_ajax" auto
            url="{{url}}"
            params="{{params}}"
            handle-as="json"
            on-response="handler"
            loading="{{loading}}"
            debounce-duration="100"></iron-ajax>

        <iron-request id="download_ajax"></iron-request>

        <paper-dialog id="message" class="info" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
            <h2>Nothing found</h2>
            <p>Please try again</p>
        </paper-dialog>

        <iron-swipeable-pages class="flex" selected="{{start}}" is-gesture="true" id="swipe">
            <template is="dom-repeat" items="{{items}}" on-dom-change="_bindZoom">
                <template is="dom-if" if="[[_showPhoto(item)]]">
                    <div class="swipe">
                        <!-- <iron-image src="[[item.serving_url]]=s0" data-dim$="[[item.dim]]" sizing="cover" on-track="zoomImage"></iron-image> -->
                        <img class="pz" src="[[item.serving_url]]=s0" data-dim$="[[item.dim]]">
                        <paper-dialog id="[[item.slug]]" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
                            <p>
                                [[_dateFormat(item.date)]]<br>
                                [[item.author]]<br><br>
                                [[item.model]]<br>
                                [[item.lens]]<br>
                                [[item.eqv]] mm<br>
                                [[item.iso]] ASA
                            </p>
                            <p>
                                <paper-button dialog-confirm on-tap="_download" data-url="[[item.download_url]]">
                                    <iron-icon icon="file-download"></iron-icon>Download
                                </paper-button>
                            </p>
                        </paper-dialog>
                    </div>
                </template>
                <template is="dom-if" if="[[!_showPhoto(item)]]">
                    <div class="swipe" style="padding: 16px">
                        <marked-element markdown="[[item.body]]">
                            <div class="markdown-html"></div>
                        </marked-element>
                    </div>
                </template>
            </template>
        </iron-swipeable-pages>

        <iron-scroll-threshold id="scrollTheshold"
            lower-threshold="2000"
            scroll-target="document"
            on-lower-threshold="loadMore"></iron-scroll-threshold>
    </template>

    <script>
        Polymer({
            is: 'list-detail',
            behaviors: [
                // Polymer.NeonAnimationBehavior,
                Polymer.NeonAnimationRunnerBehavior
            ],
            properties: {
                animationConfig: {
                    type: Object,
                    value: function() {
                        return {
                            'entry': [{
                                name: 'fade-in-animation',
                                node: this,
                                timing: {
                                    delay: 150
                                }
                            }, {
                                name: 'slide-from-right-animation',
                                node: this,
                                timing: {
                                    delay: 150
                                }
                            }],
                            'exit': [{
                                name: 'slide-right-animation',
                                node: this
                            }]
                        }
                    }
                },
                kind: { type: String, value: null, notify: true },
				field: { type: String, value: null, notify: true },
				value: { type: String, value: null, notify: true },
                items: {
                    type: Array,
                    value: [],
                    notify: true
                },
                start: { type: Number, value: 0, notify: true, observer: 'changeHeadline' },
                headline: { type: String, value: 'ANDрејевићи', notify: true },
                params: {
                    type: Object,
                    value: {},
                    notify: true
                },
                url: {
					computed: '_url(kind, field, value)',
					notify: true,
					// observer: 'propertyChanged'
				},
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
            },
            // observers: ['paramsChanged(params.*)'],
            listeners: {
                'show-exif': '_showExif'
            },
            changeHeadline: function(newValue, oldValue) {
                if (this.items.length > 0) {
                    this.headline = this.items[newValue].headline;
                }
            },
            _url: function(kind, field, value) {
				var url, prefix = '/api';

				if (kind == 'search' && field != null) {
                    url = [prefix, kind].join('/');
                    this.set('params.find', field);
				} else if (field && value) {
					url = [prefix, kind, field, value].join('/');
				}
				return url;
			},
			handler: function(request) {
				var response = request.detail.response;
                if (response.objects.length == 0) {
                    var dialog = document.getElementById('message');
                    dialog.open();
                } else {
                    response.objects.forEach(function(item) {
                        this.push('items', item);
                    }, this);
                    this.$.scrollTheshold.clearTriggers();

                    if (this.headline == 'ANDрејевићи') {
                        this.headline = this.items[this.start].headline;
                    }
                }
			},
            loadMore: function() {
                var list_ajax = this.$.list_ajax;
                // if (list_ajax.lastRequest) list_ajax.lastRequest.abort();
				if (list_ajax.lastResponse && list_ajax.lastResponse.next) {
                    this.set('params.page', list_ajax.lastResponse.next);
                    // list_ajax.generateRequest();
				}
			},
            _showPhoto: function(item) {
                return item.kind == 'photo';
            },
            _dateFormat: function(value) {
                return moment(value, 'YYYY-MM-DDTHH:mm:ss').locale('sr').format('LLL');
                // return moment(value, 'YYYY-MM-DDTHH:mm:ss').locale('sr').fromNow();
            },
            _showExif: function(e) {
                var id = e.target.items[this.start].slug,
                    // id = e.model.item.slug,
                    dialog = document.getElementById(id);
                if (dialog) {
                    dialog.open();
                }
            },
            _bindZoom: function() {
                var images = document.querySelectorAll('.pz');
                images.forEach(function(elem, index) {
                    new VanillaPinch(elem, { tapZoomFactor: 2 });
                });
            },
            _download: function(e) {
                e.preventDefault();
                var url = e.target.dataUrl,
                    promise = this.$.download_ajax.send({url: url, method: 'GET'});
            },
            propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
			objectChanged: function(newValue, oldValue) {
				console.log(newValue);
			},
            paramsChanged: function(obj) {
                // this is object observer!
                console.log(obj.path + ' -> ' + this.get(obj.path));
            }
        });
    </script>
    <script src="../bower_components/moment/min/moment-with-locales.min.js"></script>
    <script src="../node_modules/vanilla-pinch/dist/vanillapinchzoom.min.js"></script>
</dom-module>
