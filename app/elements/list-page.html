<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/juicy-html/juicy-html.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../styles/shared-styles.html">

<link rel="import" href="list-filter.html">
<link rel="import" href="list-grid.html">
<link rel="import" href="list-detail.html">

<dom-module id="list-page">
	<template>
		<style is="custom-style" include="shared-styles"></style>
		<style>
			:host {
				display: block;
				@apply(--paper-font-common-base);
			}
			iron-pages, iron-scroll-threshold {
				@apply(--layout-fit);
			}
			paper-input {
				--paper-input-container-input-color: var(--dark-theme-text-color);
			}
			paper-dialog {
				position: fixed;
				height: auto;
				left: 0;
				right: 0;
				bottom: 50px;
			}
		</style>

		<iron-ajax id="list_ajax" auto
			url="{{url}}"
			handle-as="json"
			on-response="handler"
			loading="{{loading}}"
			debounce-duration="300"></iron-ajax>

		<paper-drawer-panel id="drawer">
			<paper-header-panel class="flex" drawer>
				<paper-toolbar>
					<iron-icon icon="icons:search" style="margin-right: 16px"></iron-icon>
					<iron-a11y-keys target="[[targetSearch]]" keys="enter" on-keys-pressed="_onSearch"></iron-a11y-keys>
					<paper-input id="inputSearch" placeholder="search" no-label-float
						value="{{search::input}}"></paper-input>
				</paper-toolbar>

				<paper-menu attr-for-selected="kind-page" selected="[[kind]]" class="fit">
					<paper-item kind-page="photo" on-tap="_kindChanged">
						<a href="#/photo" class="flex">
							<iron-icon icon="image:photo-camera"></iron-icon>Photos
						</a>
					</paper-item>
					<paper-item kind-page="entry" on-tap="_kindChanged">
						<a href="#/entry" class="flex">
							<iron-icon icon="icons:description"></iron-icon>Texts
						</a>
					</paper-item>

					<list-filter
						kind="[[kind]]"
						field="{{field}}"
						value="{{value}}"
						route="{{route}}"></list-filter>

					<!-- <div class="content">
						<p>
							Use fields author, tags, year, month for searching:
							year: 2016 tags: milan
						</p>
						<p>АNDS 2008-2016 v.1602</p>
					</div> -->
				</paper-menu>
			</paper-header-panel>

			<paper-header-panel main>
				<paper-toolbar hidden$="{{toggleView}}">
					<paper-icon-button icon="icons:menu" paper-drawer-toggle></paper-icon-button>
					<div class="title">ANDрејевићи {{kind}} {{field}} {{value}}</div>
					<paper-spinner active$="[[loading]]"></paper-spinner>
				</paper-toolbar>

				<iron-scroll-threshold id="scrollTheshold" lower-threshold="500" on-lower-threshold="_loadMore">
					<iron-pages selected="grid" attr-for-selected="data-view" id="switch">
						<list-grid
							kind="{{kind}}"
							data-view="grid"
							selected="{{selected}}"
							items="{{items}}"></list-grid>

						<list-detail
							kind="{{kind}}"
							data-view="detail"
							selected="{{selected}}"
							items="{{items}}"></list-detail>
					</iron-pages>
				</iron-scroll-threshold>
			</paper-header-panel>
		</paper-drawer-panel>
	</template>

	<script>
		Polymer({
			is: 'list-page',
			properties: {
				items: {
					type: Array,
					value: []
				},
				url: {
					computed: '_url(kind, page, field, value)',
					notify: true,
					observer: 'propertyChanged'
				},
				toggleView: {
					type: Boolean,
					value: false,
					notify: true
				},
				clearItems: {
					computed: '_clearItems(page)',
					notify: true
				},
				search: {
					type: String,
					notify: true
				},
				targetSearch: {
					type: Object,
					value: function() {
						return this.$.inputSearch
					}
				},
				loading: Boolean
			},
			observers: ['_kindChanged(kind)'],
			listeners: {
				'show-detail': '_toggleView',
				'show-grid': '_toggleView'
			},
			_clearItems: function(page) {
				return !page;
			},
			_url: function(kind, page, field, value) {
				var url, prefix = '/api';

				if (kind == 'search' && field != null) {
					url = [prefix, kind].join('/') + '?find=' + field;
					if (!!page) url += '&page=' + page;
				} else if (field && value) {
					url = [prefix, kind, field, value].join('/');
					if (!!page) url += '?page=' + page;
				} else {
					url = [prefix, kind].join('/');
					if (!!page) url += '?page=' + page;
				}
				return url;
			},
			_loadMore: function() {
				if (this.$.list_ajax.lastRequest) {
					this.$.list_ajax.lastRequest.abort();
				}
				if (this.$.list_ajax.lastResponse && this.$.list_ajax.lastResponse.next) {
					this.page = this.$.list_ajax.lastResponse.next;
					this.fire('url-changed');
				}
			},
			handler: function(request) {
				var response = request.detail.response;
				if (this.clearItems) this.items = [];
				response.objects.forEach(function(item) {
					this.push('items', item);
				}, this);
				this.$.scrollTheshold.clearTriggers();
			},
			_kindChanged: function(kind) {
				if (kind != 'search') this.field = null;
				this.value = null;
				this.page = null;
				this.search = null;
				this.items = [];
			},
			_toggleView: function(e) {
				var drawer = this.$.drawer;
				if (drawer.narrow && drawer.getBoundingClientRect().width < parseInt(drawer.responsiveWidth)) {
					// drawer.togglePanel();s
				} else {
					drawer.forceNarrow = !drawer.forceNarrow;
				}
				this.toggleView = !this.toggleView;
				if (this.toggleView) {
					this.$.switch.selected = 'detail';
				} else {
					this.$.switch.selected = 'grid';
				}
			},
			_onSearch: function() {
				this.field = this.search;
				this.value = null;
				this.page = null;
				this.set('route.path', '/search/' + this.field);
			},
			propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
			objectChanged: function(newValue, oldValue) {
				console.log(newValue);
			}
		});
	</script>
</dom-module>
