<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-swipeable-pages/iron-swipeable-pages.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-behavior.html">
<link rel="import" href="../bower_components/juicy-html/juicy-html.html">
<link rel="import" href="../styles/shared-styles.html">

<dom-module id="list-page">
	<template>
		<style is="custom-style" include="shared-styles"></style>
		<style>
			:host {
				@apply(--layout-fullbleed);
				@apply(--paper-font-common-base);
				background: var(--primary-background-color);
			}
			.photo {
                position: relative;
                width: 20%;
				height: 200px;
				cursor: pointer;
			}
            .photo:hover .detail { opacity: 1; }
            .photo > iron-image {
                @apply(--layout-flex);page
            }
            .photo > .detail {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(rgba(0,0,0,0), rgba(0,0,0,0.8));
                color: white;
                font-size: 20px;
                font-weight: 100;
                padding: 20px;
                opacity: 0;
                transition: opacity 0.1s;
            }
            @media (max-width: 1024px) {.photo{ width: 25%; height: 200px;} }
            @media (max-width: 848px) { .photo{ width: 33.3333333%; height: 200px;} }
            @media (max-width: 600px) { .photo{ width: 50%; height: 300px;} }
            @media (max-width: 432px) { .photo{ width: 100%; height: 350px;} }

			iron-image { width: 100%; height: 100%; }
            .swipe {
                -moz-user-select: none;
                -ms-user-select: none;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;
            }
            paper-dialog {
                position: fixed;
                height: auto;
                left: 0;
                right: 0;
                bottom: 50px;
            }
			.content {
				margin: 0 16px;
			}
			.rec {
				display: inline-block;
				padding: 2px 4px;
				margin: 0 8px 8px 0;
				cursor: pointer;
			}
			.rec.selected {
				color: white;
                background-color: var(--paper-red-500);
            }
		</style>

		<iron-ajax id="list_ajax"
			auto
			url="{{_url(kind, page, field, value)}}"
			handle-as="json"
			on-response="handler"
			loading="{{loading}}"
			debounce-duration="300">
		</iron-ajax>

		<iron-ajax auto
            url="{{_urlFilter(kind)}}"
            handle-as="json"
            last-response="{{response}}"
            debounce-duration="300">
        </iron-ajax>

        <paper-drawer-panel id="drawer">
			<paper-header-panel drawer>
				<paper-menu attr-for-selected="kind-page" selected="{{data.kind}}">
					<a class="paper-item-link" kind-page="photo" href="#/photo">
						<paper-item>
							<iron-icon icon="image:photo-camera"></iron-icon>
							<span>Photos</span>
						</paper-item>
					</a>
					<a class="paper-item-link" kind-page="entry" href="#/entry">
						<paper-item>
							<iron-icon icon="icons:description"></iron-icon>
							<span>Texts</span>
						</paper-item>
					</a>
					<div class="layout vertical">
						<paper-item on-tap="_clearFilter">
							<iron-icon icon="icons:filter-list"></iron-icon>
							<span>Filters</span>
						</paper-item>
						<div class="layout horizontal wrap content">
							<template is="dom-repeat" items="[[response]]" as="row">
								<template is="dom-repeat" items="[[row.items]]" as="rec">
					                <span class$="rec [[_selectedFilter(rec.name, value)]]"
					                    data-field$="[[row.field_name]]" on-tap="_applyFilter">
					                    [[rec.name]]
					                </span>
					            </template>
					        </template>
						</div>
					</div>
                </paper-menu>
			</paper-header-panel>

			<paper-header-panel main>
                <paper-toolbar hidden$="{{detailView}}">
                    <paper-icon-button icon="icons:menu" paper-drawer-toggle></paper-icon-button>
                    <div class="title">ANDрејевићи {{field}} {{value}}</div>
                    <paper-spinner active$="[[loading]]"></paper-spinner>
                    <paper-icon-button icon="icons:search" on-tap="_showSearch"></paper-icon-button>
                </paper-toolbar>

                <iron-scroll-threshold id="scrollTheshold" lower-threshold="500" on-lower-threshold="_loadMore">
                    <div hidden$="{{detailView}}" class="layout horizontal wrap start-aligned" id="grid">
                        <template is="dom-if" if="{{showingPhotos}}" restamp="true">
                            <template is="dom-repeat" items="{{items}}" index-as="index">
                                <div class="photo" on-tap="_showDetail">
                                    <iron-image src="{{item.serving_url}}=s0" sizing="cover"></iron-image>
                                    <div class="detail">[[item.headline]]</div>
                                    <paper-ripple></paper-ripple>
                                </div>
                            </template>
                        </template>
                        <template is="dom-if" if={{!showingPhotos}} restamp="true">
                            <template is="dom-repeat" items="{{items}}" index-as="index">
                                <paper-card heading="[[item.headline]]" on-tap="_showDetail" elevation="0" animated-shadow="false">
                                    <div class="card-content">
                                        [[item.summary]]
                                    </div>
                                    <paper-ripple></paper-ripple>
                                </paper-card>
                            </template>
                        </template>
                    </div>

                    <div hidden$="{{!detailView}}" id="full">
                        <iron-swipeable-pages class="fit" selected="0" edgeSwipeSensitivity="15" threshold="0.1" id="swiper">
                            <template is="dom-if" if="{{showingPhotos}}" restamp="true">
                                <template is="dom-repeat" items="{{items}}">
                                    <div class="swipe">
                                        <paper-toolbar>
                                            <paper-icon-button icon="icons:chevron-left" on-tap="_showList"></paper-icon-button>
                                            <div class="title">[[item.headline]]</div>
                                            <paper-icon-button icon="icons:more-vert" on-tap="_showExif"></paper-icon-button>
                                        </paper-toolbar>
                                        <paper-dialog id="[[item.slug]]" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
                                            <table>
                                                <tr><td>date</td><td>[[item.date]]</td></tr>
                                                <tr><td>author</td><td>[[item.author]]</td></tr>
                                                <tr><td>model</td><td>[[item.model]]</td></tr>
                                                <tr><td>lens</td><td>[[item.lens]]</td></tr>
                                                <tr><td>eqv</td><td>[[item.eqv]]</td></tr>
                                                <tr><td>iso</td><td>[[item.iso]]</td></tr>
                                            </table>
                                        </paper-dialog>
                                        <iron-image src="{{item.serving_url}}=s0" sizing="cover"></iron-image>
                                    </div>
                                </template>
                            </template>
                            <template is="dom-if" if={{!showingPhotos}} restamp="true">
                                <template is="dom-repeat" items="{{items}}">
                                    <div class="swipe">
                                        <paper-toolbar>
                                            <paper-icon-button icon="icons:chevron-left" on-tap="_showList"></paper-icon-button>
                                            <div class="title">[[item.headline]]</div>
                                        </paper-toolbar>
                                        <paper-card elevation="0" animated-shadow="false">
                                            <div class="card-content">
                                                <!-- <div inner-h-t-m-l="[[item.body]]"></div> -->
                                                <template is="juicy-html" content$="[[item.body]]"></template>
                                            </div>
                                        </paper-card>
                                    </div>
                                </template>
                            </template>
                        </iron-swipeable-pages>
                    </div>
                </iron-scroll-threshold>
            </paper-header-panel>
		</paper-drawer-panel>
	</template>

	<script>
		Polymer({
			is: 'list-page',
            behaviors: [Polymer.NeonAnimationBehavior],
			properties: {
                animationConfig: {
					type: Object,
                    value: function() {
                        return {
                            'entry': {
                                name: 'fade-in-animation',
                                node: this.$.grid
                            },
                            'exit': {
                                name: 'fade-out-animation',
                                node: this.$.grid
                            }
                        }
                    }
                },
                items: { type: Array, value: [] },
                loading: Boolean,
                detailView: { type: Boolean, value: false },
                showingPhotos: {
                    computed: '_showingPhotos(kind)',
                    notify: true
                },
				clearItems: {
					computed: '_clearItems(page)',
					notify: true
				}
			},
			observers: ['_kindChanged(kind)'],
			_clearItems: function(page) {
				if (page == null) return true;
				return false;
			},
			_url: function(kind, page, field, value) {
				var url, prefix = '/api', sufix = kind;
				if (field && value) {
					url = [prefix, sufix, field, value].join('/');
				} else {
					url = [prefix, sufix].join('/');
				}
                if (page != null) url += '?page=' + page;
				console.log(url);
                return url;
            },
			_urlFilter: function(kind) {
				var prefix = '/api/filter', sufix = kind;
                var url = [prefix, sufix].join('/');
                console.log(url);
                return url;
			},
            _loadMore: function() {
                if (this.$.list_ajax.lastRequest) {
                    this.$.list_ajax.lastRequest.abort();
                }
                if (this.$.list_ajax.lastResponse && this.$.list_ajax.lastResponse.next) {
                    this.page = this.$.list_ajax.lastResponse.next;
                    this.fire('url-changed');
                }
            },
			handler: function(request) {
                var response = request.detail.response;
                if (this.clearItems) this.items = [];
                response.objects.forEach(function(item) {
                    this.push('items', item);
                }, this);
                this.$.scrollTheshold.clearTriggers();
			},
			_applyFilter: function(e) {
                this.field = e.model.row.field_name;
                this.value = e.model.rec.name;
                this.page = null;
            },
			_clearFilter: function() {
				this.field = '';
                this.value = '';
                this.page = null;
			},
			_selectedFilter: function(current, selected) {
                if (current == selected) return 'selected';
            },
			_kindChanged: function(kind) {
				this.field = '';
				this.value = '';
				this.page = null;
			},
            _showingPhotos: function(kind) {
                return kind == 'photo';
            },
			_showList: function(e) {
                this.menuToggle();
                this.detailView = false;
                this.$.scrollTheshold.horizontal = false;
                this.$.scrollTheshold.lowerThreshold = 500;
            },
            _showDetail: function(e) {
                this.$.swiper.selected = e.model.index;
                this.menuToggle();
                this.detailView = true;
                this.$.scrollTheshold.horizontal = true;
                this.$.scrollTheshold.lowerThreshold = 200;
            },
            _showExif: function(e) {
                var id = e.model.item.slug,
                    dialog = document.getElementById(id);
                if (dialog) {
                    dialog.open();
                }
            },
			menuToggle: function() {
                var drawer = this.$.drawer;
				if (drawer.narrow && drawer.getBoundingClientRect().width < parseInt(drawer.responsiveWidth)) {
					// drawer.togglePanel();
                } else {
					drawer.forceNarrow = !drawer.forceNarrow;
				}
            },
			propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
			objectChanged: function(newValue, oldValue) {
				console.log(newValue);
			}
		});
	</script>
</dom-module>
