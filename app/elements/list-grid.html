<link rel="import" href="elements.html">

<dom-module id="list-grid">
    <template>
        <style is="custom-style" include="shared-styles"></style>
        <style>
            :host {
                display: block;
            }
            .content {
                @apply(--layout-horizontal);
                @apply(--layout-start-aligned);
                @apply(--layout-wrap);
            }
            .photo, .entry {
                position: relative;
                width: 25%;
				cursor: pointer;
			}
            .photo {
                height: 250px;
            }
            .photo .title {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: rgba(0,0,0,0.5);
                color: white;
                font-size: 20px;
                padding: 20px;
                opacity: 1;
                transition: opacity 0.1s;
            }
            .photo iron-image {
                width: 100%;
                height: 100%;
            }
            .entry {
                box-sizing: border-box;
                padding: 20px;
            }
            .entry .title {
                font-size: 20px;
                margin-bottom: 20px;
            }
            .entry iron-image {
                width: 100%;
                height: 50px;
            }

            @media (max-width: 1024px) { .photo, .entry { width: 33.3333333%; } }
            @media (max-width: 768px)  { .photo, .entry { width: 50%; } }
            @media (max-width: 432px)  { .photo, .entry { width: 100%; } }
        </style>

        <iron-ajax id="list_ajax" auto
			url="{{url}}"
			handle-as="json"
			on-response="handler"
			loading="{{loading}}"
			debounce-duration="300"></iron-ajax>

        <div class="content">
            <template is="dom-repeat" items="{{items}}" scroll-target="document" index-as="index" id="repeater">
                <template is="dom-if" if="[[_showPhoto(item)]]" restamp="true">
                    <div class="photo" on-tap="_showDetail">
                        <iron-image src="[[item.serving_url]]=s400" preload sizing="cover"></iron-image>
                        <div class="title">[[item.headline]]</div>
                        <paper-ripple></paper-ripple>
                    </div>
                </template>
                <template is="dom-if" if="[[!_showPhoto(item)]]" restamp="true">
                    <div class="entry" on-tap="_showDetail">
                        <div class="title">[[item.headline]]</div>
                        <template is="dom-if" if="[[item.front]]" restamp="true">
                            <iron-image src="[[item.front]]/normal" preload fade sizing="cover"></iron-image>
                        </template>
                        [[item.summary]]
                        <paper-ripple></paper-ripple>
                    </div>
                </template>
            </template>
        </div>

        <iron-scroll-threshold id="scrollTheshold"
            lower-threshold="500"
            scroll-target="document"
            on-lower-threshold="loadMore"></iron-scroll-threshold>
    </template>

    <script>
        Polymer({
            is: 'list-grid',
            properties: {
                items: {
                    type: Array,
                    value: [],
                    notify: true
                },
                url: {
					computed: '_url(kind, page, field, value)',
					notify: true,
					observer: 'propertyChanged'
				},
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                clearItems: {
					computed: '_clearItems(page)',
					notify: true
				},
                selected: {
                    type: Number,
                    value: 0,
                    notify: true
                }
            },
            _url: function(kind, page, field, value) {
				var url, prefix = '/api';

				if (kind == 'search' && field != null) {
					url = [prefix, kind].join('/') + '?find=' + field;
					if (!!page) url += '&page=' + page;
				} else if (field && value) {
					url = [prefix, kind, field, value].join('/');
					if (!!page) url += '?page=' + page;
				} else {
					url = [prefix, kind].join('/');
					if (!!page) url += '?page=' + page;
				}
				return url;
			},
            _clearItems: function(page) {
				return !page;
			},
			handler: function(request) {
				var response = request.detail.response;
				if (this.clearItems) this.items = [];
				response.objects.forEach(function(item) {
					this.push('items', item);
				}, this);
				this.$.scrollTheshold.clearTriggers();
			},
            loadMore: function() {
				if (this.$.list_ajax.lastRequest) {
					this.$.list_ajax.lastRequest.abort();
				}
				if (this.$.list_ajax.lastResponse && this.$.list_ajax.lastResponse.next) {
					this.page = this.$.list_ajax.lastResponse.next;
                    this.$.list_ajax.params = {page: this.page};
					this.fire('url-changed');
				}
			},
            _showPhoto: function(item) {
                return item.kind == 'photo';
            },
            _showDetail: function(e) {
                // this.selected = e.model.index; without dom-if
                var model = this.$.repeater.modelForElement(e.target);
                console.log(model.index);
                this.selected = model.index;
                this.fire('show-detail');
            },
            propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
			objectChanged: function(newValue, oldValue) {
				console.log(newValue);
			}
        });
    </script>
</dom-module>
