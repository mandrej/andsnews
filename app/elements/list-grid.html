<link rel="import" href="elements.html">

<dom-module id="list-grid">
    <template>
        <style is="custom-style" include="shared-styles"></style>
        <style>
            :host {
                display: block;
                padding: 4px;
            }
            .content {
                @apply(--layout-horizontal);
                @apply(--layout-start-aligned);
                @apply(--layout-wrap);
            }
            .photo, .entry {
                position: relative;
                width: 25%;
				cursor: pointer;
			}
            paper-card {
                padding: 4px;
            }
            .photo {
                /*height: 250px;*/
                --paper-card-header-color: #fff;
            }
            @media (max-width: 1024px) { .photo, .entry { width: 33.3333333%; } }
            @media (max-width: 768px)  { .photo, .entry { width: 50%; } }
            @media (max-width: 432px)  { .photo, .entry { width: 100%; } }

            /*.photo iron-image {
                width: 100%;
                height: 100%;
            }*/
            .entry iron-image {
                width: 100%;
                height: 50px;
            }
        </style>

        <iron-ajax id="list_ajax" auto
			url="{{url}}"
			handle-as="json"
			on-response="handler"
			loading="{{loading}}"
			debounce-duration="300"></iron-ajax>

        <iron-scroll-threshold id="scrollTheshold" on-lower-threshold="_loadMore">
            <div class="content">
                <template is="dom-repeat" items="{{items}}" index-as="index" id="repeater">
                    <template is="dom-if" if="[[_showPhoto(item)]]" restamp="true">
                        <paper-card heading="[[item.headline]]" image="[[item.serving_url]]=s400"
                            class="photo" on-tap="_showDetail" elevation="0">
                            <!-- <iron-image src="[[item.serving_url]]=s0" preload sizing="cover"></iron-image> -->
                            <paper-ripple></paper-ripple>
                        </paper-card>
                    </template>
                    <template is="dom-if" if="[[!_showPhoto(item)]]" restamp="true">
                        <paper-card heading="[[item.headline]]" class="entry" elevation="0" on-tap="_showDetail">
                            <div class="card-content">
                                <template is="dom-if" if="[[item.front]]" restamp="true">
                                    <iron-image src="[[item.front]]/normal" preload sizing="cover"></iron-image>
                                </template>
                                [[item.summary]]
                            </div>
                            <paper-ripple></paper-ripple>
                        </paper-card>
                    </template>
                </template>
            </div>
        </iron-scroll-threshold>
    </template>

    <script>
        Polymer({
            is: 'list-grid',
            properties: {
                items: {
                    type: Array,
                    value: [],
                    notify: true
                },
                url: {
					computed: '_url(kind, page, field, value)',
					notify: true,
					observer: 'propertyChanged'
				},
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                clearItems: {
					computed: '_clearItems(page)',
					notify: true
				},
                selected: {
                    type: Number,
                    value: 0,
                    notify: true
                }
            },
            _url: function(kind, page, field, value) {
				var url, prefix = '/api';

				if (kind == 'search' && field != null) {
					url = [prefix, kind].join('/') + '?find=' + field;
					if (!!page) url += '&page=' + page;
				} else if (field && value) {
					url = [prefix, kind, field, value].join('/');
					if (!!page) url += '?page=' + page;
				} else {
					url = [prefix, kind].join('/');
					if (!!page) url += '?page=' + page;
				}
				return url;
			},
			_loadMore: function() {
				if (this.$.list_ajax.lastRequest) {
					this.$.list_ajax.lastRequest.abort();
				}
				if (this.$.list_ajax.lastResponse && this.$.list_ajax.lastResponse.next) {
					this.page = this.$.list_ajax.lastResponse.next;
					this.fire('url-changed');
				}
			},
			handler: function(request) {
				var response = request.detail.response;
				if (this.clearItems) this.items = [];
				response.objects.forEach(function(item) {
					this.push('items', item);
				}, this);
				this.$.scrollTheshold.clearTriggers();
			},
            _clearItems: function(page) {
				return !page;
			},
            _showPhoto: function(item) {
                return item.kind == 'photo';
            },
            _showDetail: function(e) {
                // this.selected = e.model.index; without dom-if
                var model = this.$.repeater.modelForElement(e.target);
                console.log(model.index);
                this.selected = model.index;
                this.fire('show-detail');
            },
            propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
			objectChanged: function(newValue, oldValue) {
				console.log(newValue);
			}
        });
    </script>
</dom-module>
