<link rel="import" href="elements.html">
<link rel="import" href="list-filter.html">

<dom-module id="list-grid">
    <template>
        <style is="custom-style" include="shared-styles"></style>
        <style>
            :host {
                display: block;
                @apply(--paper-font-common-base);
            }

            paper-input {
                --paper-input-container-input-color: var(--dark-theme-text-color);
            }
            paper-dialog {
                position: fixed;
                height: auto;
                left: 0;
                right: 0;
                bottom: 50px;
            }
            .content {
                @apply(--layout-horizontal);
                @apply(--layout-start-aligned);
                @apply(--layout-wrap);
            }
            .photo, .entry {
                position: relative;
                width: 25%;
				cursor: pointer;
			}
            .photo {
                height: 250px;
            }
            .photo .title {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: rgba(0,0,0,0.5);
                color: white;
                font-size: 20px;
                padding: 20px;
                opacity: 1;
                transition: opacity 0.1s;
            }
            .photo iron-image {
                width: 100%;
                height: 100%;
            }
            .entry {
                box-sizing: border-box;
                padding: 20px;
            }
            .entry .title {
                font-size: 20px;
                margin-bottom: 20px;
            }
            .entry iron-image {
                width: 100%;
                height: 50px;
            }

            @media (max-width: 1024px) { .photo, .entry { width: 33.3333333%; } }
            @media (max-width: 768px)  { .photo, .entry { width: 50%; } }
            @media (max-width: 432px)  { .photo, .entry { width: 100%; } }
        </style>

        <app-drawer-layout id="drawer">
			<app-drawer>
				<app-header fixed>
					<app-toolbar>
						<iron-icon icon="icons:search" style="margin-right: 16px"></iron-icon>
						<iron-a11y-keys target="[[targetSearch]]" keys="enter" on-keys-pressed="_onSearch"></iron-a11y-keys>
						<paper-input id="inputSearch" placeholder="search" no-label-float
						value="{{search::input}}"></paper-input>
					</app-toolbar>

					<app-toolbar>
						<paper-menu attr-for-selected="kind-page" selected="[[kind]]" class="fit">
							<paper-item kind-page="photo" on-tap="_resetFilter">
								<a href="#/photo" class="flex">
									<iron-icon icon="image:photo-camera"></iron-icon>Photos
								</a>
							</paper-item>
							<paper-item kind-page="entry" on-tap="_resetFilter">
								<a href="#/entry" class="flex">
									<iron-icon icon="icons:description"></iron-icon>Texts
								</a>
							</paper-item>

							<list-filter
								kind="[[kind]]"
								field="{{field}}"
								value="{{value}}"
								route="{{route}}"
								items="{{items}}"></list-filter>
						</paper-menu>
					</app-toolbar>
				</app-header>
			</app-drawer>

			<app-header-layout>
				<app-header fixed hidden$="{{toggleView}}">
					<app-toolbar>
						<paper-icon-button icon="icons:menu" drawer-toggle></paper-icon-button>
						<div title>ANDрејевићи {{kind}} {{field}} {{value}}</div>
						<paper-spinner active$="[[loading]]"></paper-spinner>
					</app-toolbar>
				</app-header>

                <iron-ajax id="list_ajax" auto
        			url="{{url}}"
                    params="{}"
        			handle-as="json"
        			on-response="handler"
        			loading="{{loading}}"
        			debounce-duration="100"></iron-ajax>

                <div class="content">
                    <template is="dom-repeat" items="{{items}}" scroll-target="document" index-as="index" id="repeater">
                        <template is="dom-if" if="[[_showPhoto(item)]]" restamp="true">
                            <div class="photo" on-tap="_showDetail">
                                <iron-image src="[[item.serving_url]]=s400" preload sizing="cover"></iron-image>
                                <div class="title">[[item.headline]]</div>
                                <paper-ripple></paper-ripple>
                            </div>
                        </template>
                        <template is="dom-if" if="[[!_showPhoto(item)]]" restamp="true">
                            <div class="entry" on-tap="_showDetail">
                                <div class="title">[[item.headline]]</div>
                                <template is="dom-if" if="[[item.front]]" restamp="true">
                                    <iron-image src="[[item.front]]/normal" preload fade sizing="cover"></iron-image>
                                </template>
                                [[item.summary]]
                                <paper-ripple></paper-ripple>
                            </div>
                        </template>
                    </template>
                </div>

                <iron-scroll-threshold id="scrollTheshold"
                    lower-threshold="500"
                    scroll-target="document"
                    on-lower-threshold="loadMore"></iron-scroll-threshold>

            </app-header-layout>
		</app-drawer-layout>
    </template>

    <script>
        Polymer({
            is: 'list-grid',
            properties: {
				kind: { type: String, value: null, notify: true },
				field: { type: String, value: null, notify: true },
				value: { type: String, value: null, notify: true },
                search: { type: String, value: null, notify: true },
                items: {
                    type: Array,
                    value: [],
                    notify: true
                },
                url: {
					computed: '_url(kind, field, value)',
					notify: true,
					observer: 'propertyChanged'
				},
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                selected: {
                    type: Number,
                    value: 0,
                    notify: true
                },
                targetSearch: {
					type: Object,
					value: function() {
						return this.$.inputSearch
					}
				},
            },
            _url: function(kind, field, value) {
				var prefix = '/api',
                    url = [prefix, kind].join('/');

				if (kind == 'search' && field != null) {
                    this.$.list_ajax.params.find = field;
				} else if (field && value) {
					url = [prefix, kind, field, value].join('/');
				}
				return url;
			},
			handler: function(request) {
                console.log(list_ajax.params);
				var response = request.detail.response;
				response.objects.forEach(function(item) {
					this.push('items', item);
				}, this);
				this.$.scrollTheshold.clearTriggers();
			},
            loadMore: function() {
                var list_ajax = this.$.list_ajax;
                // if (list_ajax.lastRequest) list_ajax.lastRequest.abort();
				if (list_ajax.lastResponse && list_ajax.lastResponse.next) {
                    list_ajax.params.page = list_ajax.lastResponse.next;

                    list_ajax.generateRequest();
				}
			},
            _resetFilter: function(e) {
                this.$.list_ajax.params = {};
                this.items = [];
				this.field = null;
				this.value = null;
			},
			_onSearch: function() {
                this.$.list_ajax.params = {};
                this.items = [];
				this.field = this.search;
				this.value = null;
				this.set('route.path', '/search/' + this.search);
			},
            _showPhoto: function(item) {
                return item.kind == 'photo';
            },
            _showDetail: function(e) {
                // this.selected = e.model.index; without dom-if
                var model = this.$.repeater.modelForElement(e.target);
                this.selected = model.index;
                var drawer = this.$.drawer;
				// if (drawer.getBoundingClientRect().width > parseInt(drawer.responsiveWidth)) {
				// 	drawer.forceNarrow = !drawer.forceNarrow;
				// }
                this.fire('toggle_view');
            },
            propertyChanged: function(newValue, oldValue) {
				console.log([oldValue || 'undefined', ' -> ', newValue].join(''));
			},
			objectChanged: function(newValue, oldValue) {
				console.log(newValue);
			}
        });
    </script>
</dom-module>
