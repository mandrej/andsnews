<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/app-layout/app-layout.html">

<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="photo-index">
	<template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
		<style>
			:host {
				display: block;
			}
            app-drawer {
                --app-drawer-width: 200px;
            }
            app-header {
                background-color: var(--google-blue-700);
                color: white;
                @apply(--paper-header-panel);
            }
            .content {
    		    @apply(--layout-horizontal);
    		    @apply(--layout-wrap);
            }
            .space {
                @apply(--layout-flex);
            }
			.photo {
                position: relative;
                width: 20%;
				height: 300px;
			}
            @media (max-width: 1024px) {.photo{ width: 25%; height: 200px;} }
            @media (max-width: 848px) { .photo{ width: 33.3333%; height: 150px;} }
            @media (max-width: 600px) { .photo{ width: 50%; height: 200px;} }
            @media (max-width: 432px) { .photo{ width: 100%; height: 300px;} }
			iron-image {
				width: 100%;
                height: 100%;
			}
            .photo:hover .detail {
                opacity: 1;
            }
            .photo > iron-image {
                @apply(--layout-flex);
            }
            .photo > .detail {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
                color: white;
                font-size: 20px;
                font-weight: 100;
                padding: 20px;
                opacity: 0;
                transition: opacity 0.1s;
            }
		</style>

        <iron-ajax id="ajax"
            auto
            url="{{url}}"
            handle-as="json"
            on-response="handler"
            loading="{{loadingPhotos}}"
            debounce-duration="500">
        </iron-ajax>

        <app-drawer-layout>
            <app-drawer>
                <app-toolbar>Photos</app-toolbar>
            </app-drawer>

            <app-header-layout>
                <app-header fixed>
                    <app-toolbar>
                        <paper-icon-button icon="menu" drawer-toggle=""></paper-icon-button>
                        <div class="title">ANDS</div>
                        <div class="space"></div>
                        <paper-spinner active$="[[loadingPhotos]]"></paper-spinner>
                        <paper-icon-button icon="icons:filter-list" on-tap="_showFilters"></paper-icon-button>
                    </app-toolbar>
                </app-header>

                <div class="content">
                    <template is="dom-repeat" items="{{photos}}" scroll-target="document">
                        <div class="photo" tabindex$="[[tabIndex]]">
                            <iron-image src="{{item.serving_url}}=s400" preload sizing="cover"></iron-image>
                            <div class="detail">[[item.headline]]</div>
                        </div>
                    </template>
                </div>
            </app-header-layout>
        </app-drawer-layout>

        <iron-scroll-threshold id="scrollTheshold"
        	lower-threshold="500"
        	on-lower-threshold="_loadMorePhotos"
        	scroll-target="document">
      	</iron-scroll-threshold>
	</template>
	<script>
		Polymer({
			is: 'photo-index',
			properties: {
                photos: {
                    type: Array,
                    value: []
                },
                page: {
                    value: null,
                    notify: true
                },
                filter_field: {
                    value: null,
                    notify: true
                },
                filter_value: {
                    value: null,
                    notify: true
                },
                loadingPhotos: Boolean,
				url: {
                    computed: '_url(filter_field, filter_value)'
                }
			},
            _url: function(filter_field, filter_value) {
                if (filter_field && filter_value) {
                    return ['/photos', filter_field, filter_value, ''].join('/');
                }
                return ['/photos', ''].join('/');
            },
            _loadMorePhotos: function() {
                if (this.$.ajax.lastRequest) {
                    this.$.ajax.lastRequest.abort();
                }
                if (this.$.ajax.lastResponse && this.$.ajax.lastResponse.next) {
                    this.$.ajax.params.page = this.$.ajax.lastResponse.next;
                    this.$.ajax.generateRequest();
                }
            },
			handler: function(request) {
                var response = request.detail.response;
                response.objects.forEach(function(item) {
                    this.push('photos', item);
                }, this);
                this.$.scrollTheshold.clearTriggers();
			}
		});
	</script>
</dom-module>
