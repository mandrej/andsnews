<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-swipeable-pages/iron-swipeable-pages.html">

<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">

<dom-module id="photo-index">
	<template>
		<style>
			:host {
				display: block;
			}
            .content {
                @apply(--layout-fullbleed);
    		    @apply(--layout-horizontal);
    		    @apply(--layout-start-aligned);
    		    @apply(--layout-wrap);
                background: var(--primary-background-color);
            }
			.photo {
                position: relative;
                width: 20%;
				height: 200px;
			}
            @media (max-width: 1024px) {.photo{ width: 25%; height: 200px;} }
            @media (max-width: 848px) { .photo{ width: 33.3333333%; height: 200px;} }
            @media (max-width: 600px) { .photo{ width: 50%; height: 300px;} }
            @media (max-width: 432px) { .photo{ width: 100%; height: 350px;} }
			iron-image {
				width: 100%;
                height: 100%;
			}
            .photo {
                cursor: pointer;
            }
            .photo:hover .detail {
                opacity: 1;
            }
            .photo > iron-image {
                @apply(--layout-flex);
            }
            .photo > .detail {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
                color: white;
                font-size: 20px;
                font-weight: 100;
                padding: 20px;
                opacity: 0;
                transition: opacity 0.1s;
            }
            iron-swipeable-pages {
                @apply(--layout-fullbleed);
            }
            .swipe {
                -moz-user-select: none;
                -ms-user-select: none;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;
            }
		</style>

        <paper-drawer-panel>
			<paper-header-panel drawer>
				<paper-menu>
                    <paper-item>Photos</paper-item>
                </paper-menu>
			</paper-header-panel>

			<paper-header-panel main>
                <paper-toolbar>
                    <paper-icon-button icon="icons:menu" paper-drawer-toggle></paper-icon-button>
                    <div class="title">ANDS</div>
                    <paper-spinner active$="[[loadingPhotos]]"></paper-spinner>
                    <paper-icon-button icon="icons:filter-list" on-tap="_showFilters"></paper-icon-button>
                </paper-toolbar>

                <iron-ajax id="photo_ajax"
                    auto
                    url="{{url}}"
                    handle-as="json"
                    on-response="handler"
                    loading="{{loadingPhotos}}"
                    debounce-duration="500">
                </iron-ajax>
                <!--headers='{"cache-control": "no-cache"}'-->

                <iron-scroll-threshold hidden$="{{showFull}}" id="scrollTheshold" lower-threshold="500" on-lower-threshold="_loadMorePhotos">
                    <div class="content">
                        <template is="dom-repeat" items="{{photos}}">
                            <div class="photo" tabindex$="[[tabIndex]]" on-tap="_full">
                                <iron-image src="{{item.serving_url}}=s400" preload sizing="cover"></iron-image>
                                <div class="detail">[[item.headline]]</div>
                            </div>
                        </template>
                    </div>
                </iron-scroll-threshold>

                <iron-swipeable-pages hidden$="{{!showFull}}" selected="0" edgeSwipeSensitivity="35" threshold="0.1" id="swiper">
                    <template is="dom-repeat" items="{{photos}}">
                        <div class="swipe">
                            <iron-image src="{{item.serving_url}}=s0" sizing="cover"></iron-image>
                        </div>
                    </template>
                </iron-swipeable-pages>
            </paper-header-panel>
		</paper-drawer-panel>
	</template>

	<script>
		Polymer({
			is: 'photo-index',
            behaviors: [Polymer.NeonAnimatableBehavior],
			properties: {
                animationConfig: {
                    value: function() {
                        return {
                            'entry': {
                                name: 'fade-in-animation',
                                node: this
                            },
                            'exit': {
                                name: 'fade-out-animation',
                                node: this
                            }
                        }
                    }
                },
                photos: {
                    type: Array,
                    value: []
                },
                page: {
                    value: null,
                    notify: true
                },
                filter_field: {
                    value: null,
                    notify: true
                },
                filter_value: {
                    value: null,
                    notify: true
                },
                loadingPhotos: Boolean,
                showFull: {
                    type: Boolean,
                    value: false
                },
                clearPhotos: {
                    type: Boolean,
                    value: true,
                    notify: true
                },
				url: {
                    computed: '_url(page, filter_field, filter_value)',
                    notify: true
                }
			},
//            observers: ['_url(page, filter_field, filter_value)'],
            _url: function(page, filter_field, filter_value) {
                var url = ['/photos', ''].join('/');
                if (filter_field && filter_value) {
                    url = ['/photos', filter_field, filter_value, ''].join('/');
                }
                if (page != null) url += '?page=' + page;
                console.log(url);
                return url;
            },
            _loadMorePhotos: function() {
                if (this.$.photo_ajax.lastRequest) {
                    this.$.photo_ajax.lastRequest.abort();
                }
                if (this.$.photo_ajax.lastResponse && this.$.photo_ajax.lastResponse.next) {
                    this.page = this.$.photo_ajax.lastResponse.next;
                    this.clearPhotos = false;
                    this.fire('url-changed', true);
//                    this.$.photo_ajax.generateRequest();
                }
            },
			handler: function(request) {
                var response = request.detail.response;
                if (this.clearPhotos) this.photos = [];
                response.objects.forEach(function(item) {
                    this.push('photos', item);
                }, this);
                this.$.scrollTheshold.clearTriggers();
			},
            _showFilters: function() {
                this.fire('show-filters');
            },
            _full: function(e) {
                this.$.swiper.selected = e.model.index;
                this.showFull = true;
            }
		});
	</script>
</dom-module>
