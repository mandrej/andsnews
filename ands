#!/usr/bin/env bash
proj_id=andsnews
venv_dir=/home/milan/venv/andsnews
version=`date +%Y%m%d%H%M`

function syntax {
  echo $"Usage:"
  echo $"$0 run    - Run development server"
  echo $"$0 build  - Build client"
  echo $"$0 deploy - Deploy"
  echo $"$0 size   - Bucket size"
  exit 1
}

if [ $# -eq 0 ]
  then
    syntax
else
  case $1 in
    run)
      source $venv_dir/bin/activate
      # gunicorn -b :6060 -w 2 main:app --reload \
      # --access-logfile='-' --access-logformat='%(r)s %(s)s %(b)s %(f)s'
      python main.py
      # vue ui
      exit ;;
    build)
      sed -i -E "/VUE_APP_VERSION/s/[[:digit:]]{12}/$version/g" vue2/.env
      yarn --cwd vue2/ build
      exit ;;
    deploy)
      gcloud app deploy --project=$proj_id --version=$version app.yaml index.yaml cron.yaml dos.yaml
      # gcloud datastore indexes cleanup index.yaml
      exit ;;
    size)
      bucket=`gsutil du -s -e "*.json" gs://andsnews.appspot.com | tee | grep -Eo '[[:digit:]]+'`
      echo $bucket | awk '{ size =$1 /1024/1024**2 ; print "BUCKET SIZE " size " GB" }'
      # sed -i -E "/VUE_APP_BUCKET/s/[[:digit:]]+/$bucket/g" vue2/.env
      exit ;;
    *)
      syntax
  esac
fi
